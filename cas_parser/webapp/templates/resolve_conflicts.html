<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Famfolio - Resolve Conflicts</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .header {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        .conflict-card {
            border-left: 4px solid #ffc107;
            transition: all 0.2s;
        }
        .tx-option {
            cursor: pointer;
            padding: 1rem;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            transition: all 0.2s;
        }
        .tx-option:hover {
            background-color: #f8f9fa;
        }
        .tx-option.selected {
            border-color: #28a745;
            background-color: #d4edda;
        }
        .tx-option .form-check-input:checked {
            background-color: #28a745;
            border-color: #28a745;
        }
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
        }
        .empty-state i {
            font-size: 4rem;
            color: #28a745;
        }
        .amount-positive { color: #28a745; }
        .amount-negative { color: #dc3545; }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="container">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <a href="/" class="text-white text-decoration-none">
                        <i class="bi bi-arrow-left"></i> Back to Dashboard
                    </a>
                    <h1 class="mt-3"><i class="bi bi-exclamation-triangle"></i> Resolve Transaction Conflicts</h1>
                    <p class="mb-0">Review and select which transactions to keep when duplicates are detected</p>
                </div>
                {% include '_auth_nav.html' %}
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Validation Summary Alert -->
        <div id="validationAlert" class="alert alert-info mb-4" style="display: none;">
            <div class="d-flex align-items-start">
                <i class="bi bi-lightbulb text-warning me-3" style="font-size: 1.5rem;"></i>
                <div>
                    <h6 class="mb-1"><i class="bi bi-calculator"></i> Unit Validation Analysis</h6>
                    <p id="validationMessage" class="mb-0 small"></p>
                </div>
            </div>
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="empty-state" style="display: none;">
            <i class="bi bi-check-circle-fill"></i>
            <h3 class="mt-3">No Conflicts!</h3>
            <p class="text-muted">All transaction conflicts have been resolved.</p>
            <a href="/" class="btn btn-primary mt-3">
                <i class="bi bi-speedometer2"></i> Go to Dashboard
            </a>
        </div>

        <!-- Conflicts List -->
        <div id="conflictsList">
            <!-- Conflict groups will be loaded here -->
        </div>
    </div>

    <!-- Conflict Detail Modal -->
    <div class="modal fade" id="conflictModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle text-warning"></i>
                        Resolve Conflict
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Validation Recommendation -->
                    <div id="validationRecommendation" class="alert alert-success mb-3" style="display: none;">
                        <div class="d-flex">
                            <i class="bi bi-lightbulb-fill text-warning me-2" style="font-size: 1.2rem;"></i>
                            <div>
                                <strong>Recommendation:</strong>
                                <p id="recommendationText" class="mb-1 small"></p>
                                <button class="btn btn-sm btn-success" onclick="selectAllTransactions()">
                                    <i class="bi bi-check-all"></i> Select All (Recommended)
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <strong>Multiple transactions found for the same date.</strong>
                        Select which transaction(s) should be kept. Unselected transactions will be discarded.
                    </div>

                    <div id="conflictInfo" class="mb-3">
                        <strong>Fund:</strong> <span id="conflictFund">-</span><br>
                        <strong>Date:</strong> <span id="conflictDate">-</span><br>
                        <strong>Folio:</strong> <span id="conflictFolio">-</span>
                    </div>

                    <h6>Select transactions to keep:</h6>
                    <div id="txOptions">
                        <!-- Transaction options will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="resolveBtn" onclick="resolveConflict()">
                        <i class="bi bi-check-lg"></i> Confirm Selection
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let conflictGroups = [];
        let currentConflict = null;
        let currentTransactions = [];
        let currentValidation = null;
        let conflictModal;
        let validationIssues = [];

        async function loadConflicts() {
            try {
                const res = await fetch('/api/conflicts');
                conflictGroups = await res.json();

                // Also load validation issues
                const validRes = await fetch('/api/validation/issues');
                validationIssues = await validRes.json();

                if (conflictGroups.length === 0) {
                    document.getElementById('conflictsList').style.display = 'none';
                    document.getElementById('validationAlert').style.display = 'none';
                    document.getElementById('emptyState').style.display = 'block';
                    return;
                }

                document.getElementById('conflictsList').style.display = 'block';
                document.getElementById('emptyState').style.display = 'none';

                // Show validation summary if there are issues that can be resolved
                displayValidationSummary();
                displayConflicts();

            } catch (error) {
                console.error('Failed to load conflicts:', error);
            }
        }

        function displayValidationSummary() {
            const relevantIssues = validationIssues.filter(v =>
                v.issue_type === 'pending_conflicts' || v.issue_type === 'partial_conflict'
            );

            if (relevantIssues.length > 0) {
                const alert = document.getElementById('validationAlert');
                const message = document.getElementById('validationMessage');

                const totalUnits = relevantIssues.reduce((sum, v) => sum + Math.abs(v.difference), 0);
                message.innerHTML = `
                    <strong>${relevantIssues.length} folio(s)</strong> have unit mismatches that can be resolved by accepting pending transactions.<br>
                    Total missing units: <strong>${totalUnits.toFixed(3)}</strong><br>
                    <em>Look for the <span class="badge bg-success">Recommended</span> badge on each conflict.</em>
                `;
                alert.style.display = 'block';
            } else {
                document.getElementById('validationAlert').style.display = 'none';
            }
        }

        function displayConflicts() {
            const container = document.getElementById('conflictsList');

            container.innerHTML = conflictGroups.map(group => {
                // Check if this folio has a validation issue that can be resolved
                const validationIssue = validationIssues.find(v =>
                    v.folio_number === group.folio_number &&
                    (v.issue_type === 'pending_conflicts' || v.issue_type === 'partial_conflict')
                );
                const hasRecommendation = !!validationIssue;

                return `
                <div class="card conflict-card shadow-sm mb-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">
                                    ${group.scheme_name || 'Unknown Fund'}
                                    ${hasRecommendation ? '<span class="badge bg-success ms-2">Accept All Recommended</span>' : ''}
                                </h6>
                                <small class="text-muted">
                                    <i class="bi bi-calendar"></i> ${group.tx_date} |
                                    <i class="bi bi-folder"></i> Folio: ${group.folio_number} |
                                    <i class="bi bi-building"></i> ${group.amc || '-'}
                                </small>
                                ${hasRecommendation ? `
                                <div class="mt-2 small text-success">
                                    <i class="bi bi-lightbulb"></i> Accepting all ${group.tx_count} transactions will add ${validationIssue.pending_conflict_units?.toFixed(3) || '?'} units to match expected ${validationIssue.expected_units?.toFixed(3) || '?'} units
                                </div>
                                ` : ''}
                            </div>
                            <div class="text-end">
                                <span class="badge bg-warning text-dark mb-2">
                                    ${group.tx_count} conflicting transactions
                                </span>
                                <br>
                                <button class="btn btn-sm btn-primary" onclick="openConflictModal('${group.conflict_group_id}')">
                                    <i class="bi bi-check2-square"></i> Resolve
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        async function openConflictModal(conflictGroupId) {
            currentConflict = conflictGroups.find(g => g.conflict_group_id === conflictGroupId);
            if (!currentConflict) return;

            // Load transactions for this conflict
            try {
                const res = await fetch(`/api/conflicts/${conflictGroupId}`);
                currentTransactions = await res.json();

                document.getElementById('conflictFund').textContent = currentConflict.scheme_name || '-';
                document.getElementById('conflictDate').textContent = currentConflict.tx_date;
                document.getElementById('conflictFolio').textContent = currentConflict.folio_number;

                // Check for validation recommendation
                currentValidation = validationIssues.find(v =>
                    v.folio_number === currentConflict.folio_number
                );

                const recDiv = document.getElementById('validationRecommendation');
                const recText = document.getElementById('recommendationText');

                if (currentValidation && (currentValidation.issue_type === 'pending_conflicts' || currentValidation.issue_type === 'partial_conflict')) {
                    recText.innerHTML = currentValidation.recommendation || 'Accept all transactions to resolve unit mismatch.';
                    recDiv.style.display = 'block';
                } else {
                    recDiv.style.display = 'none';
                }

                displayTransactionOptions();

                conflictModal = new bootstrap.Modal(document.getElementById('conflictModal'));
                conflictModal.show();

            } catch (error) {
                console.error('Failed to load conflict details:', error);
                alert('Failed to load conflict details');
            }
        }

        function selectAllTransactions() {
            const checkboxes = document.querySelectorAll('#txOptions .form-check-input');
            checkboxes.forEach((cb, idx) => {
                cb.checked = true;
                document.getElementById(`txOption${idx}`).classList.add('selected');
            });
            updateResolveButton();
        }

        function displayTransactionOptions() {
            const container = document.getElementById('txOptions');

            container.innerHTML = currentTransactions.map((tx, idx) => {
                const amountClass = tx.amount >= 0 ? 'amount-positive' : 'amount-negative';
                const unitsClass = tx.units >= 0 ? 'amount-positive' : 'amount-negative';

                return `
                <div class="tx-option" onclick="toggleTxSelection(${idx})" id="txOption${idx}">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="txCheck${idx}"
                               onchange="updateResolveButton()">
                        <label class="form-check-label w-100" for="txCheck${idx}">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <strong>${tx.tx_type.toUpperCase()}</strong>
                                    <span class="text-muted ms-2">${tx.description || '-'}</span>
                                </div>
                                <div class="text-end">
                                    <span class="${amountClass}">${formatCurrency(tx.amount || 0)}</span>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between small text-muted mt-1">
                                <span>Units: <span class="${unitsClass}">${(tx.units || 0).toFixed(4)}</span></span>
                                <span>NAV: ${(tx.nav || 0).toFixed(4)}</span>
                                <span>Balance: ${(tx.balance_units || 0).toFixed(4)}</span>
                            </div>
                        </label>
                    </div>
                </div>
            `}).join('');

            updateResolveButton();
        }

        function toggleTxSelection(idx) {
            const checkbox = document.getElementById(`txCheck${idx}`);
            checkbox.checked = !checkbox.checked;

            const option = document.getElementById(`txOption${idx}`);
            if (checkbox.checked) {
                option.classList.add('selected');
            } else {
                option.classList.remove('selected');
            }

            updateResolveButton();
        }

        function updateResolveButton() {
            const checkboxes = document.querySelectorAll('#txOptions .form-check-input');
            const anySelected = Array.from(checkboxes).some(cb => cb.checked);
            document.getElementById('resolveBtn').disabled = !anySelected;
        }

        async function resolveConflict() {
            const checkboxes = document.querySelectorAll('#txOptions .form-check-input');
            const selectedHashes = [];

            checkboxes.forEach((cb, idx) => {
                if (cb.checked) {
                    selectedHashes.push(currentTransactions[idx].tx_hash);
                }
            });

            if (selectedHashes.length === 0) {
                alert('Please select at least one transaction to keep');
                return;
            }

            try {
                const res = await fetch(`/api/conflicts/${currentConflict.conflict_group_id}/resolve`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ selected_hashes: selectedHashes })
                });

                const result = await res.json();

                if (result.activated !== undefined) {
                    conflictModal.hide();
                    alert(`Resolved! Kept ${result.activated} transaction(s), discarded ${result.discarded}.`);
                    loadConflicts();
                } else {
                    alert('Error: ' + (result.error || 'Unknown error'));
                }

            } catch (error) {
                alert('Failed to resolve conflict: ' + error.message);
            }
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR',
                maximumFractionDigits: 2
            }).format(value);
        }

        // Load conflicts on page load
        loadConflicts();
    </script>
    {% include '_feature_request_widget.html' %}
<script>
// Auth: redirect to login on 401
const _origFetch = window.fetch;
window.fetch = function() {
    return _origFetch.apply(this, arguments).then(resp => {
        if (resp.status === 401) window.location.href = '/login';
        return resp;
    });
};
</script>
</body>
</html>
