<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Famfolio - Investor Portfolio</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        .summary-card {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            border-radius: 10px;
            padding: 1.5rem;
        }
        .summary-card h2 { font-size: 2rem; font-weight: bold; }

        /* Main Asset Tabs */
        .asset-tabs {
            background: white;
            border-radius: 10px;
            padding: 0.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .asset-tabs .nav-link {
            color: #6c757d;
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .asset-tabs .nav-link.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .asset-tabs .nav-link:not(.active):hover {
            background: #f8f9fa;
        }
        .asset-tabs .badge {
            font-size: 0.7rem;
        }

        /* Sub Tabs */
        .sub-tabs .nav-link {
            color: #667eea;
            border: none;
            border-bottom: 2px solid transparent;
            border-radius: 0;
            padding: 0.5rem 1rem;
        }
        .sub-tabs .nav-link.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: transparent;
        }

        /* Cards */
        .holding-card {
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
            border-left: 4px solid #667eea;
        }
        .holding-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .nps-card {
            border-left: 4px solid #11998e;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .nps-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .holding-value { font-size: 1.25rem; font-weight: bold; color: #28a745; }
        .positive { color: #28a745; font-weight: 500; }
        .negative { color: #dc3545; font-weight: 500; }
        .nav-live { font-size: 0.85rem; color: #667eea; }
        .table-responsive { max-height: 500px; overflow-y: auto; }
        .badge-purchase { background-color: #28a745; }
        .badge-sip { background-color: #17a2b8; }
        .badge-redemption { background-color: #dc3545; }
        .badge-mf { background-color: #667eea; }
        .badge-nps { background-color: #11998e; }
        .badge-fd { background-color: #fd7e14; }
        .badge-sgb { background-color: #ffc107; color: #000; }
        .badge-ppf { background-color: #198754; }
        .ppf-card {
            border-left: 4px solid #198754;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .ppf-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .ppf-badge-investment { background-color: #198754; }
        .ppf-badge-interest { background-color: #0d6efd; }
        .ppf-badge-withdrawal { background-color: #dc3545; }
        .badge-gold { background-color: #d4a017; color: #000; }
        .gold-card {
            border-left: 4px solid #d4a017;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .gold-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .gold-badge-buy { background-color: #198754; }
        .gold-badge-sell { background-color: #dc3545; }

        .refresh-btn { transition: transform 0.3s; }
        .refresh-btn.spinning { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        body.mask-amounts .mask-amount {
            filter: blur(8px);
            user-select: none;
        }

        .asset-bar {
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            display: flex;
        }
        .asset-bar .mf-segment { background: #667eea; }
        .asset-bar .nps-segment { background: #11998e; }
        .asset-bar .fd-segment { background: #fd7e14; }
        .asset-bar .sgb-segment { background: #ffc107; }
        .asset-bar .ppf-segment { background: #198754; }
        .asset-bar .gold-segment { background: #d4a017; }
        .asset-bar .other-segment { background: #6c757d; }

        .empty-asset {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }
        .empty-asset i { font-size: 3rem; opacity: 0.5; }

        /* Home Tab Widgets */
        .home-stat-card {
            border-radius: 10px;
            padding: 1rem 1.25rem;
            text-align: center;
            color: white;
            height: 100%;
        }
        .home-stat-card .stat-value { font-size: 1.5rem; font-weight: bold; }
        .home-stat-card .stat-label { font-size: 0.8rem; opacity: 0.9; }

        .alert-item {
            border-left: 4px solid #6c757d;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            background: #fff;
            border-radius: 0 6px 6px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .alert-item.alert-warning-border { border-left-color: #ffc107; }
        .alert-item.alert-danger-border { border-left-color: #dc3545; }
        .alert-item.alert-info-border { border-left-color: #0dcaf0; }
        .alert-item .alert-content { flex: 1; }
        .alert-item .alert-title { font-weight: 600; font-size: 0.9rem; }
        .alert-item .alert-desc { font-size: 0.8rem; color: #6c757d; }
        .alert-item .alert-actions { display: flex; gap: 0.5rem; align-items: center; }

        /* Category collapse chevron */
        [data-bs-toggle="collapse"] .cat-chevron {
            transition: transform 0.25s;
        }
        [data-bs-toggle="collapse"].collapsed .cat-chevron {
            transform: rotate(-90deg);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="container">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <a href="/" class="text-white text-decoration-none">
                        <i class="bi bi-arrow-left"></i> Back to Dashboard
                    </a>
                    <h1 class="mt-3">
                        <span id="investorName">Loading...</span>
                        <button class="btn btn-sm btn-outline-light ms-2" onclick="openEditInvestorModal()" title="Edit Name">
                            <i class="bi bi-pencil"></i>
                        </button>
                    </h1>
                    <p class="mb-0" id="investorDetails"></p>
                </div>
                {% include '_auth_nav.html' %}
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Top Action Bar -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="card shadow-sm">
                    <div class="card-body py-2 d-flex justify-content-between align-items-center">
                        <div>
                            <small class="text-muted">
                                <i class="bi bi-clock"></i> NAV Last Updated: <span id="navLastUpdate">-</span>
                            </small>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-secondary me-2" id="maskToggle" onclick="toggleMask()">
                                <i class="bi bi-eye" id="maskIcon"></i>
                            </button>
                            <a href="/investor/{{ investor.id }}/goals" class="btn btn-sm btn-outline-success me-2">
                                <i class="bi bi-flag"></i> Goals
                            </a>
                            <a href="/investor/{{ investor.id }}/tax-harvesting" class="btn btn-sm btn-outline-warning me-2">
                                <i class="bi bi-scissors"></i> Tax Harvesting
                            </a>
                            <a href="/manual-assets?investor_id={{ investor.id }}" class="btn btn-sm btn-outline-info me-2">
                                <i class="bi bi-wallet2"></i> Add Assets
                            </a>
                            <button class="btn btn-sm btn-outline-primary" id="refreshNavBtn" onclick="refreshNAV()">
                                <i class="bi bi-arrow-clockwise refresh-btn" id="refreshIcon"></i> Refresh NAV
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab-level summary rendered inside each tab -->

        <!-- Main Asset Type Tabs -->
        <div class="asset-tabs">
            <ul class="nav nav-pills" id="assetTypeTabs" role="tablist">
                <!-- Tabs will be dynamically inserted here -->
            </ul>
        </div>

        <!-- Tab Content -->
        <div class="tab-content" id="assetTypeContent">
            <!-- Content will be dynamically inserted here -->
        </div>
    </div>

    <!-- Edit Investor Modal -->
    <div class="modal fade" id="editInvestorModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-pencil"></i> Edit Investor</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Display Name</label>
                        <input type="text" class="form-control" id="editInvestorName">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" id="editInvestorEmail">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Mobile</label>
                        <input type="text" class="form-control" id="editInvestorMobile">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveInvestor()">
                        <i class="bi bi-check-lg"></i> Save
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Benchmark Search Modal -->
    <div class="modal fade" id="benchmarkSearchModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-search"></i> Add Benchmark</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <input type="text" class="form-control" id="benchmarkSearchInput"
                               placeholder="Search index funds (e.g. Nifty 50 Index)" oninput="debouncedBenchmarkSearch()">
                    </div>
                    <div id="benchmarkSearchSpinner" style="display:none;" class="text-center py-3">
                        <div class="spinner-border spinner-border-sm text-primary"></div> Searching...
                    </div>
                    <div id="benchmarkSearchResults" style="max-height:300px; overflow-y:auto;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Asset Breakdown Modal -->
    <div class="modal fade" id="assetBreakdownModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header text-white" id="breakdownModalHeader">
                    <h5 class="modal-title" id="breakdownModalTitle"></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0" id="breakdownModalBody">
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const investorId = {{ investor.id }};

        // Data stores
        let investorData = null;
        let mfHoldings = [];
        let mfTransactions = [];
        let npsAccounts = [];
        let manualAssets = [];
        let portfolioChart = null;
        let allocationChart = null;
        let isinXirrMap = {};  // isin -> aggregated XIRR %
        let ppfSelectedAssetId = null;
        let goldSelectedAssetId = null;
        let homeAllocSegments = []; // stored for pie chart click handler

        const ASSET_TYPE_CONFIG = {
            mf:    { label: 'Mutual Funds',    color: '#667eea', icon: 'bi-bank' },
            nps:   { label: 'NPS',             color: '#11998e', icon: 'bi-shield-check' },
            fd:    { label: 'Fixed Deposits',  color: '#fd7e14', icon: 'bi-safe' },
            sgb:   { label: 'Gold Bonds',      color: '#ffc107', icon: 'bi-gem' },
            ppf:   { label: 'PPF',             color: '#198754', icon: 'bi-piggy-bank' },
            epf:   { label: 'EPF',             color: '#20c997', icon: 'bi-piggy-bank' },
            stock: { label: 'Stocks',          color: '#e74c3c', icon: 'bi-graph-up-arrow' },
            gold:  { label: 'Gold',            color: '#d4a017', icon: 'bi-gem' },
            silver:{ label: 'Silver',          color: '#c0c0c0', icon: 'bi-gem' },
        };
        const FALLBACK_COLORS = ['#6f42c1','#17a2b8','#e83e8c','#795548','#20c997','#6610f2'];

        // Mask functionality
        function isMaskEnabled() { return localStorage.getItem('maskAmounts') === 'true'; }
        function toggleMask() {
            localStorage.setItem('maskAmounts', !isMaskEnabled());
            applyMask();
        }
        function applyMask() {
            const masked = isMaskEnabled();
            const icon = document.getElementById('maskIcon');
            if (masked) {
                document.body.classList.add('mask-amounts');
                if (icon) icon.className = 'bi bi-eye-slash';
            } else {
                document.body.classList.remove('mask-amounts');
                if (icon) icon.className = 'bi bi-eye';
            }
        }
        applyMask();

        // Main load function
        async function loadData() {
            try {
                // Load investor details
                const invRes = await fetch(`/api/investors/${investorId}`);
                investorData = await invRes.json();

                document.getElementById('investorName').textContent = investorData.name || 'Unknown';
                const lastUpload = investorData.last_cas_upload
                    ? new Date(investorData.last_cas_upload).toLocaleDateString('en-IN', {day: '2-digit', month: 'short', year: 'numeric'})
                    : 'Never';
                document.getElementById('investorDetails').innerHTML =
                    `PAN: ${investorData.pan || '-'} | Email: ${investorData.email || '-'} | Last CAS: ${lastUpload}`;

                // Load MF holdings
                const holdingsRes = await fetch(`/api/investors/${investorId}/holdings-live`);
                mfHoldings = await holdingsRes.json();

                // Load MF transactions
                const txRes = await fetch(`/api/investors/${investorId}/transactions`);
                mfTransactions = await txRes.json();

                // Load NPS accounts
                const npsRes = await fetch(`/api/nps/subscribers?investor_id=${investorId}`);
                npsAccounts = await npsRes.json();

                // Load NPS summaries
                for (const nps of npsAccounts) {
                    try {
                        const summaryRes = await fetch(`/api/nps/subscribers/${nps.id}/summary`);
                        nps.summary = await summaryRes.json();
                    } catch (e) { console.error('Failed to load NPS summary:', e); }
                }

                // Load manual assets (FD, SGB, etc.)
                try {
                    const assetsRes = await fetch(`/api/manual-assets?investor_id=${investorId}`);
                    manualAssets = await assetsRes.json();
                } catch (e) { manualAssets = []; }

                // Calculate totals and render
                calculateAndDisplayTotals();
                buildAssetTabs();
                activateHashTab();
                loadNavStatus();

                // Load XIRR data (non-blocking)
                loadXirrData();

            } catch (error) {
                console.error('Failed to load data:', error);
            }
        }

        async function loadXirrData() {
            try {
                const res = await fetch(`/api/investors/${investorId}/xirr`);
                const data = await res.json();

                // Portfolio-level XIRR in MF tab banner
                const mfXirrEl = document.getElementById('mfXirrBanner');
                const homeXirrEl = document.getElementById('homeXirr');
                if (data.portfolio_xirr !== null && data.portfolio_xirr !== undefined) {
                    const val = data.portfolio_xirr;
                    if (mfXirrEl) mfXirrEl.textContent = `XIRR: ${val >= 0 ? '+' : ''}${val.toFixed(2)}%`;
                    if (homeXirrEl) homeXirrEl.textContent = `${val >= 0 ? '+' : ''}${val.toFixed(2)}%`;
                } else {
                    if (mfXirrEl) mfXirrEl.textContent = '';
                    if (homeXirrEl) homeXirrEl.textContent = 'N/A';
                }

                // Store per-ISIN aggregated XIRR
                isinXirrMap = data.isin_xirr || {};

                // Per-folio XIRR badges
                if (data.folios) {
                    data.folios.forEach(f => {
                        const badges = document.querySelectorAll(`.folio-xirr-badge[data-folio-id="${f.folio_id}"]`);
                        badges.forEach(badge => {
                            if (f.xirr !== null && f.xirr !== undefined) {
                                const cls = f.xirr >= 0 ? 'bg-success' : 'bg-danger';
                                badge.innerHTML = `<span class="badge ${cls}" style="font-size:0.65rem;">XIRR: ${f.xirr >= 0 ? '+' : ''}${f.xirr.toFixed(1)}%</span>`;
                            }
                        });
                    });
                }

                // Per-ISIN group XIRR badges
                Object.entries(isinXirrMap).forEach(([isin, val]) => {
                    const badges = document.querySelectorAll(`.isin-xirr-badge[data-isin="${isin}"]`);
                    badges.forEach(badge => {
                        if (val !== null && val !== undefined) {
                            const cls = val >= 0 ? 'bg-success' : 'bg-danger';
                            badge.innerHTML = `<span class="badge ${cls}" style="font-size:0.7rem;">XIRR: ${val >= 0 ? '+' : ''}${val.toFixed(1)}%</span>`;
                        }
                    });
                });
            } catch (e) {
                console.error('Failed to load XIRR data:', e);
            }
        }

        // Computed totals (populated by calculateAndDisplayTotals, used by tab renderers)
        let computedTotals = {};

        function calculateAndDisplayTotals() {
            // MF totals
            const mfValue = mfHoldings.reduce((sum, h) => {
                const val = (h.current_nav && h.current_nav > 0) ? h.current_value_live : h.current_value;
                return sum + (val || 0);
            }, 0);
            const mfInvested = mfHoldings.reduce((sum, h) => sum + (h.invested_amount || 0), 0);

            // NPS totals
            let npsValue = 0, npsContribution = 0;
            npsAccounts.forEach(nps => {
                npsValue += nps.total_value || 0;
                if (nps.summary) npsContribution += nps.summary.total_contribution || 0;
            });

            // Manual assets totals by type
            let fdValue = 0, sgbValue = 0, ppfValue = 0, goldValue = 0, otherValue = 0;
            let fdInvested = 0, sgbInvested = 0, ppfInvested = 0, goldInvested = 0, otherInvested = 0;
            manualAssets.forEach(asset => {
                // Use calculated_value for enriched assets (FD/SGB), fallback to current_value
                const val = asset.calculated_value || asset.current_value || 0;
                const inv = asset.fd_principal || asset.purchase_value || 0;
                if (asset.asset_type === 'fd') { fdValue += val; fdInvested += inv; }
                else if (asset.asset_type === 'sgb') { sgbValue += val; sgbInvested += inv; }
                else if (['ppf', 'epf'].includes(asset.asset_type)) { ppfValue += val; ppfInvested += inv; }
                else if (asset.asset_type === 'gold') { goldValue += val; goldInvested += inv; }
                else { otherValue += val; otherInvested += inv; }
            });

            // Store for use by tab banners
            computedTotals = {
                mfValue, mfInvested,
                npsValue, npsContribution,
                fdValue, fdInvested,
                sgbValue, sgbInvested,
                ppfValue, ppfInvested,
                goldValue, goldInvested,
                otherValue, otherInvested,
                totalValue: mfValue + npsValue + fdValue + sgbValue + ppfValue + goldValue + otherValue,
                totalInvested: mfInvested + npsContribution + fdInvested + sgbInvested + ppfInvested + goldInvested + otherInvested,
            };
            computedTotals.totalGain = computedTotals.totalValue - computedTotals.totalInvested;
            computedTotals.gainPct = computedTotals.totalInvested > 0
                ? ((computedTotals.totalGain / computedTotals.totalInvested) * 100).toFixed(1) : 0;
        }

        function buildAssetTabs() {
            const tabsContainer = document.getElementById('assetTypeTabs');
            const contentContainer = document.getElementById('assetTypeContent');

            let tabsHtml = '';
            let contentHtml = '';

            // Home tab is always first and active
            tabsHtml += `
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#home-tab" type="button">
                        <i class="bi bi-house-door"></i> Home
                    </button>
                </li>`;
            contentHtml += buildHomeTabContent();

            // Mutual Funds tab (always show if has holdings)
            if (mfHoldings.length > 0) {
                tabsHtml += `
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#mf-tab" type="button">
                            <i class="bi bi-bank"></i> Mutual Funds
                            <span class="badge badge-mf">${mfHoldings.length}</span>
                        </button>
                    </li>`;
                contentHtml += buildMFTabContent(false);
            }

            // NPS tab
            if (npsAccounts.length > 0) {
                tabsHtml += `
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#nps-tab" type="button">
                            <i class="bi bi-shield-check"></i> NPS
                            <span class="badge badge-nps">${npsAccounts.length}</span>
                        </button>
                    </li>`;
                contentHtml += buildNPSTabContent(false);
            }

            // FD tab
            const fdAssets = manualAssets.filter(a => a.asset_type === 'fd');
            if (fdAssets.length > 0) {
                tabsHtml += `
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#fd-tab" type="button">
                            <i class="bi bi-safe"></i> Fixed Deposits
                            <span class="badge badge-fd">${fdAssets.length}</span>
                        </button>
                    </li>`;
                contentHtml += buildFDTabContent(fdAssets, false);
            }

            // SGB tab
            const sgbAssets = manualAssets.filter(a => a.asset_type === 'sgb');
            if (sgbAssets.length > 0) {
                tabsHtml += `
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#sgb-tab" type="button">
                            <i class="bi bi-gem"></i> Sovereign Gold Bonds
                            <span class="badge badge-sgb">${sgbAssets.length}</span>
                        </button>
                    </li>`;
                contentHtml += buildSGBTabContent(sgbAssets, false);
            }

            // PPF/EPF tab
            const ppfAssets = manualAssets.filter(a => ['ppf', 'epf'].includes(a.asset_type));
            if (ppfAssets.length > 0) {
                tabsHtml += `
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#ppf-tab" type="button">
                            <i class="bi bi-piggy-bank"></i> PPF/EPF
                            <span class="badge badge-ppf">${ppfAssets.length}</span>
                        </button>
                    </li>`;
                contentHtml += buildPPFTabContent(ppfAssets, false);
            }

            // Gold tab
            const goldAssets = manualAssets.filter(a => a.asset_type === 'gold');
            if (goldAssets.length > 0) {
                tabsHtml += `
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#gold-tab" type="button">
                            <i class="bi bi-gem"></i> Gold
                            <span class="badge badge-gold">${goldAssets.length}</span>
                        </button>
                    </li>`;
                contentHtml += buildGoldTabContent(goldAssets, false);
            }

            // Other assets tab
            const otherAssets = manualAssets.filter(a => !['fd', 'sgb', 'ppf', 'epf', 'gold'].includes(a.asset_type));
            if (otherAssets.length > 0) {
                tabsHtml += `
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#other-tab" type="button">
                            <i class="bi bi-wallet2"></i> Other Assets
                            <span class="badge bg-secondary">${otherAssets.length}</span>
                        </button>
                    </li>`;
                contentHtml += buildOtherAssetsTabContent(otherAssets, false);
            }

            tabsContainer.innerHTML = tabsHtml;
            contentContainer.innerHTML = contentHtml;

            // Initialize sub-tabs event listeners and home data
            initializeSubTabs();
            loadHomeData();
        }

        // ==================== Home Tab ====================

        let homeGrowthChart = null;
        let homeAllocationChart = null;

        function buildHomeTabContent() {
            return `
            <div class="tab-pane fade show active" id="home-tab" role="tabpanel">
                <!-- Widget 1: Account Summary Cards -->
                <div class="row mb-3" id="homeStatCards">
                    <div class="col">
                        <div class="home-stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            <div class="stat-value" id="homeFolioCount">-</div>
                            <div class="stat-label">Investment Accounts</div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="home-stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                            <div class="stat-value mask-amount" id="homeTotalInvested">-</div>
                            <div class="stat-label">Total Invested</div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="home-stat-card" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                            <div class="stat-value mask-amount" id="homeTotalValue">-</div>
                            <div class="stat-label">Current Value</div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="home-stat-card" id="homeGainCard" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                            <div class="stat-value mask-amount" id="homeGainValue">-</div>
                            <div class="stat-label" id="homeGainLabel">Overall Gain</div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="home-stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                            <div class="stat-value" id="homeXirr">-</div>
                            <div class="stat-label">Portfolio XIRR</div>
                        </div>
                    </div>
                </div>

                <!-- Widget 2 + 3: Charts Row -->
                <div class="row mb-3">
                    <div class="col-md-7">
                        <div class="card shadow-sm h-100">
                            <div class="card-header bg-white py-2">
                                <h6 class="mb-0"><i class="bi bi-graph-up"></i> Portfolio Growth</h6>
                            </div>
                            <div class="card-body">
                                <div id="homeGrowthContainer" style="height: 280px; position: relative;">
                                    <div class="text-center py-5" id="homeGrowthEmpty">
                                        <i class="bi bi-hourglass" style="font-size:2.5rem;color:#ccc;"></i>
                                        <p class="text-muted mt-2">No history data yet. Refresh NAV to take snapshots.</p>
                                    </div>
                                    <canvas id="homeGrowthChart" style="display:none;"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-5">
                        <div class="card shadow-sm h-100">
                            <div class="card-header bg-white py-2">
                                <h6 class="mb-0"><i class="bi bi-pie-chart"></i> Asset Allocation</h6>
                            </div>
                            <div class="card-body">
                                <div id="homeAllocContainer" style="height: 280px; position: relative;">
                                    <div class="text-center py-5" id="homeAllocEmpty" style="display:none;">
                                        <i class="bi bi-pie-chart" style="font-size:2.5rem;color:#ccc;"></i>
                                        <p class="text-muted mt-2">No asset data available</p>
                                    </div>
                                    <canvas id="homeAllocChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Widget 4: Alerts Panel -->
                <div class="card shadow-sm mb-3">
                    <div class="card-header bg-white py-2 d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="bi bi-bell"></i> Alerts</h6>
                        <small class="text-muted" id="homeAlertCount"></small>
                    </div>
                    <div class="card-body py-2" id="homeAlertsBody">
                        <div class="text-center py-3 text-muted">
                            <i class="bi bi-arrow-repeat spinning" style="font-size:1.2rem;"></i> Loading alerts...
                        </div>
                    </div>
                </div>
            </div>`;
        }

        function loadHomeData() {
            // Widget 1: Account summary stats
            const folioCount = mfHoldings.length;
            const npsCount = npsAccounts.length;
            const manualCount = manualAssets.length;
            const totalAccounts = folioCount + npsCount + manualCount;

            // Calculate totals (same logic as calculateAndDisplayTotals)
            const mfValue = mfHoldings.reduce((sum, h) => {
                const val = (h.current_nav && h.current_nav > 0) ? h.current_value_live : h.current_value;
                return sum + (val || 0);
            }, 0);
            const mfInvested = mfHoldings.reduce((sum, h) => sum + (h.invested_amount || 0), 0);

            let npsValue = 0, npsContribution = 0;
            npsAccounts.forEach(nps => {
                npsValue += nps.total_value || 0;
                if (nps.summary) npsContribution += nps.summary.total_contribution || 0;
            });

            let maValue = 0, maInvested = 0;
            manualAssets.forEach(asset => {
                maValue += asset.calculated_value || asset.current_value || 0;
                maInvested += asset.fd_principal || asset.purchase_value || 0;
            });

            const totalValue = mfValue + npsValue + maValue;
            const totalInvested = mfInvested + npsContribution + maInvested;
            const totalGain = totalValue - totalInvested;
            const gainPct = totalInvested > 0 ? ((totalGain / totalInvested) * 100).toFixed(1) : '0.0';

            document.getElementById('homeFolioCount').textContent = totalAccounts;
            document.getElementById('homeTotalInvested').textContent = formatCurrencyShort(totalInvested);
            document.getElementById('homeTotalValue').textContent = formatCurrencyShort(totalValue);
            document.getElementById('homeGainValue').textContent = (totalGain >= 0 ? '+' : '') + formatCurrencyShort(totalGain);
            document.getElementById('homeGainLabel').textContent = `Overall Gain (${totalGain >= 0 ? '+' : ''}${gainPct}%)`;

            if (totalGain < 0) {
                document.getElementById('homeGainCard').style.background = 'linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%)';
            }

            // Widget 2: Portfolio growth chart
            loadHomeGrowthChart();

            // Widget 3: Overall asset allocation doughnut
            loadHomeAllocationChart();

            // Widget 4: Alerts
            loadAlerts();
        }

        async function loadHomeGrowthChart() {
            try {
                const res = await fetch(`/api/investors/${investorId}/portfolio-history`);
                const history = await res.json();

                const emptyEl = document.getElementById('homeGrowthEmpty');
                const chartEl = document.getElementById('homeGrowthChart');

                if (!history || history.length < 2) {
                    if (emptyEl) emptyEl.style.display = 'block';
                    if (chartEl) chartEl.style.display = 'none';
                    return;
                }

                if (emptyEl) emptyEl.style.display = 'none';
                if (chartEl) chartEl.style.display = 'block';

                const ctx = chartEl.getContext('2d');
                if (homeGrowthChart) homeGrowthChart.destroy();
                homeGrowthChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: history.map(h => h.snapshot_date),
                        datasets: [
                            {
                                label: 'Portfolio Value',
                                data: history.map(h => h.total_value),
                                borderColor: '#28a745',
                                backgroundColor: 'rgba(40,167,69,0.1)',
                                fill: true,
                                tension: 0.3,
                                pointRadius: 2
                            },
                            {
                                label: 'Invested',
                                data: history.map(h => h.total_invested),
                                borderColor: '#6c757d',
                                borderDash: [5, 5],
                                fill: false,
                                tension: 0.3,
                                pointRadius: 2
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { position: 'bottom', labels: { boxWidth: 12 } } },
                        scales: {
                            y: { beginAtZero: false, ticks: { callback: v => '₹' + (v/100000).toFixed(1) + 'L' } },
                            x: { ticks: { maxTicksLimit: 8 } }
                        }
                    }
                });
            } catch (e) {
                console.error('Failed to load home growth chart:', e);
            }
        }

        function loadHomeAllocationChart() {
            const chartEl = document.getElementById('homeAllocChart');
            const emptyEl = document.getElementById('homeAllocEmpty');

            // Build segments dynamically
            const segments = [];
            let fallbackIdx = 0;

            function getConfig(key) {
                if (ASSET_TYPE_CONFIG[key]) return ASSET_TYPE_CONFIG[key];
                const color = FALLBACK_COLORS[fallbackIdx % FALLBACK_COLORS.length];
                fallbackIdx++;
                return { label: key.toUpperCase(), color, icon: 'bi-wallet2' };
            }

            // 1. Mutual Funds segment
            const mfValue = mfHoldings.reduce((sum, h) => {
                const val = (h.current_nav && h.current_nav > 0) ? h.current_value_live : h.current_value;
                return sum + (val || 0);
            }, 0);
            if (mfValue > 0) {
                const cfg = getConfig('mf');
                segments.push({
                    key: 'mf', label: cfg.label, value: mfValue, color: cfg.color, icon: cfg.icon,
                    assets: mfHoldings.filter(h => {
                        const v = (h.current_nav && h.current_nav > 0) ? h.current_value_live : h.current_value;
                        return (v || 0) > 0;
                    }).map(h => ({
                        name: h.scheme_name || 'Unknown Fund',
                        detail: `Folio: ${h.folio_number || '-'}`,
                        value: (h.current_nav && h.current_nav > 0) ? (h.current_value_live || h.current_value || 0) : (h.current_value || 0)
                    }))
                });
            }

            // 2. NPS segment
            const npsValue = npsAccounts.reduce((sum, n) => sum + (n.total_value || 0), 0);
            if (npsValue > 0) {
                const cfg = getConfig('nps');
                segments.push({
                    key: 'nps', label: cfg.label, value: npsValue, color: cfg.color, icon: cfg.icon,
                    assets: npsAccounts.filter(n => (n.total_value || 0) > 0).map(n => ({
                        name: n.name,
                        detail: `PRAN: ${n.pran || '-'}`,
                        value: n.total_value || 0
                    }))
                });
            }

            // 3. Manual assets — group by asset_type dynamically
            const maGroups = {};
            manualAssets.forEach(asset => {
                const t = asset.asset_type || 'other';
                if (!maGroups[t]) maGroups[t] = [];
                maGroups[t].push(asset);
            });

            Object.keys(maGroups).sort().forEach(type => {
                const assets = maGroups[type];
                const totalVal = assets.reduce((s, a) => s + (a.calculated_value || a.current_value || 0), 0);
                if (totalVal <= 0) return;

                const cfg = getConfig(type);
                segments.push({
                    key: type, label: cfg.label, value: totalVal, color: cfg.color, icon: cfg.icon,
                    assets: assets.filter(a => (a.calculated_value || a.current_value || 0) > 0).map(a => ({
                        name: a.name,
                        detail: a.ppf_account_number ? `A/C: ${a.ppf_account_number}` :
                                a.fd_maturity_date ? `Maturity: ${a.fd_maturity_date}` :
                                a.purchase_date ? `Purchased: ${a.purchase_date}` : '',
                        value: a.calculated_value || a.current_value || 0
                    }))
                });
            });

            // Store for click handler
            homeAllocSegments = segments;

            if (segments.length === 0) {
                if (chartEl) chartEl.style.display = 'none';
                if (emptyEl) emptyEl.style.display = 'block';
                return;
            }

            if (chartEl) chartEl.style.display = 'block';
            if (emptyEl) emptyEl.style.display = 'none';

            const ctx = chartEl.getContext('2d');
            if (homeAllocationChart) homeAllocationChart.destroy();
            homeAllocationChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: segments.map(s => s.label),
                    datasets: [{
                        data: segments.map(s => s.value),
                        backgroundColor: segments.map(s => s.color),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { boxWidth: 12 } },
                        tooltip: {
                            callbacks: {
                                label: function(ctx) {
                                    const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                    const pct = ((ctx.raw / total) * 100).toFixed(1);
                                    return `${ctx.label}: ${formatCurrency(ctx.raw)} (${pct}%) — Click for details`;
                                }
                            }
                        }
                    },
                    onClick: (evt, elements) => {
                        if (elements.length > 0) {
                            showAssetBreakdown(elements[0].index);
                        }
                    },
                    onHover: (evt, elements) => {
                        evt.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
                    }
                }
            });
        }

        function showAssetBreakdown(index) {
            const seg = homeAllocSegments[index];
            if (!seg) return;

            const header = document.getElementById('breakdownModalHeader');
            const title = document.getElementById('breakdownModalTitle');
            const body = document.getElementById('breakdownModalBody');

            header.style.background = seg.color;
            // Ensure readable text for light colors
            const lightColors = ['#ffc107', '#c0c0c0', '#d4a017'];
            header.style.color = lightColors.includes(seg.color) ? '#000' : '#fff';
            const closeBtn = header.querySelector('.btn-close');
            if (closeBtn) {
                closeBtn.className = lightColors.includes(seg.color)
                    ? 'btn-close' : 'btn-close btn-close-white';
            }

            title.innerHTML = `<i class="bi ${seg.icon} me-2"></i>${seg.label} — ${formatCurrency(seg.value)}`;

            const assets = (seg.assets || []).slice().sort((a, b) => b.value - a.value);
            const totalVal = seg.value;

            if (assets.length === 0) {
                body.innerHTML = '<div class="text-center py-4 text-muted">No individual assets to display</div>';
            } else {
                let rows = assets.map(a => {
                    const pct = totalVal > 0 ? ((a.value / totalVal) * 100).toFixed(1) : '0.0';
                    return `<tr>
                        <td>
                            <div class="fw-semibold">${truncate(a.name, 55)}</div>
                            ${a.detail ? `<small class="text-muted">${a.detail}</small>` : ''}
                        </td>
                        <td class="text-end fw-semibold mask-amount">${formatCurrency(a.value)}</td>
                        <td class="text-end">
                            <div class="d-flex align-items-center justify-content-end gap-2">
                                <span>${pct}%</span>
                                <div style="width:60px; height:6px; background:#e9ecef; border-radius:3px; overflow:hidden;">
                                    <div style="width:${Math.min(100, pct)}%; height:100%; background:${seg.color}; border-radius:3px;"></div>
                                </div>
                            </div>
                        </td>
                    </tr>`;
                }).join('');

                rows += `<tr class="table-light fw-bold">
                    <td>Total (${assets.length} item${assets.length !== 1 ? 's' : ''})</td>
                    <td class="text-end mask-amount">${formatCurrency(totalVal)}</td>
                    <td class="text-end">100%</td>
                </tr>`;

                body.innerHTML = `
                    <div class="table-responsive" style="max-height:500px; overflow-y:auto;">
                        <table class="table table-hover table-sm mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Asset Name</th>
                                    <th class="text-end">Value</th>
                                    <th class="text-end" style="width:140px;">Share</th>
                                </tr>
                            </thead>
                            <tbody>${rows}</tbody>
                        </table>
                    </div>`;
            }

            new bootstrap.Modal(document.getElementById('assetBreakdownModal')).show();
        }

        async function loadAlerts() {
            const body = document.getElementById('homeAlertsBody');
            const countEl = document.getElementById('homeAlertCount');
            try {
                const res = await fetch(`/api/investors/${investorId}/alerts`);
                const alerts = await res.json();

                // Filter out dismissed alerts
                const dismissedKey = `dismissedAlerts_${investorId}`;
                const dismissed = JSON.parse(localStorage.getItem(dismissedKey) || '[]');
                const visible = alerts.filter(a => !dismissed.includes(a.id));

                if (countEl) countEl.textContent = visible.length > 0 ? `${visible.length} alert${visible.length !== 1 ? 's' : ''}` : '';

                if (visible.length === 0) {
                    body.innerHTML = `
                        <div class="text-center py-3">
                            <i class="bi bi-check-circle text-success" style="font-size:1.5rem;"></i>
                            <p class="text-muted mb-0 mt-1">All clear! No alerts.</p>
                        </div>`;
                    return;
                }

                const borderClass = { warning: 'alert-warning-border', danger: 'alert-danger-border', info: 'alert-info-border' };
                const iconClass = { warning: 'bi-exclamation-triangle text-warning', danger: 'bi-x-octagon text-danger', info: 'bi-info-circle text-info' };

                body.innerHTML = visible.map(a => `
                    <div class="alert-item ${borderClass[a.type] || ''}" id="alert-${a.id}">
                        <div class="alert-content">
                            <div class="alert-title">
                                <i class="bi ${iconClass[a.type] || 'bi-bell'} me-1"></i>
                                <span class="badge bg-light text-dark me-1" style="font-size:0.7rem;">${a.category}</span>
                                ${a.title}
                            </div>
                            ${a.description ? `<div class="alert-desc">${a.description}</div>` : ''}
                        </div>
                        <div class="alert-actions">
                            ${a.link ? `<a href="${a.link}" class="btn btn-sm btn-outline-primary">${a.link_text || 'View'}</a>` : ''}
                            <button class="btn btn-sm btn-outline-secondary" onclick="dismissAlert('${a.id}')" title="Dismiss">
                                <i class="bi bi-x"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Failed to load alerts:', e);
                body.innerHTML = '<div class="text-center py-3 text-muted">Failed to load alerts</div>';
            }
        }

        function dismissAlert(alertId) {
            const dismissedKey = `dismissedAlerts_${investorId}`;
            const dismissed = JSON.parse(localStorage.getItem(dismissedKey) || '[]');
            if (!dismissed.includes(alertId)) {
                dismissed.push(alertId);
                localStorage.setItem(dismissedKey, JSON.stringify(dismissed));
            }
            // Hide the alert element
            const el = document.getElementById(`alert-${alertId}`);
            if (el) el.remove();

            // Update count
            const remaining = document.querySelectorAll('#homeAlertsBody .alert-item').length;
            const countEl = document.getElementById('homeAlertCount');
            if (countEl) countEl.textContent = remaining > 0 ? `${remaining} alert${remaining !== 1 ? 's' : ''}` : '';

            if (remaining === 0) {
                document.getElementById('homeAlertsBody').innerHTML = `
                    <div class="text-center py-3">
                        <i class="bi bi-check-circle text-success" style="font-size:1.5rem;"></i>
                        <p class="text-muted mb-0 mt-1">All clear! No alerts.</p>
                    </div>`;
            }
        }

        function buildMFTabContent(isActive) {
            const mfGain = computedTotals.mfValue - computedTotals.mfInvested;
            const mfGainPct = computedTotals.mfInvested > 0
                ? ((mfGain / computedTotals.mfInvested) * 100).toFixed(1) : 0;
            const gainColor = mfGain >= 0 ? '#11998e' : '#dc3545';

            return `
            <div class="tab-pane fade ${isActive ? 'show active' : ''}" id="mf-tab" role="tabpanel">
                <!-- MF Summary Banner -->
                <div class="summary-card mb-3 d-flex align-items-center justify-content-between" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <div>
                        <p class="mb-0" style="opacity:0.85; font-size:0.85rem;">Total MF Value</p>
                        <h2 class="mb-0 mask-amount">${formatCurrency(computedTotals.mfValue)}</h2>
                    </div>
                    <div class="text-end">
                        <p class="mb-0" style="opacity:0.85; font-size:0.85rem;">Gain/Loss</p>
                        <span class="mask-amount" style="font-size:1.3rem; font-weight:700;">${mfGain >= 0 ? '+' : ''}${formatCurrency(mfGain)}</span>
                        <span class="mask-amount" style="font-size:0.9rem; opacity:0.9;"> (${mfGain >= 0 ? '+' : ''}${mfGainPct}%)</span>
                        <div id="mfXirrBanner" style="font-size:0.85rem; opacity:0.9; margin-top:2px;">XIRR: loading...</div>
                    </div>
                </div>

                <!-- MF Sub Tabs -->
                <ul class="nav nav-pills sub-tabs mb-3" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#mf-holdings">
                            <i class="bi bi-briefcase"></i> Holdings
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#mf-transactions">
                            <i class="bi bi-list-ul"></i> Transactions
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#mf-history" onclick="loadPortfolioHistory()">
                            <i class="bi bi-graph-up"></i> Portfolio History
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#mf-allocation" onclick="loadAssetAllocation()">
                            <i class="bi bi-pie-chart"></i> Asset Allocation
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="pill" data-bs-target="#mf-performance" onclick="loadPerformance()">
                            <i class="bi bi-speedometer2"></i> Performance
                        </button>
                    </li>
                </ul>

                <div class="tab-content">
                    <!-- Holdings Sub-tab -->
                    <div class="tab-pane fade show active" id="mf-holdings">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                                    <input type="text" class="form-control" id="holdingsSearch" placeholder="Search holdings...">
                                </div>
                            </div>
                        </div>
                        <div class="row" id="holdingsGrid"></div>
                    </div>

                    <!-- Transactions Sub-tab -->
                    <div class="tab-pane fade" id="mf-transactions">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <select class="form-select" id="txTypeFilter"><option value="">All Types</option></select>
                                    </div>
                                    <div class="col-md-4">
                                        <input type="text" class="form-control" id="txSearch" placeholder="Search...">
                                    </div>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-hover table-sm">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Date</th><th>Type</th><th>Scheme</th><th>Folio</th>
                                                <th class="text-end">Amount</th><th class="text-end">Units</th><th class="text-end">NAV</th>
                                            </tr>
                                        </thead>
                                        <tbody id="transactionsBody"></tbody>
                                    </table>
                                </div>
                                <p class="text-muted mt-2">Showing <span id="txCount">0</span> transactions</p>
                            </div>
                        </div>
                    </div>

                    <!-- Portfolio History Sub-tab -->
                    <div class="tab-pane fade" id="mf-history">
                        <div class="card shadow-sm">
                            <div class="card-header bg-white">
                                <h5 class="mb-0"><i class="bi bi-graph-up"></i> Portfolio Value Over Time</h5>
                            </div>
                            <div class="card-body">
                                <div id="historyChart" style="height: 300px;">
                                    <div class="text-center py-5" id="historyEmpty">
                                        <i class="bi bi-hourglass" style="font-size:3rem;color:#ccc;"></i>
                                        <p class="text-muted mt-2">No history data yet. Snapshots are taken when you refresh NAV.</p>
                                    </div>
                                    <canvas id="portfolioChart" style="display:none;"></canvas>
                                </div>
                                <div class="table-responsive mt-4">
                                    <table class="table table-sm">
                                        <thead class="table-light">
                                            <tr><th>Date</th><th class="text-end">Value</th><th class="text-end">Invested</th><th class="text-end">Gain/Loss</th><th class="text-end">Return %</th></tr>
                                        </thead>
                                        <tbody id="historyTableBody"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Asset Allocation Sub-tab -->
                    <div class="tab-pane fade" id="mf-allocation">
                        <div class="row">
                            <div class="col-md-5">
                                <div class="card shadow-sm">
                                    <div class="card-header bg-white"><h5 class="mb-0"><i class="bi bi-pie-chart"></i> Allocation</h5></div>
                                    <div class="card-body">
                                        <div id="allocationChartContainer" style="height: 300px;">
                                            <div class="text-center py-5" id="allocEmpty">
                                                <i class="bi bi-pie-chart" style="font-size:3rem;color:#ccc;"></i>
                                                <p class="text-muted mt-2">No allocation data</p>
                                            </div>
                                            <canvas id="allocationChart" style="display:none;"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-7">
                                <div class="card shadow-sm">
                                    <div class="card-header bg-white"><h5 class="mb-0"><i class="bi bi-list"></i> Breakdown</h5></div>
                                    <div class="card-body">
                                        <table class="table">
                                            <thead class="table-light">
                                                <tr><th>Asset Class</th><th class="text-end">Value</th><th class="text-end">%</th><th style="width:200px;"></th></tr>
                                            </thead>
                                            <tbody id="allocationTableBody"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Performance Sub-tab -->
                    <div class="tab-pane fade" id="mf-performance">
                        <!-- Controls Bar -->
                        <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
                            <select id="perfCategorySelect" class="form-select form-select-sm" style="width:auto;" onchange="updatePerformanceChart()">
                                <option value="">All MF</option>
                                <option value="equity">Equity</option>
                                <option value="debt">Debt</option>
                                <option value="hybrid">Hybrid</option>
                                <option value="gold_commodity">Gold / Commodity</option>
                            </select>

                            <button class="btn btn-sm btn-outline-primary" onclick="openBenchmarkSearch()">
                                <i class="bi bi-plus-circle"></i> Add Benchmark
                            </button>

                            <button class="btn btn-sm btn-outline-success" onclick="downloadCashflows()" title="Export XIRR cashflows to Excel for validation">
                                <i class="bi bi-download"></i> Export Cashflows
                            </button>

                            <div id="benchmarkPills" class="d-flex flex-wrap gap-1"></div>

                            <div class="flex-grow-1"></div>

                            <div class="btn-group btn-group-sm" id="perfTimePills">
                                <button class="btn btn-outline-secondary" onclick="setPerfPeriod('1W')">1W</button>
                                <button class="btn btn-outline-secondary" onclick="setPerfPeriod('1M')">1M</button>
                                <button class="btn btn-outline-secondary" onclick="setPerfPeriod('3M')">3M</button>
                                <button class="btn btn-outline-secondary" onclick="setPerfPeriod('6M')">6M</button>
                                <button class="btn btn-outline-secondary active" onclick="setPerfPeriod('1Y')">1Y</button>
                                <button class="btn btn-outline-secondary" onclick="setPerfPeriod('2Y')">2Y</button>
                                <button class="btn btn-outline-secondary" onclick="setPerfPeriod('3Y')">3Y</button>
                                <button class="btn btn-outline-secondary" onclick="setPerfPeriod('5Y')">5Y</button>
                                <button class="btn btn-outline-secondary" onclick="setPerfPeriod('7Y')">7Y</button>
                                <button class="btn btn-outline-secondary" onclick="setPerfPeriod('ALL')">All</button>
                            </div>
                        </div>

                        <!-- Loading Spinner -->
                        <div id="perfLoading" class="text-center py-4" style="display:none;">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="text-muted mt-2">Loading performance data...</p>
                        </div>

                        <!-- Chart -->
                        <div class="card shadow-sm mb-3">
                            <div class="card-body">
                                <div id="perfChartContainer" style="height: 400px; position: relative;">
                                    <div class="text-center py-5" id="perfEmpty">
                                        <i class="bi bi-speedometer2" style="font-size:3rem;color:#ccc;"></i>
                                        <p class="text-muted mt-2">Select a time period to view performance</p>
                                    </div>
                                    <canvas id="performanceChart" style="display:none;"></canvas>
                                </div>
                            </div>
                        </div>

                        <!-- Metrics Cards -->
                        <div class="row mb-3" id="perfMetricsRow" style="display:none;">
                            <div class="col">
                                <div class="card shadow-sm text-center h-100">
                                    <div class="card-body py-2">
                                        <small class="text-muted">Portfolio XIRR</small>
                                        <h5 class="mb-0" id="metricPortfolioXirr">-</h5>
                                    </div>
                                </div>
                            </div>
                            <div class="col">
                                <div class="card shadow-sm text-center h-100">
                                    <div class="card-body py-2">
                                        <small class="text-muted">Benchmark Return</small>
                                        <h5 class="mb-0" id="metricBenchmarkXirr">-</h5>
                                    </div>
                                </div>
                            </div>
                            <div class="col">
                                <div class="card shadow-sm text-center h-100">
                                    <div class="card-body py-2">
                                        <small class="text-muted">Alpha</small>
                                        <h5 class="mb-0" id="metricAlpha">-</h5>
                                    </div>
                                </div>
                            </div>
                            <div class="col">
                                <div class="card shadow-sm text-center h-100">
                                    <div class="card-body py-2">
                                        <small class="text-muted">Volatility</small>
                                        <h5 class="mb-0" id="metricVolatility">-</h5>
                                    </div>
                                </div>
                            </div>
                            <div class="col">
                                <div class="card shadow-sm text-center h-100">
                                    <div class="card-body py-2">
                                        <small class="text-muted">Max Drawdown</small>
                                        <h5 class="mb-0" id="metricMaxDrawdown">-</h5>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Returns Comparison Table -->
                        <div class="card shadow-sm">
                            <div class="card-header bg-white">
                                <h6 class="mb-0"><i class="bi bi-table"></i> Returns Comparison</h6>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-sm mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Name</th>
                                                <th class="text-end">Absolute Return</th>
                                                <th class="text-end">XIRR / CAGR</th>
                                                <th class="text-end">Volatility</th>
                                                <th class="text-end">Max Drawdown</th>
                                            </tr>
                                        </thead>
                                        <tbody id="perfReturnsBody">
                                            <tr><td colspan="5" class="text-center text-muted">No data yet</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Multi-Period Returns Table -->
                        <div class="card shadow-sm mt-3">
                            <div class="card-header bg-white">
                                <h6 class="mb-0"><i class="bi bi-bar-chart-steps"></i> Returns Across Periods</h6>
                            </div>
                            <div class="card-body">
                                <div id="multiPeriodLoading" class="text-center py-3" style="display:none;">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                                    <span class="text-muted ms-2">Loading returns...</span>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-sm table-bordered mb-0" id="multiPeriodTable" style="display:none;">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Name</th>
                                                <th class="text-end">1Y</th>
                                                <th class="text-end">2Y</th>
                                                <th class="text-end">3Y</th>
                                                <th class="text-end">5Y</th>
                                                <th class="text-end">All Time</th>
                                            </tr>
                                        </thead>
                                        <tbody id="multiPeriodBody">
                                        </tbody>
                                    </table>
                                </div>
                                <div id="multiPeriodEmpty" class="text-center text-muted py-3" style="display:none;">
                                    No returns data available
                                </div>
                            </div>
                        </div>

                        <!-- Performance by Asset Table -->
                        <div class="card shadow-sm mt-3">
                            <div class="card-header bg-white">
                                <h6 class="mb-0"><i class="bi bi-collection"></i> Performance by Asset</h6>
                            </div>
                            <div class="card-body p-0">
                                <div id="assetPerfLoading" class="text-center py-3" style="display:none;">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                                    <span class="text-muted ms-2">Loading fund performance...</span>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover mb-0" id="assetPerfTable" style="display:none;">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Fund Name</th>
                                                <th class="text-end">XIRR</th>
                                                <th class="text-end">Valuation</th>
                                            </tr>
                                        </thead>
                                        <tbody id="assetPerfBody">
                                        </tbody>
                                    </table>
                                </div>
                                <div id="assetPerfEmpty" class="text-center text-muted py-3" style="display:none;">
                                    No fund data available
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        function buildNPSTabContent(isActive) {
            let npsHtml = '';
            npsAccounts.forEach(nps => {
                const summary = nps.summary || {};
                const totalValue = nps.total_value || 0;
                const totalContrib = summary.total_contribution || 0;
                const gain = summary.gain_loss || (totalValue - totalContrib);
                const gainPct = summary.gain_loss_pct || (totalContrib > 0 ? ((gain / totalContrib) * 100).toFixed(1) : 0);
                const gainClass = gain >= 0 ? 'positive' : 'negative';

                let allocHtml = '';
                const schemeAlloc = summary.scheme_allocation || {};
                ['E', 'C', 'G', 'A'].forEach(type => {
                    const key = `I_${type}`;
                    if (schemeAlloc[key] && schemeAlloc[key].pct > 0) {
                        const colors = { 'E': 'success', 'C': 'primary', 'G': 'warning', 'A': 'secondary' };
                        allocHtml += `<span class="badge bg-${colors[type]} me-1">${type}: ${schemeAlloc[key].pct.toFixed(0)}%</span>`;
                    }
                });

                npsHtml += `
                <div class="col-md-6 mb-3">
                    <div class="card nps-card h-100" onclick="window.location='/nps/${nps.id}'">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <h6 class="card-title mb-1">${nps.name}</h6>
                                    <small class="text-muted">PRAN: ${nps.pran}</small>
                                </div>
                                <span class="badge badge-nps">NPS</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h4 class="mb-0 text-success mask-amount">${formatCurrency(totalValue)}</h4>
                                <span class="${gainClass} mask-amount">
                                    ${gain >= 0 ? '+' : ''}${formatCurrency(gain)} (${gain >= 0 ? '+' : ''}${gainPct}%)
                                </span>
                            </div>
                            <hr class="my-2">
                            <div class="d-flex justify-content-between small">
                                <span class="text-muted mask-amount">Contributed: ${formatCurrency(totalContrib)}</span>
                                <div>${allocHtml}</div>
                            </div>
                        </div>
                    </div>
                </div>`;
            });

            return `
            <div class="tab-pane fade ${isActive ? 'show active' : ''}" id="nps-tab" role="tabpanel">
                <div class="row">${npsHtml}</div>
                <p class="text-muted text-center mt-3">
                    <i class="bi bi-info-circle"></i> Click on an NPS account to view detailed schemes and transactions
                </p>
            </div>`;
        }

        function buildFDTabContent(fdAssets, isActive) {
            let fdHtml = '';
            fdAssets.forEach(fd => {
                const currentVal = fd.current_value || fd.purchase_value || 0;
                const principal = fd.fd_principal || fd.purchase_value || 0;
                const interest = currentVal - principal;
                const maturityDate = fd.fd_maturity_date || '-';

                fdHtml += `
                <div class="col-md-6 mb-3">
                    <div class="card h-100" style="border-left: 4px solid #fd7e14;">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="card-title mb-1">${fd.name}</h6>
                                <span class="badge badge-fd">FD</span>
                            </div>
                            <h4 class="text-success mask-amount">${formatCurrency(currentVal)}</h4>
                            <div class="row small mt-2">
                                <div class="col-6">
                                    <span class="text-muted">Principal:</span><br>
                                    <strong class="mask-amount">${formatCurrency(principal)}</strong>
                                </div>
                                <div class="col-6">
                                    <span class="text-muted">Interest Earned:</span><br>
                                    <strong class="text-success mask-amount">+${formatCurrency(interest)}</strong>
                                </div>
                            </div>
                            <hr class="my-2">
                            <small class="text-muted">
                                <i class="bi bi-calendar"></i> Maturity: ${maturityDate}
                                ${fd.fd_interest_rate ? ` | Rate: ${fd.fd_interest_rate}%` : ''}
                            </small>
                        </div>
                    </div>
                </div>`;
            });

            return `
            <div class="tab-pane fade ${isActive ? 'show active' : ''}" id="fd-tab" role="tabpanel">
                <div class="row">${fdHtml}</div>
            </div>`;
        }

        function buildSGBTabContent(sgbAssets, isActive) {
            let sgbHtml = '';
            sgbAssets.forEach(sgb => {
                const currentVal = sgb.current_value || 0;
                const purchaseVal = sgb.purchase_value || 0;
                const gain = currentVal - purchaseVal;
                const gainPct = purchaseVal > 0 ? ((gain / purchaseVal) * 100).toFixed(1) : 0;

                sgbHtml += `
                <div class="col-md-6 mb-3">
                    <div class="card h-100" style="border-left: 4px solid #ffc107;">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="card-title mb-1">${sgb.name}</h6>
                                <span class="badge badge-sgb">SGB</span>
                            </div>
                            <h4 class="text-success mask-amount">${formatCurrency(currentVal)}</h4>
                            <div class="d-flex justify-content-between small mt-2">
                                <span class="text-muted mask-amount">Invested: ${formatCurrency(purchaseVal)}</span>
                                <span class="${gain >= 0 ? 'positive' : 'negative'} mask-amount">
                                    ${gain >= 0 ? '+' : ''}${formatCurrency(gain)} (${gain >= 0 ? '+' : ''}${gainPct}%)
                                </span>
                            </div>
                            <hr class="my-2">
                            <small class="text-muted">
                                ${sgb.sgb_grams ? `<i class="bi bi-gem"></i> ${sgb.sgb_grams}g` : ''}
                                ${sgb.purchase_date ? ` | Purchased: ${sgb.purchase_date}` : ''}
                            </small>
                        </div>
                    </div>
                </div>`;
            });

            return `
            <div class="tab-pane fade ${isActive ? 'show active' : ''}" id="sgb-tab" role="tabpanel">
                <div class="row">${sgbHtml}</div>
            </div>`;
        }

        function buildOtherAssetsTabContent(assets, isActive) {
            let html = '';
            assets.forEach(asset => {
                const currentVal = asset.current_value || 0;
                const purchaseVal = asset.purchase_value || 0;
                const gain = currentVal - purchaseVal;

                html += `
                <div class="col-md-6 mb-3">
                    <div class="card h-100" style="border-left: 4px solid #6c757d;">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="card-title mb-1">${asset.name}</h6>
                                <span class="badge bg-secondary">${asset.asset_type.toUpperCase()}</span>
                                ${asset.exclude_from_xirr ? '<span class="badge bg-warning text-dark" style="font-size:0.65rem;">non-XIRR</span>' : ''}
                            </div>
                            <h4 class="text-success mask-amount">${formatCurrency(currentVal)}</h4>
                            <div class="d-flex justify-content-between small mt-2">
                                <span class="text-muted mask-amount">Invested: ${formatCurrency(purchaseVal)}</span>
                                <span class="${gain >= 0 ? 'positive' : 'negative'} mask-amount">
                                    ${gain >= 0 ? '+' : ''}${formatCurrency(gain)}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>`;
            });

            return `
            <div class="tab-pane fade ${isActive ? 'show active' : ''}" id="other-tab" role="tabpanel">
                <div class="row">${html}</div>
            </div>`;
        }

        function buildPPFTabContent(ppfAssets, isActive) {
            const ppfInterest = computedTotals.ppfValue - computedTotals.ppfInvested;

            let cardsHtml = '';
            ppfAssets.forEach(asset => {
                const currentVal = asset.current_value || 0;
                const invested = asset.purchase_value || 0;
                const interest = currentVal - invested;
                const typeBadge = asset.asset_type === 'epf' ? 'EPF' : 'PPF';

                cardsHtml += `
                <div class="col-md-6 mb-3">
                    <div class="card ppf-card h-100" data-folio-id="manual_${asset.id}" onclick="openPpfAccount(${asset.id})">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <h6 class="card-title mb-1">${asset.name}</h6>
                                    ${asset.ppf_account_number ? `<small class="text-muted">A/C: ${asset.ppf_account_number}</small>` : ''}
                                </div>
                                <div class="d-flex align-items-center gap-1">
                                    <span class="badge badge-ppf">${typeBadge}</span>
                                    <span class="folio-xirr-badge" data-folio-id="manual_${asset.id}"></span>
                                </div>
                            </div>
                            <h4 class="text-success mask-amount">${formatCurrency(currentVal)}</h4>
                            <div class="row small mt-2">
                                <div class="col-6">
                                    <span class="text-muted">Invested:</span><br>
                                    <strong class="mask-amount">${formatCurrency(invested)}</strong>
                                </div>
                                <div class="col-6">
                                    <span class="text-muted">Interest Earned:</span><br>
                                    <strong class="${interest >= 0 ? 'text-success' : 'text-danger'} mask-amount">${interest >= 0 ? '+' : ''}${formatCurrency(interest)}</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
            });

            return `
            <div class="tab-pane fade ${isActive ? 'show active' : ''}" id="ppf-tab" role="tabpanel">
                <!-- Card Grid View -->
                <div id="ppfInvCardGrid">
                    <div class="summary-card mb-3 d-flex align-items-center justify-content-between" style="background: linear-gradient(135deg, #198754 0%, #38ef7d 100%);">
                        <div>
                            <p class="mb-0" style="opacity:0.85; font-size:0.85rem;">Total PPF/EPF Value</p>
                            <h2 class="mb-0 mask-amount">${formatCurrency(computedTotals.ppfValue)}</h2>
                        </div>
                        <div class="text-end">
                            <p class="mb-0" style="opacity:0.85; font-size:0.85rem;">Interest Earned</p>
                            <span class="mask-amount" style="font-size:1.3rem; font-weight:700;">${ppfInterest >= 0 ? '+' : ''}${formatCurrency(ppfInterest)}</span>
                        </div>
                    </div>
                    <div class="row">${cardsHtml}</div>
                    <p class="text-muted text-center mt-2">
                        <a href="/manual-assets?investor_id=${investorId}" class="text-decoration-none">
                            <i class="bi bi-plus-circle"></i> Add new account &rarr;
                        </a>
                    </p>
                </div>

                <!-- Transaction Detail View (hidden by default) -->
                <div id="ppfInvTxDetail" style="display:none;">
                    <div class="d-flex align-items-center mb-3">
                        <button class="btn btn-sm btn-outline-secondary me-3" onclick="closePpfAccount()">
                            <i class="bi bi-arrow-left"></i> Back
                        </button>
                        <h5 class="mb-0" id="ppfInvAccountName">Account</h5>
                        <span class="badge bg-success ms-2 mask-amount" id="ppfInvAccountBalance"></span>
                    </div>

                    <!-- Transaction Form -->
                    <div class="card shadow-sm mb-3">
                        <div class="card-header bg-white py-2">
                            <h6 class="mb-0"><i class="bi bi-plus-circle"></i> Add Transaction</h6>
                        </div>
                        <div class="card-body">
                            <div class="row g-2 align-items-end">
                                <div class="col-md-2">
                                    <label class="form-label small">Type</label>
                                    <select class="form-select form-select-sm" id="ppfInvTxType">
                                        <option value="investment">Investment</option>
                                        <option value="interest">Interest</option>
                                        <option value="withdrawal">Withdrawal</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small">Date</label>
                                    <input type="date" class="form-control form-control-sm" id="ppfInvTxDate"
                                           value="${new Date().toISOString().split('T')[0]}">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small">Amount</label>
                                    <input type="number" class="form-control form-control-sm" id="ppfInvTxAmount"
                                           step="0.01" min="0" placeholder="0.00">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label small">Narration</label>
                                    <input type="text" class="form-control form-control-sm" id="ppfInvTxNarration"
                                           placeholder="Optional note">
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-sm btn-success w-100" onclick="savePpfInvTransaction()">
                                        <i class="bi bi-check-lg"></i> Save
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Transaction Table -->
                    <div class="card shadow-sm mb-3">
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover table-sm mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Date</th>
                                            <th>Type</th>
                                            <th class="text-end">Amount</th>
                                            <th>Narration</th>
                                            <th class="text-end">Running Balance</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody id="ppfInvTxBody">
                                        <tr><td colspan="6" class="text-center text-muted py-3">Loading...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Delete Account -->
                    <div class="text-end">
                        <button class="btn btn-sm btn-outline-danger" onclick="deletePpfAccount(ppfSelectedAssetId)">
                            <i class="bi bi-trash"></i> Delete Account
                        </button>
                    </div>
                </div>
            </div>`;
        }

        function openPpfAccount(assetId) {
            ppfSelectedAssetId = assetId;
            const asset = manualAssets.find(a => a.id === assetId);
            if (!asset) return;

            document.getElementById('ppfInvCardGrid').style.display = 'none';
            document.getElementById('ppfInvTxDetail').style.display = '';
            document.getElementById('ppfInvAccountName').textContent = asset.name;
            document.getElementById('ppfInvAccountBalance').textContent = formatCurrency(asset.current_value || 0);

            loadPpfInvTransactions(assetId);
        }

        function closePpfAccount() {
            ppfSelectedAssetId = null;
            // Rebuild tabs with fresh data and re-activate PPF tab
            calculateAndDisplayTotals();
            buildAssetTabs();
            // Activate the PPF tab
            const ppfBtn = document.querySelector('button[data-bs-target="#ppf-tab"]');
            if (ppfBtn) {
                const activeBtn = document.querySelector('#assetTypeTabs .nav-link.active');
                if (activeBtn) activeBtn.classList.remove('active');
                const activePane = document.querySelector('#assetTypeContent .tab-pane.show.active');
                if (activePane) activePane.classList.remove('show', 'active');
                ppfBtn.classList.add('active');
                const pane = document.getElementById('ppf-tab');
                if (pane) pane.classList.add('show', 'active');
            }
            loadXirrData();
        }

        async function loadPpfInvTransactions(assetId) {
            const tbody = document.getElementById('ppfInvTxBody');
            if (!tbody) return;

            try {
                const res = await fetch(`/api/manual-assets/${assetId}/transactions`);
                const txs = await res.json();

                if (txs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-3">No transactions yet</td></tr>';
                    return;
                }

                tbody.innerHTML = txs.map(tx => {
                    const badgeClass = tx.tx_type === 'investment' ? 'ppf-badge-investment'
                        : tx.tx_type === 'interest' ? 'ppf-badge-interest' : 'ppf-badge-withdrawal';
                    return `<tr>
                        <td>${tx.tx_date}</td>
                        <td><span class="badge ${badgeClass}">${tx.tx_type}</span></td>
                        <td class="text-end mask-amount">${formatCurrency(tx.amount)}</td>
                        <td class="text-muted">${tx.narration || '-'}</td>
                        <td class="text-end fw-bold mask-amount">${formatCurrency(tx.running_balance)}</td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-outline-danger" onclick="deletePpfInvTransaction(${tx.id})" title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>`;
                }).join('');
            } catch (e) {
                console.error('Failed to load PPF transactions:', e);
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger py-3">Failed to load transactions</td></tr>';
            }
        }

        async function savePpfInvTransaction() {
            if (!ppfSelectedAssetId) return;

            const txType = document.getElementById('ppfInvTxType').value;
            const txDate = document.getElementById('ppfInvTxDate').value;
            const amount = parseFloat(document.getElementById('ppfInvTxAmount').value);
            const narration = document.getElementById('ppfInvTxNarration').value.trim();

            if (!txDate || !amount || amount <= 0) {
                alert('Please enter a valid date and amount.');
                return;
            }

            try {
                const res = await fetch(`/api/manual-assets/${ppfSelectedAssetId}/transactions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tx_type: txType, tx_date: txDate, amount, narration })
                });
                const result = await res.json();
                if (result.error) { alert('Error: ' + result.error); return; }

                // Clear form
                document.getElementById('ppfInvTxAmount').value = '';
                document.getElementById('ppfInvTxNarration').value = '';

                // Refresh data
                await refreshPpfAssetData();
                loadPpfInvTransactions(ppfSelectedAssetId);
            } catch (e) {
                alert('Failed to save transaction: ' + e.message);
            }
        }

        async function deletePpfInvTransaction(txId) {
            if (!confirm('Delete this transaction?')) return;

            try {
                const res = await fetch(`/api/manual-assets/transactions/${txId}`, { method: 'DELETE' });
                const result = await res.json();
                if (result.error) { alert('Error: ' + result.error); return; }

                await refreshPpfAssetData();
                loadPpfInvTransactions(ppfSelectedAssetId);
            } catch (e) {
                alert('Failed to delete transaction: ' + e.message);
            }
        }

        async function deletePpfAccount(assetId) {
            if (!confirm('Delete this account and all its transactions? This cannot be undone.')) return;

            try {
                const res = await fetch(`/api/manual-assets/${assetId}`, { method: 'DELETE' });
                const result = await res.json();
                if (result.error) { alert('Error: ' + result.error); return; }

                ppfSelectedAssetId = null;
                // Reload all data
                await loadData();
            } catch (e) {
                alert('Failed to delete account: ' + e.message);
            }
        }

        async function refreshPpfAssetData() {
            // Re-fetch manual assets to get updated values
            try {
                const assetsRes = await fetch(`/api/manual-assets?investor_id=${investorId}`);
                manualAssets = await assetsRes.json();
            } catch (e) { /* keep existing */ }

            // Update balance badge
            const asset = manualAssets.find(a => a.id === ppfSelectedAssetId);
            if (asset) {
                const balEl = document.getElementById('ppfInvAccountBalance');
                if (balEl) balEl.textContent = formatCurrency(asset.current_value || 0);
            }

            calculateAndDisplayTotals();
        }

        // ==================== Gold Tab ====================

        function buildGoldTabContent(goldAssets, isActive) {
            const goldGain = computedTotals.goldValue - computedTotals.goldInvested;

            let cardsHtml = '';
            goldAssets.forEach(asset => {
                const currentVal = asset.calculated_value || asset.current_value || 0;
                const invested = asset.purchase_value || 0;
                const gain = currentVal - invested;
                const grams = asset.units || 0;

                cardsHtml += `
                <div class="col-md-6 mb-3">
                    <div class="card gold-card h-100" data-folio-id="manual_${asset.id}" onclick="openGoldLot(${asset.id})">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div>
                                    <h6 class="card-title mb-1">${asset.name}</h6>
                                    ${asset.gold_seller ? `<small class="text-muted">Seller: ${asset.gold_seller}</small>` : ''}
                                </div>
                                <div class="d-flex align-items-center gap-1">
                                    <span class="badge badge-gold">${parseFloat(grams).toFixed(2)}g</span>
                                    <span class="folio-xirr-badge" data-folio-id="manual_${asset.id}"></span>
                                </div>
                            </div>
                            <h4 class="mask-amount" style="color:#d4a017;">${formatCurrency(currentVal)}</h4>
                            <div class="row small mt-2">
                                <div class="col-6">
                                    <span class="text-muted">Invested:</span><br>
                                    <strong class="mask-amount">${formatCurrency(invested)}</strong>
                                </div>
                                <div class="col-6">
                                    <span class="text-muted">Gain/Loss:</span><br>
                                    <strong class="${gain >= 0 ? 'text-success' : 'text-danger'} mask-amount">${gain >= 0 ? '+' : ''}${formatCurrency(gain)}</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
            });

            return `
            <div class="tab-pane fade ${isActive ? 'show active' : ''}" id="gold-tab" role="tabpanel">
                <!-- Card Grid View -->
                <div id="goldInvCardGrid">
                    <div class="summary-card mb-3 d-flex align-items-center justify-content-between" style="background: linear-gradient(135deg, #d4a017 0%, #f5d442 100%);">
                        <div>
                            <p class="mb-0" style="opacity:0.85; font-size:0.85rem;">Total Gold Value</p>
                            <h2 class="mb-0 mask-amount">${formatCurrency(computedTotals.goldValue)}</h2>
                        </div>
                        <div class="text-end">
                            <p class="mb-0" style="opacity:0.85; font-size:0.85rem;">Gain/Loss</p>
                            <span class="mask-amount" style="font-size:1.3rem; font-weight:700;">${goldGain >= 0 ? '+' : ''}${formatCurrency(goldGain)}</span>
                        </div>
                    </div>
                    <div class="row">${cardsHtml}</div>
                    <p class="text-muted text-center mt-2">
                        <a href="/manual-assets?investor_id=${investorId}" class="text-decoration-none">
                            <i class="bi bi-plus-circle"></i> Add new gold lot &rarr;
                        </a>
                    </p>
                </div>

                <!-- Transaction Detail View (hidden by default) -->
                <div id="goldInvTxDetail" style="display:none;">
                    <div class="d-flex align-items-center mb-3">
                        <button class="btn btn-sm btn-outline-secondary me-3" onclick="closeGoldLot()">
                            <i class="bi bi-arrow-left"></i> Back
                        </button>
                        <h5 class="mb-0" id="goldInvLotName">Lot</h5>
                        <span class="badge bg-warning text-dark ms-2" id="goldInvLotQty"></span>
                        <span class="badge bg-success ms-2 mask-amount" id="goldInvLotBalance"></span>
                    </div>

                    <!-- Price Update Section -->
                    <div class="card shadow-sm mb-3 border-warning">
                        <div class="card-body py-2">
                            <div class="d-flex align-items-center justify-content-between mb-2">
                                <div>
                                    <small class="text-muted">Current Price/g:</small>
                                    <span class="fw-bold ms-1" id="goldInvCurrentPrice">--</span>
                                    <small class="text-muted ms-2" id="goldInvPriceDate"></small>
                                </div>
                                <button class="btn btn-sm btn-outline-secondary py-0" type="button"
                                        data-bs-toggle="collapse" data-bs-target="#goldInvPriceHistory">
                                    <i class="bi bi-clock-history"></i> History
                                </button>
                            </div>
                            <div class="row g-2 align-items-end">
                                <div class="col-auto">
                                    <label class="form-label small mb-0">Date</label>
                                    <input type="date" class="form-control form-control-sm" id="goldInvPriceDateInput"
                                           value="\${new Date().toISOString().split('T')[0]}">
                                </div>
                                <div class="col-auto">
                                    <label class="form-label small mb-0">Price/g</label>
                                    <input type="number" class="form-control form-control-sm" id="goldInvPriceInput"
                                           step="0.01" min="0" placeholder="0.00" style="width:120px;">
                                </div>
                                <div class="col-auto">
                                    <label class="form-label small mb-0">&nbsp;</label>
                                    <button class="btn btn-sm btn-warning d-block" onclick="saveGoldInvPrice()">
                                        Update
                                    </button>
                                </div>
                            </div>
                            <div class="collapse mt-2" id="goldInvPriceHistory">
                                <table class="table table-sm table-bordered mb-0" style="font-size:0.8rem;">
                                    <thead class="table-light"><tr><th>Date</th><th class="text-end">Price/g</th></tr></thead>
                                    <tbody id="goldInvPriceHistoryBody">
                                        <tr><td colspan="2" class="text-center text-muted">No history</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Transaction Form -->
                    <div class="card shadow-sm mb-3">
                        <div class="card-header bg-white py-2">
                            <h6 class="mb-0"><i class="bi bi-plus-circle"></i> Add Transaction</h6>
                        </div>
                        <div class="card-body">
                            <div class="row g-2 align-items-end">
                                <div class="col-md-2">
                                    <label class="form-label small">Type</label>
                                    <select class="form-select form-select-sm" id="goldInvTxType">
                                        <option value="buy">Buy</option>
                                        <option value="sell">Sell</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small">Date</label>
                                    <input type="date" class="form-control form-control-sm" id="goldInvTxDate"
                                           value="${new Date().toISOString().split('T')[0]}">
                                </div>
                                <div class="col-md-1">
                                    <label class="form-label small">Qty (g)</label>
                                    <input type="number" class="form-control form-control-sm" id="goldInvTxQty"
                                           step="0.001" min="0" placeholder="0" oninput="calcGoldInvAmount()">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small">Rate/g</label>
                                    <input type="number" class="form-control form-control-sm" id="goldInvTxRate"
                                           step="0.01" min="0" placeholder="0" oninput="calcGoldInvAmount()">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small">Amount</label>
                                    <input type="number" class="form-control form-control-sm" id="goldInvTxAmount"
                                           step="0.01" min="0" placeholder="0.00">
                                </div>
                                <div class="col-md-3">
                                    <div class="row g-1">
                                        <div class="col-7">
                                            <label class="form-label small">Narration</label>
                                            <input type="text" class="form-control form-control-sm" id="goldInvTxNarration" placeholder="Note">
                                        </div>
                                        <div class="col-5">
                                            <label class="form-label small">&nbsp;</label>
                                            <button class="btn btn-sm btn-warning w-100" onclick="saveGoldInvTransaction()">
                                                <i class="bi bi-check-lg"></i> Save
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Transaction Table -->
                    <div class="card shadow-sm mb-3">
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover table-sm mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Date</th>
                                            <th>Type</th>
                                            <th class="text-end">Qty (g)</th>
                                            <th class="text-end">Rate/g</th>
                                            <th class="text-end">Amount</th>
                                            <th>Narration</th>
                                            <th class="text-end">Running Qty</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody id="goldInvTxBody">
                                        <tr><td colspan="8" class="text-center text-muted py-3">Loading...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Delete Lot -->
                    <div class="text-end">
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteGoldLotInv(goldSelectedAssetId)">
                            <i class="bi bi-trash"></i> Delete Lot
                        </button>
                    </div>
                </div>
            </div>`;
        }

        function calcGoldInvAmount() {
            const qty = parseFloat(document.getElementById('goldInvTxQty').value) || 0;
            const rate = parseFloat(document.getElementById('goldInvTxRate').value) || 0;
            if (qty > 0 && rate > 0) {
                document.getElementById('goldInvTxAmount').value = (qty * rate).toFixed(2);
            }
        }

        function openGoldLot(assetId) {
            goldSelectedAssetId = assetId;
            const asset = manualAssets.find(a => a.id === assetId);
            if (!asset) return;

            document.getElementById('goldInvCardGrid').style.display = 'none';
            document.getElementById('goldInvTxDetail').style.display = '';
            document.getElementById('goldInvLotName').textContent = asset.name;
            document.getElementById('goldInvLotBalance').textContent = formatCurrency(asset.calculated_value || asset.current_value || 0);
            document.getElementById('goldInvLotQty').textContent = `${parseFloat(asset.units || 0).toFixed(3)}g`;

            loadGoldInvTransactions(assetId);
            loadGoldInvPriceHistory(assetId);
        }

        function closeGoldLot() {
            goldSelectedAssetId = null;
            calculateAndDisplayTotals();
            buildAssetTabs();
            // Activate the Gold tab
            const goldBtn = document.querySelector('button[data-bs-target="#gold-tab"]');
            if (goldBtn) {
                const activeBtn = document.querySelector('#assetTypeTabs .nav-link.active');
                if (activeBtn) activeBtn.classList.remove('active');
                const activePane = document.querySelector('#assetTypeContent .tab-pane.show.active');
                if (activePane) activePane.classList.remove('show', 'active');
                goldBtn.classList.add('active');
                const pane = document.getElementById('gold-tab');
                if (pane) pane.classList.add('show', 'active');
            }
            loadXirrData();
        }

        async function loadGoldInvTransactions(assetId) {
            const tbody = document.getElementById('goldInvTxBody');
            if (!tbody) return;

            try {
                const res = await fetch(`/api/manual-assets/${assetId}/transactions`);
                const txs = await res.json();

                if (txs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-3">No transactions yet</td></tr>';
                    return;
                }

                tbody.innerHTML = txs.map(tx => {
                    const badgeClass = tx.tx_type === 'buy' ? 'gold-badge-buy' : 'gold-badge-sell';
                    const qty = tx.quantity ? parseFloat(tx.quantity).toFixed(3) : '-';
                    const rate = tx.rate ? formatCurrency(tx.rate) : '-';
                    const runQty = parseFloat(tx.running_quantity).toFixed(3);
                    return `<tr>
                        <td>${tx.tx_date}</td>
                        <td><span class="badge ${badgeClass}">${tx.tx_type}</span></td>
                        <td class="text-end">${qty}</td>
                        <td class="text-end mask-amount">${rate}</td>
                        <td class="text-end mask-amount">${formatCurrency(tx.amount)}</td>
                        <td class="text-muted">${tx.narration || '-'}</td>
                        <td class="text-end fw-bold">${runQty} g</td>
                        <td class="text-end">
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteGoldInvTransaction(${tx.id})" title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>`;
                }).join('');
            } catch (e) {
                console.error('Failed to load gold transactions:', e);
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-danger py-3">Failed to load transactions</td></tr>';
            }
        }

        async function saveGoldInvTransaction() {
            if (!goldSelectedAssetId) return;

            const txType = document.getElementById('goldInvTxType').value;
            const txDate = document.getElementById('goldInvTxDate').value;
            const qty = parseFloat(document.getElementById('goldInvTxQty').value);
            const rate = parseFloat(document.getElementById('goldInvTxRate').value);
            const amount = parseFloat(document.getElementById('goldInvTxAmount').value);
            const narration = document.getElementById('goldInvTxNarration').value.trim();

            if (!txDate || !qty || qty <= 0 || !amount || amount <= 0) {
                alert('Please enter a valid date, quantity, and amount.');
                return;
            }

            try {
                const res = await fetch(`/api/manual-assets/${goldSelectedAssetId}/transactions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tx_type: txType, tx_date: txDate, amount, narration, quantity: qty, rate: rate || null })
                });
                const result = await res.json();
                if (result.error) { alert('Error: ' + result.error); return; }

                document.getElementById('goldInvTxQty').value = '';
                document.getElementById('goldInvTxRate').value = '';
                document.getElementById('goldInvTxAmount').value = '';
                document.getElementById('goldInvTxNarration').value = '';

                await refreshGoldAssetData();
                loadGoldInvTransactions(goldSelectedAssetId);
            } catch (e) {
                alert('Failed to save transaction: ' + e.message);
            }
        }

        async function deleteGoldInvTransaction(txId) {
            if (!confirm('Delete this transaction?')) return;

            try {
                const res = await fetch(`/api/manual-assets/transactions/${txId}`, { method: 'DELETE' });
                const result = await res.json();
                if (result.error) { alert('Error: ' + result.error); return; }

                await refreshGoldAssetData();
                loadGoldInvTransactions(goldSelectedAssetId);
            } catch (e) {
                alert('Failed to delete transaction: ' + e.message);
            }
        }

        async function deleteGoldLotInv(assetId) {
            if (!confirm('Delete this gold lot and all its transactions? This cannot be undone.')) return;

            try {
                const res = await fetch(`/api/manual-assets/${assetId}`, { method: 'DELETE' });
                const result = await res.json();
                if (result.error) { alert('Error: ' + result.error); return; }

                goldSelectedAssetId = null;
                await loadData();
            } catch (e) {
                alert('Failed to delete lot: ' + e.message);
            }
        }

        async function refreshGoldAssetData() {
            try {
                const assetsRes = await fetch(`/api/manual-assets?investor_id=${investorId}`);
                manualAssets = await assetsRes.json();
            } catch (e) { /* keep existing */ }

            const asset = manualAssets.find(a => a.id === goldSelectedAssetId);
            if (asset) {
                const balEl = document.getElementById('goldInvLotBalance');
                if (balEl) balEl.textContent = formatCurrency(asset.calculated_value || asset.current_value || 0);
                const qtyEl = document.getElementById('goldInvLotQty');
                if (qtyEl) qtyEl.textContent = `${parseFloat(asset.units || 0).toFixed(3)}g`;
                updateGoldInvPriceDisplay(asset);
            }

            calculateAndDisplayTotals();
        }

        function updateGoldInvPriceDisplay(asset) {
            const priceEl = document.getElementById('goldInvCurrentPrice');
            const dateEl = document.getElementById('goldInvPriceDate');
            if (!priceEl) return;

            if (asset.current_nav) {
                priceEl.textContent = formatCurrency(asset.current_nav);
                dateEl.textContent = '';
            } else {
                priceEl.innerHTML = '<span class="text-muted fst-italic">No price set — showing cost basis</span>';
                dateEl.textContent = '';
            }
        }

        async function loadGoldInvPriceHistory(assetId) {
            const tbody = document.getElementById('goldInvPriceHistoryBody');
            if (!tbody) return;

            // Update the current price display
            const asset = manualAssets.find(a => a.id === assetId);
            if (asset) updateGoldInvPriceDisplay(asset);

            try {
                const res = await fetch(`/api/manual-assets/${assetId}/prices?limit=10`);
                const prices = await res.json();

                if (prices.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="2" class="text-center text-muted">No history</td></tr>';
                    return;
                }

                // Update price date display from latest entry
                const dateEl = document.getElementById('goldInvPriceDate');
                if (dateEl && prices.length > 0) {
                    dateEl.textContent = `(as of ${prices[0].price_date})`;
                }

                tbody.innerHTML = prices.map(p => `<tr>
                    <td>${p.price_date}</td>
                    <td class="text-end">${formatCurrency(p.price_per_unit)}</td>
                </tr>`).join('');
            } catch (e) {
                console.error('Failed to load price history:', e);
            }
        }

        async function saveGoldInvPrice() {
            if (!goldSelectedAssetId) return;

            const priceDate = document.getElementById('goldInvPriceDateInput').value;
            const pricePerUnit = parseFloat(document.getElementById('goldInvPriceInput').value);

            if (!priceDate) { alert('Please enter a date.'); return; }
            if (!pricePerUnit || pricePerUnit <= 0) { alert('Please enter a valid price.'); return; }

            try {
                const res = await fetch(`/api/manual-assets/${goldSelectedAssetId}/prices`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ price_date: priceDate, price_per_unit: pricePerUnit })
                });
                const result = await res.json();
                if (result.error) { alert('Error: ' + result.error); return; }

                document.getElementById('goldInvPriceInput').value = '';
                await refreshGoldAssetData();
                loadGoldInvPriceHistory(goldSelectedAssetId);
            } catch (e) {
                alert('Failed to save price: ' + e.message);
            }
        }

        function initializeSubTabs() {
            // MF Holdings display
            displayHoldings(mfHoldings);
            displayTransactions(mfTransactions);
            populateTxFilters(mfTransactions);

            // Search listeners
            const holdingsSearch = document.getElementById('holdingsSearch');
            if (holdingsSearch) holdingsSearch.addEventListener('input', () => displayHoldings(mfHoldings));

            const txTypeFilter = document.getElementById('txTypeFilter');
            if (txTypeFilter) txTypeFilter.addEventListener('change', () => displayTransactions(mfTransactions));

            const txSearch = document.getElementById('txSearch');
            if (txSearch) txSearch.addEventListener('input', () => displayTransactions(mfTransactions));
        }

        function getHoldingValue(h) {
            return (h.current_nav && h.current_nav > 0) ? (h.current_value_live || h.current_value) : (h.current_value || 0);
        }

        function displayHoldings(holdings) {
            const grid = document.getElementById('holdingsGrid');
            if (!grid) return;

            const searchEl = document.getElementById('holdingsSearch');
            const search = searchEl ? searchEl.value.toLowerCase() : '';

            let filtered = holdings;
            if (search) {
                filtered = holdings.filter(h =>
                    (h.scheme_name || '').toLowerCase().includes(search) ||
                    (h.folio_number || '').toLowerCase().includes(search) ||
                    (h.amc || '').toLowerCase().includes(search)
                );
            }

            // Category labels and styling
            const catLabels = {equity: 'Equity', debt: 'Debt', hybrid: 'Hybrid', gold_commodity: 'Gold / Commodity'};
            const catIcons = {equity: 'bi-graph-up-arrow', debt: 'bi-shield-check', hybrid: 'bi-intersect', gold_commodity: 'bi-gem'};
            const catColors = {equity: '#1d4ed8', debt: '#15803d', hybrid: '#7c3aed', gold_commodity: '#b45309'};

            // Group by fund_category
            const grouped = {};
            filtered.forEach(h => {
                const cat = h.fund_category || '_uncategorized';
                if (!grouped[cat]) grouped[cat] = [];
                grouped[cat].push(h);
            });

            // Sort: known categories first (in defined order), uncategorized last
            const catOrder = ['equity', 'debt', 'hybrid', 'gold_commodity', '_uncategorized'];
            const sortedKeys = Object.keys(grouped).sort((a, b) => {
                const ai = catOrder.indexOf(a); const bi = catOrder.indexOf(b);
                return (ai === -1 ? 999 : ai) - (bi === -1 ? 999 : bi);
            });

            let html = '';
            sortedKeys.forEach((cat, catIdx) => {
                const catHoldings = grouped[cat];
                const catTotal = catHoldings.reduce((sum, h) => sum + getHoldingValue(h), 0);
                const catInvested = catHoldings.reduce((sum, h) => sum + (h.invested_amount || 0), 0);
                const catGain = catTotal - catInvested;
                const catGainPct = catInvested > 0 ? ((catGain / catInvested) * 100).toFixed(1) : '0.0';
                const catGainClass = catGain >= 0 ? 'positive' : 'negative';

                const label = catLabels[cat] || 'Uncategorized';
                const icon = catIcons[cat] || 'bi-question-circle';
                const color = catColors[cat] || '#6c757d';

                // Count unique ISINs in this category
                const uniqueIsins = new Set(catHoldings.map(h => h.isin || h.folio_id));

                const collapseId = `catCollapse_${cat}`;

                html += `
                <div class="col-12 mb-2">
                    <div class="card" style="border-left: 4px solid ${color}; background: #f9fafb; cursor:pointer;"
                         data-bs-toggle="collapse" data-bs-target="#${collapseId}" aria-expanded="true" aria-controls="${collapseId}">
                        <div class="card-body py-2 d-flex justify-content-between align-items-center">
                            <h6 class="mb-0" style="color:${color};"><i class="bi ${icon}"></i> ${label}
                                <i class="bi bi-chevron-down ms-2 cat-chevron" style="font-size:0.75rem; transition:transform 0.2s;"></i>
                            </h6>
                            <div class="d-flex align-items-center gap-3">
                                <span class="${catGainClass} mask-amount" style="font-size:0.8rem;">${catGain >= 0 ? '+' : ''}${formatCurrency(catGain)} (${catGain >= 0 ? '+' : ''}${catGainPct}%)</span>
                                <span class="badge bg-primary">${uniqueIsins.size} scheme${uniqueIsins.size !== 1 ? 's' : ''} | <span class="mask-amount">${formatCurrency(catTotal)}</span></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-12">
                    <div class="collapse show" id="${collapseId}">
                        <div class="row">`;

                // Sub-group by ISIN within category
                const byIsin = {};
                catHoldings.forEach(h => {
                    const key = h.isin || `_no_isin_${h.folio_id}`;
                    if (!byIsin[key]) byIsin[key] = [];
                    byIsin[key].push(h);
                });

                // Sort ISIN groups by total value descending
                const sortedIsins = Object.keys(byIsin).sort((a, b) => {
                    const valA = byIsin[a].reduce((s, h) => s + getHoldingValue(h), 0);
                    const valB = byIsin[b].reduce((s, h) => s + getHoldingValue(h), 0);
                    return valB - valA;
                });

                sortedIsins.forEach(isinKey => {
                    const isinHoldings = byIsin[isinKey];

                    if (isinHoldings.length > 1) {
                        // Multiple folios for same ISIN — show aggregate header
                        const isinTotal = isinHoldings.reduce((s, h) => s + getHoldingValue(h), 0);
                        const isinInvested = isinHoldings.reduce((s, h) => s + (h.invested_amount || 0), 0);
                        const isinGain = isinTotal - isinInvested;
                        const isinGainPct = isinInvested > 0 ? ((isinGain / isinInvested) * 100).toFixed(1) : '0.0';
                        const isinGainClass = isinGain >= 0 ? 'positive' : 'negative';
                        const totalUnits = isinHoldings.reduce((s, h) => s + (h.units || 0), 0);
                        const schemeName = isinHoldings[0].scheme_name || '';
                        const isin = isinHoldings[0].isin || '';
                        const hasLiveNav = isinHoldings[0].current_nav && isinHoldings[0].current_nav > 0;
                        const navDisplay = hasLiveNav ? isinHoldings[0].current_nav : (isinHoldings[0].nav || 0);

                        html += `
                        <div class="col-12 mb-2">
                            <div class="card shadow-sm" style="border-left: 3px solid #667eea; background: #fff;">
                                <div class="card-body py-2">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div style="flex:1;">
                                            <h6 class="mb-0" style="font-size:0.9rem;">${truncate(schemeName, 65)}</h6>
                                            <small class="text-muted">${isin} &middot; ${isinHoldings.length} folios &middot; ${totalUnits.toFixed(3)} units &middot; NAV: ${navDisplay.toFixed(4)}</small>
                                        </div>
                                        <div class="text-end">
                                            <div class="holding-value mask-amount" style="font-size:1.1rem;">
                                                ${formatCurrency(isinTotal)}
                                                ${hasLiveNav ? '<span class="badge bg-success ms-1" style="font-size:0.55rem;">LIVE</span>' : ''}
                                            </div>
                                            <div class="small">
                                                <span class="${isinGainClass} mask-amount">${isinGain >= 0 ? '+' : ''}${formatCurrency(isinGain)} (${isinGain >= 0 ? '+' : ''}${isinGainPct}%)</span>
                                                <span class="isin-xirr-badge" data-isin="${isin}" style="margin-left:4px;"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>`;

                        isinHoldings.forEach(h => {
                            html += renderHoldingCard(h);
                        });
                    } else {
                        // Single folio for this ISIN — render directly
                        html += renderHoldingCard(isinHoldings[0]);
                    }
                });

                html += `
                        </div>
                    </div>
                </div>`;
            });

            grid.innerHTML = html || '<div class="col-12 text-center text-muted py-4">No holdings found</div>';
        }

        function renderHoldingCard(h) {
            const hasLiveNav = h.current_nav && h.current_nav > 0;
            const displayValue = hasLiveNav ? (h.current_value_live || h.current_value) : h.current_value;
            const invested = h.invested_amount || 0;
            const gain = displayValue - invested;
            const gainPct = invested > 0 ? ((gain / invested) * 100).toFixed(1) : 0;
            const gainClass = gain >= 0 ? 'positive' : 'negative';

            return `
            <div class="col-md-6 mb-3">
                <div class="card holding-card h-100" onclick="window.location='/folio/${h.folio_id}'">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <h6 class="card-title mb-1" style="flex:1;">${truncate(h.scheme_name, 50)}</h6>
                            <div class="holding-value text-end mask-amount">
                                ${formatCurrency(displayValue || 0)}
                                ${hasLiveNav ? '<span class="badge bg-success ms-1" style="font-size:0.6rem;">LIVE</span>' : ''}
                            </div>
                        </div>
                        <div class="d-flex justify-content-between small mb-2">
                            <span class="text-muted mask-amount">Invested: ${formatCurrency(invested)}</span>
                            <span>
                                <span class="${gainClass} mask-amount">${gain >= 0 ? '+' : ''}${formatCurrency(gain)} (${gain >= 0 ? '+' : ''}${gainPct}%)</span>
                                <span class="folio-xirr-badge" data-folio-id="${h.folio_id}" style="margin-left:6px;font-size:0.7rem;"></span>
                            </span>
                        </div>
                        <hr class="my-2">
                        <div class="row small">
                            <div class="col-4"><strong>Folio:</strong><br><code>${h.folio_number}</code></div>
                            <div class="col-4"><strong>Units:</strong><br>${(h.units || 0).toFixed(3)}</div>
                            <div class="col-4"><strong>NAV:</strong><br>${(hasLiveNav ? h.current_nav : h.nav || 0).toFixed(4)}</div>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        function displayTransactions(transactions) {
            const tbody = document.getElementById('transactionsBody');
            if (!tbody) return;

            const typeFilterEl = document.getElementById('txTypeFilter');
            const searchEl = document.getElementById('txSearch');
            const typeFilter = typeFilterEl ? typeFilterEl.value : '';
            const search = searchEl ? searchEl.value.toLowerCase() : '';

            let filtered = transactions;
            if (typeFilter) filtered = filtered.filter(t => t.tx_type === typeFilter);
            if (search) filtered = filtered.filter(t => (t.scheme_name || '').toLowerCase().includes(search));

            tbody.innerHTML = filtered.slice(0, 500).map(t => `
                <tr>
                    <td>${t.tx_date}</td>
                    <td><span class="badge badge-${t.tx_type}">${t.tx_type}</span></td>
                    <td title="${t.scheme_name}">${truncate(t.scheme_name, 35)}</td>
                    <td><code>${t.folio_number}</code></td>
                    <td class="text-end ${(t.amount || 0) < 0 ? 'negative' : ''} mask-amount">${t.amount ? formatCurrency(t.amount) : '-'}</td>
                    <td class="text-end ${(t.units || 0) < 0 ? 'negative' : 'positive'}">${(t.units || 0).toFixed(3)}</td>
                    <td class="text-end">${t.nav ? t.nav.toFixed(4) : '-'}</td>
                </tr>
            `).join('');

            const txCountEl = document.getElementById('txCount');
            if (txCountEl) txCountEl.textContent = filtered.length;
        }

        function populateTxFilters(transactions) {
            const typeFilter = document.getElementById('txTypeFilter');
            if (!typeFilter) return;
            const types = [...new Set(transactions.map(t => t.tx_type))].sort();
            typeFilter.innerHTML = '<option value="">All Types</option>' + types.map(t => `<option value="${t}">${t}</option>`).join('');
        }

        async function loadPortfolioHistory() {
            try {
                const res = await fetch(`/api/investors/${investorId}/portfolio-history`);
                const history = await res.json();

                const emptyEl = document.getElementById('historyEmpty');
                const chartEl = document.getElementById('portfolioChart');
                const tbody = document.getElementById('historyTableBody');

                if (history.length === 0) {
                    if (emptyEl) emptyEl.style.display = 'block';
                    if (chartEl) chartEl.style.display = 'none';
                    if (tbody) tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No snapshots yet</td></tr>';
                    return;
                }

                if (emptyEl) emptyEl.style.display = 'none';
                if (chartEl) chartEl.style.display = 'block';

                // Render chart
                const ctx = chartEl.getContext('2d');
                if (portfolioChart) portfolioChart.destroy();
                portfolioChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: history.map(h => h.snapshot_date),
                        datasets: [
                            { label: 'Portfolio Value', data: history.map(h => h.total_value), borderColor: '#28a745', backgroundColor: 'rgba(40,167,69,0.1)', fill: true, tension: 0.3 },
                            { label: 'Invested', data: history.map(h => h.total_invested), borderColor: '#6c757d', borderDash: [5, 5], fill: false, tension: 0.3 }
                        ]
                    },
                    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: false, ticks: { callback: v => '₹' + (v/100000).toFixed(1) + 'L' } } } }
                });

                // Table
                if (tbody) {
                    tbody.innerHTML = history.slice().reverse().map(h => {
                        const gain = h.total_value - h.total_invested;
                        const pct = h.total_invested > 0 ? ((gain / h.total_invested) * 100).toFixed(1) : 0;
                        const cls = gain >= 0 ? 'positive' : 'negative';
                        return `<tr><td>${h.snapshot_date}</td><td class="text-end">${formatCurrency(h.total_value)}</td><td class="text-end">${formatCurrency(h.total_invested)}</td><td class="text-end ${cls}">${gain >= 0 ? '+' : ''}${formatCurrency(gain)}</td><td class="text-end ${cls}">${gain >= 0 ? '+' : ''}${pct}%</td></tr>`;
                    }).join('');
                }
            } catch (error) { console.error('Failed to load portfolio history:', error); }
        }

        async function loadAssetAllocation() {
            try {
                const res = await fetch(`/api/manual-assets/combined?investor_id=${investorId}`);
                const data = await res.json();

                // Remap combined response to match expected format
                const breakdown = {};
                let totalValue = data.total_value || 0;
                ['equity', 'debt', 'commodity', 'cash', 'others'].forEach(cls => {
                    breakdown[cls] = data.by_asset_class && data.by_asset_class[cls] ? data.by_asset_class[cls].total : 0;
                });
                data.breakdown = breakdown;
                data.total_value = totalValue;

                const emptyEl = document.getElementById('allocEmpty');
                const chartEl = document.getElementById('allocationChart');
                const tbody = document.getElementById('allocationTableBody');

                if (!data.breakdown || Object.keys(data.breakdown).length === 0 || data.total_value === 0) {
                    if (emptyEl) emptyEl.style.display = 'block';
                    if (chartEl) chartEl.style.display = 'none';
                    if (tbody) tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No allocation data</td></tr>';
                    return;
                }

                if (emptyEl) emptyEl.style.display = 'none';
                if (chartEl) chartEl.style.display = 'block';

                const assetClasses = ['equity', 'debt', 'commodity', 'cash', 'others'];
                const colors = { equity: '#28a745', debt: '#17a2b8', commodity: '#ffc107', cash: '#6c757d', others: '#6f42c1' };
                const labels = { equity: 'Equity', debt: 'Debt', commodity: 'Commodity', cash: 'Cash', others: 'Others' };

                // Table
                if (tbody) {
                    let tableHtml = '';
                    assetClasses.forEach(asset => {
                        const value = data.breakdown[asset] || 0;
                        const pct = data.total_value > 0 ? (value / data.total_value * 100).toFixed(1) : 0;
                        tableHtml += `<tr><td><span class="badge" style="background-color:${colors[asset]}">${labels[asset]}</span></td><td class="text-end">${formatCurrency(value)}</td><td class="text-end">${pct}%</td><td><div class="progress" style="height:20px;"><div class="progress-bar" style="width:${Math.min(100,pct)}%;background-color:${colors[asset]};"></div></div></td></tr>`;
                    });
                    tableHtml += `<tr class="table-light"><td><strong>Total</strong></td><td class="text-end"><strong>${formatCurrency(data.total_value)}</strong></td><td class="text-end"><strong>100%</strong></td><td></td></tr>`;

                    // Market cap breakdown within equity
                    if (data.market_cap && data.market_cap.total_equity > 0) {
                        const mc = data.market_cap;
                        const capColors = { large: '#1e40af', mid: '#3730a3', small: '#5b21b6' };
                        const hasCapData = mc.large.value > 0 || mc.mid.value > 0 || mc.small.value > 0;
                        if (hasCapData) {
                            tableHtml += `<tr><td colspan="4" style="background:#f0f4ff;"><strong style="font-size:0.8rem;color:#1e40af;"><i class="bi bi-graph-up-arrow"></i> Equity Market Cap Split</strong> <small class="text-muted">(of ${formatCurrency(mc.total_equity)} equity)</small></td></tr>`;
                            [{key:'large',label:'Large Cap'},{key:'mid',label:'Mid Cap'},{key:'small',label:'Small Cap'}].forEach(cap => {
                                const val = mc[cap.key].value || 0;
                                const pctOfEq = mc[cap.key].pct || 0;
                                tableHtml += `<tr><td style="padding-left:2rem;"><span class="badge" style="background-color:${capColors[cap.key]};font-size:0.7rem;">${cap.label}</span></td><td class="text-end">${formatCurrency(val)}</td><td class="text-end">${pctOfEq.toFixed(1)}%</td><td><div class="progress" style="height:14px;"><div class="progress-bar" style="width:${Math.min(100,pctOfEq)}%;background-color:${capColors[cap.key]};"></div></div></td></tr>`;
                            });
                        }
                    }

                    tbody.innerHTML = tableHtml;
                }

                // Chart
                const nonZero = assetClasses.filter(a => (data.breakdown[a] || 0) > 0);
                if (nonZero.length > 0 && chartEl) {
                    const ctx = chartEl.getContext('2d');
                    if (allocationChart) allocationChart.destroy();
                    allocationChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: nonZero.map(a => labels[a]),
                            datasets: [{ data: nonZero.map(a => data.breakdown[a] || 0), backgroundColor: nonZero.map(a => colors[a]), borderWidth: 2, borderColor: '#fff' }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
                    });
                }
            } catch (error) { console.error('Failed to load asset allocation:', error); }
        }

        async function loadNavStatus() {
            try {
                const res = await fetch('/api/nav/status');
                const data = await res.json();
                document.getElementById('navLastUpdate').textContent = data.last_update || 'Never';
            } catch (error) { console.error('Failed to load NAV status:', error); }
        }

        async function refreshNAV() {
            const btn = document.getElementById('refreshNavBtn');
            const icon = document.getElementById('refreshIcon');
            btn.disabled = true;
            icon.classList.add('spinning');

            try {
                const res = await fetch('/api/nav/refresh', { method: 'POST' });
                const result = await res.json();
                if (result.error) {
                    alert('Error: ' + result.error);
                } else {
                    await loadData();
                    alert('NAV refreshed successfully!');
                }
            } catch (error) { alert('Failed to refresh NAV: ' + error.message); }
            finally { btn.disabled = false; icon.classList.remove('spinning'); }
        }

        // Edit investor
        async function openEditInvestorModal() {
            document.getElementById('editInvestorName').value = investorData?.name || '';
            document.getElementById('editInvestorEmail').value = investorData?.email || '';
            document.getElementById('editInvestorMobile').value = investorData?.mobile || '';
            new bootstrap.Modal(document.getElementById('editInvestorModal')).show();
        }

        async function saveInvestor() {
            const name = document.getElementById('editInvestorName').value.trim();
            const email = document.getElementById('editInvestorEmail').value.trim();
            const mobile = document.getElementById('editInvestorMobile').value.trim();
            if (!name) { alert('Name is required'); return; }

            try {
                const res = await fetch(`/api/investors/${investorId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email, mobile })
                });
                const result = await res.json();
                if (result.success) {
                    bootstrap.Modal.getInstance(document.getElementById('editInvestorModal')).hide();
                    document.getElementById('investorName').textContent = name;
                    investorData.name = name;
                } else { alert('Failed: ' + (result.error || 'Unknown error')); }
            } catch (error) { alert('Failed: ' + error.message); }
        }

        // Utility functions
        function formatCurrency(value) {
            return new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: 0 }).format(value);
        }
        function formatCurrencyShort(value) {
            if (value >= 10000000) return '₹' + (value / 10000000).toFixed(1) + 'Cr';
            if (value >= 100000) return '₹' + (value / 100000).toFixed(1) + 'L';
            if (value >= 1000) return '₹' + (value / 1000).toFixed(1) + 'K';
            return '₹' + value;
        }
        function truncate(str, len) { return str && str.length > len ? str.substring(0, len) + '...' : str || '-'; }

        // Hash-based tab activation (e.g. /investor/5#mf-tab)
        // Called after buildAssetTabs() so the DOM elements exist.
        function activateHashTab() {
            const hash = window.location.hash; // e.g. "#mf-tab"
            if (!hash) return;

            const tabBtn = document.querySelector(`button[data-bs-target="${hash}"]`);
            if (!tabBtn) return;

            // Deactivate current active tab + pane
            const activeBtn = document.querySelector('#assetTypeTabs .nav-link.active');
            if (activeBtn) activeBtn.classList.remove('active');
            const activePane = document.querySelector('#assetTypeContent .tab-pane.show.active');
            if (activePane) activePane.classList.remove('show', 'active');

            // Activate target tab + pane
            tabBtn.classList.add('active');
            const pane = document.querySelector(hash);
            if (pane) pane.classList.add('show', 'active');
        }

        // ==================== Performance Benchmark ====================

        let performanceChart = null;
        let savedBenchmarks = [];
        let perfPeriod = '1Y';
        let perfData = null; // cached response from performance API
        let benchmarkSearchTimer = null;

        const BENCHMARK_COLORS = ['#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c', '#e67e22'];

        function getPerfStartDate() {
            if (perfPeriod === 'ALL') return null;
            const now = new Date();
            // Use proper calendar subtraction (handles leap years correctly)
            const yearMap = { '1Y': 1, '2Y': 2, '3Y': 3, '5Y': 5, '7Y': 7 };
            const monthMap = { '1M': 1, '3M': 3, '6M': 6 };
            if (yearMap[perfPeriod]) {
                now.setFullYear(now.getFullYear() - yearMap[perfPeriod]);
            } else if (monthMap[perfPeriod]) {
                now.setMonth(now.getMonth() - monthMap[perfPeriod]);
            } else if (perfPeriod === '1W') {
                now.setDate(now.getDate() - 7);
            } else {
                now.setFullYear(now.getFullYear() - 1);
            }
            return now.toISOString().split('T')[0];
        }

        function downloadCashflows() {
            const category = document.getElementById('perfCategorySelect')?.value || '';
            const startDate = getPerfStartDate();
            let url = `/api/investors/${investorId}/performance/export?`;
            const params = [];
            if (category) params.push(`category=${encodeURIComponent(category)}`);
            if (startDate) params.push(`start_date=${startDate}`);
            window.location.href = url + params.join('&');
        }

        function setPerfPeriod(period) {
            perfPeriod = period;
            document.querySelectorAll('#perfTimePills .btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.trim() === period);
            });
            updatePerformanceChart();
        }

        async function loadPerformance() {
            await fetchSavedBenchmarks();
            await updatePerformanceChart();
        }

        async function fetchSavedBenchmarks() {
            try {
                const res = await fetch(`/api/investors/${investorId}/benchmarks`);
                savedBenchmarks = await res.json();
                renderBenchmarkPills();
            } catch(e) { console.error('Failed to fetch benchmarks:', e); }
        }

        function renderBenchmarkPills() {
            const container = document.getElementById('benchmarkPills');
            if (!container) return;
            container.innerHTML = savedBenchmarks.map((b, i) => {
                const color = BENCHMARK_COLORS[i % BENCHMARK_COLORS.length];
                return `<span class="badge rounded-pill d-flex align-items-center gap-1" style="background:${color}; font-size:0.8rem; padding:0.35em 0.6em;">
                    ${b.scheme_name.length > 40 ? b.scheme_name.substring(0, 40) + '...' : b.scheme_name}
                    <i class="bi bi-x-circle" style="cursor:pointer;" onclick="removeBenchmark(${b.id}, event)"></i>
                </span>`;
            }).join('');
        }

        async function updatePerformanceChart() {
            const category = document.getElementById('perfCategorySelect')?.value || '';
            const startDate = getPerfStartDate();

            // Show loading spinner
            const loading = document.getElementById('perfLoading');
            const canvas = document.getElementById('performanceChart');
            const empty = document.getElementById('perfEmpty');
            if (loading) loading.style.display = '';

            // Single API call to get everything
            let url = `/api/investors/${investorId}/performance?`;
            const params = [];
            if (category) params.push(`category=${encodeURIComponent(category)}`);
            if (startDate) params.push(`start_date=${startDate}`);
            url += params.join('&');

            try {
                const res = await fetch(url);
                perfData = await res.json();
            } catch(e) {
                console.error('Failed to fetch performance data:', e);
                perfData = null;
            }

            if (loading) loading.style.display = 'none';

            if (!perfData || perfData.error) {
                if (canvas) canvas.style.display = 'none';
                if (empty) {
                    empty.style.display = '';
                    if (perfData?.error) {
                        empty.innerHTML = `<i class="bi bi-exclamation-triangle" style="font-size:3rem;color:#ccc;"></i>
                            <p class="text-muted mt-2">${perfData.error}</p>`;
                    }
                }
                return;
            }

            renderPerformanceChart(perfData, category);
            renderMetricsCards(perfData);
            renderReturnsTable(perfData);
            loadMultiPeriodReturns(category);
            loadAssetPerformance();
        }

        function renderPerformanceChart(data, category) {
            const canvas = document.getElementById('performanceChart');
            const empty = document.getElementById('perfEmpty');
            const pf = data.portfolio || {};
            const pf_ts = pf.timeseries || [];

            if (pf_ts.length === 0) {
                if (canvas) canvas.style.display = 'none';
                if (empty) {
                    empty.style.display = '';
                    empty.innerHTML = `<i class="bi bi-speedometer2" style="font-size:3rem;color:#ccc;"></i>
                        <p class="text-muted mt-2">No portfolio data for this period. Ensure holdings have AMFI codes mapped.</p>`;
                }
                return;
            }

            if (canvas) canvas.style.display = '';
            if (empty) empty.style.display = 'none';

            if (performanceChart) performanceChart.destroy();

            const dates = pf_ts.map(p => p.date);
            const datasets = [];

            // Portfolio dataset
            datasets.push({
                label: pf.name || 'My Portfolio',
                data: pf_ts.map(p => p.value),
                borderColor: '#667eea',
                backgroundColor: 'rgba(102,126,234,0.1)',
                fill: true,
                tension: 0.3,
                pointRadius: 0,
                pointHoverRadius: 4,
                borderWidth: 2.5,
                spanGaps: true
            });

            // User-added benchmark datasets
            const benchmarks = data.benchmarks || [];
            benchmarks.forEach((bm, i) => {
                const bmTs = bm.timeseries || [];
                if (bmTs.length === 0) return;
                const color = BENCHMARK_COLORS[i % BENCHMARK_COLORS.length];
                datasets.push({
                    label: bm.name.length > 50 ? bm.name.substring(0, 50) + '...' : bm.name,
                    data: bmTs.map(p => p.value),
                    borderColor: color,
                    backgroundColor: 'transparent',
                    borderDash: [6, 3],
                    fill: false,
                    tension: 0.3,
                    pointRadius: 0,
                    pointHoverRadius: 4,
                    borderWidth: 2,
                    spanGaps: true
                });
            });

            const ctx = canvas.getContext('2d');
            performanceChart = new Chart(ctx, {
                type: 'line',
                data: { labels: dates, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { position: 'bottom', labels: { boxWidth: 12, usePointStyle: true } },
                        tooltip: {
                            callbacks: {
                                label: function(ctx) {
                                    if (ctx.raw == null) return null;
                                    const val = ctx.raw.toFixed(1);
                                    const change = (ctx.raw - 100).toFixed(1);
                                    return `${ctx.dataset.label}: ${val} (${change >= 0 ? '+' : ''}${change}%)`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: { callback: v => v.toFixed(0) },
                            title: { display: true, text: 'Indexed Value (Base = 100)' }
                        },
                        x: { ticks: { maxTicksLimit: 12 } }
                    }
                }
            });
        }

        function formatMetric(val, suffix) {
            if (val === null || val === undefined) return '-';
            const cls = val >= 0 ? 'text-success' : 'text-danger';
            const sign = val >= 0 ? '+' : '';
            return `<span class="${cls}">${sign}${val.toFixed(1)}${suffix}</span>`;
        }

        function renderMetricsCards(data) {
            const row = document.getElementById('perfMetricsRow');
            if (!row) return;

            const pf = data.portfolio?.metrics || {};
            const bm = (data.benchmarks && data.benchmarks[0]?.metrics) || {};
            const alpha = data.alpha;

            const pfXirr = pf.xirr !== null && pf.xirr !== undefined ? pf.xirr : pf.cagr;
            // Benchmark shows CAGR (simple index return), not XIRR
            const bmReturn = bm.cagr !== null && bm.cagr !== undefined ? bm.cagr : null;

            const hasPfData = pfXirr !== null && pfXirr !== undefined;

            if (!hasPfData) {
                row.style.display = 'none';
                return;
            }

            row.style.display = '';

            document.getElementById('metricPortfolioXirr').innerHTML = formatMetric(pfXirr, '%');
            document.getElementById('metricBenchmarkXirr').innerHTML = data.benchmarks?.length
                ? formatMetric(bmReturn, '%') : '<span class="text-muted">Add a benchmark</span>';
            document.getElementById('metricAlpha').innerHTML = alpha !== null && alpha !== undefined
                ? formatMetric(alpha, '%') : '<span class="text-muted">-</span>';
            document.getElementById('metricVolatility').innerHTML = pf.volatility !== null ? `${pf.volatility.toFixed(1)}%` : '-';
            document.getElementById('metricMaxDrawdown').innerHTML = pf.max_drawdown !== null
                ? `<span class="text-danger">-${pf.max_drawdown.toFixed(1)}%</span>` : '-';
        }

        function renderReturnsTable(data) {
            const tbody = document.getElementById('perfReturnsBody');
            if (!tbody) return;

            const pf = data.portfolio || {};
            const pfm = pf.metrics || {};
            const benchmarks = data.benchmarks || [];

            function metricCell(val, suffix) {
                if (val === null || val === undefined) return '<td class="text-end">-</td>';
                const cls = val >= 0 ? 'text-success' : 'text-danger';
                const sign = val >= 0 ? '+' : '';
                return `<td class="text-end"><span class="${cls}">${sign}${val.toFixed(1)}${suffix}</span></td>`;
            }

            function plainCell(val, suffix) {
                if (val === null || val === undefined) return '<td class="text-end">-</td>';
                return `<td class="text-end">${val.toFixed(1)}${suffix}</td>`;
            }

            function ddCell(val) {
                if (val === null || val === undefined) return '<td class="text-end">-</td>';
                return `<td class="text-end"><span class="text-danger">-${val.toFixed(1)}%</span></td>`;
            }

            let rows = '';

            // Portfolio: XIRR (money-weighted return), Benchmark: CAGR (index return)
            function pfReturn(m) {
                return (m.xirr !== null && m.xirr !== undefined) ? m.xirr : m.cagr;
            }

            // Portfolio row — shows XIRR
            rows += `<tr>
                <td><strong><span style="color:#667eea;">&#9679;</span> ${pf.name || 'My Portfolio'}</strong></td>
                ${metricCell(pfm.absolute_return, '%')}
                ${metricCell(pfReturn(pfm), '%')}
                ${plainCell(pfm.volatility, '%')}
                ${ddCell(pfm.max_drawdown)}
            </tr>`;

            // Benchmark rows — show CAGR (simple index/fund return for the period)
            benchmarks.forEach((bm, i) => {
                const m = bm.metrics || {};
                const color = BENCHMARK_COLORS[i % BENCHMARK_COLORS.length];
                const bmCagr = (m.cagr !== null && m.cagr !== undefined) ? m.cagr : null;
                rows += `<tr>
                    <td><span style="color:${color};">&#9679;</span> ${bm.name.length > 40 ? bm.name.substring(0, 40) + '...' : bm.name}</td>
                    ${metricCell(m.absolute_return, '%')}
                    ${metricCell(bmCagr, '%')}
                    ${plainCell(m.volatility, '%')}
                    ${ddCell(m.max_drawdown)}
                </tr>`;
            });

            // Alpha row (vs first benchmark)
            if (data.alpha !== null && data.alpha !== undefined && benchmarks.length > 0) {
                const bm0 = benchmarks[0]?.metrics || {};
                const volDiff = (pfm.volatility != null && bm0.volatility != null)
                    ? pfm.volatility - bm0.volatility : null;
                const ddDiff = (pfm.max_drawdown != null && bm0.max_drawdown != null)
                    ? bm0.max_drawdown - pfm.max_drawdown : null;

                rows += `<tr class="table-light fw-bold">
                    <td>Alpha (vs ${benchmarks[0].name.length > 30 ? benchmarks[0].name.substring(0, 30) + '...' : benchmarks[0].name})</td>
                    <td class="text-end"></td>
                    ${metricCell(data.alpha, '%')}
                    ${volDiff !== null ? metricCell(volDiff * -1, '%') : '<td class="text-end">-</td>'}
                    ${ddDiff !== null ? metricCell(ddDiff, '%') : '<td class="text-end">-</td>'}
                </tr>`;
            }

            tbody.innerHTML = rows || '<tr><td colspan="5" class="text-center text-muted">No data yet. Add a benchmark using the + button above.</td></tr>';
        }

        // --- Multi-Period Returns ---

        async function loadMultiPeriodReturns(category) {
            const loading = document.getElementById('multiPeriodLoading');
            const table = document.getElementById('multiPeriodTable');
            const empty = document.getElementById('multiPeriodEmpty');
            if (!loading || !table) return;

            loading.style.display = '';
            table.style.display = 'none';
            if (empty) empty.style.display = 'none';

            let url = `/api/investors/${investorId}/performance/returns?`;
            if (category) url += `category=${encodeURIComponent(category)}`;

            try {
                const res = await fetch(url);
                const data = await res.json();
                loading.style.display = 'none';

                if (data.error || !data.portfolio) {
                    if (empty) {
                        empty.style.display = '';
                        empty.textContent = data.error || 'No returns data available';
                    }
                    return;
                }

                renderMultiPeriodTable(data);
                table.style.display = '';
            } catch(e) {
                console.error('Failed to load multi-period returns:', e);
                loading.style.display = 'none';
                if (empty) {
                    empty.style.display = '';
                    empty.textContent = 'Failed to load returns data';
                }
            }
        }

        function renderMultiPeriodTable(data) {
            const tbody = document.getElementById('multiPeriodBody');
            if (!tbody) return;

            const periods = data.periods || ['1Y', '2Y', '3Y', '5Y', 'ALL'];
            const periodLabels = {'1Y': '1Y', '2Y': '2Y', '3Y': '3Y', '5Y': '5Y', 'ALL': 'All Time'};
            const pf = data.portfolio || {};
            const pfReturns = pf.returns || {};
            const benchmarks = data.benchmarks || [];
            const alpha = data.alpha || {};

            function returnCell(val) {
                if (val === null || val === undefined) return '<td class="text-end text-muted">-</td>';
                const cls = val >= 0 ? 'text-success' : 'text-danger';
                const sign = val > 0 ? '+' : '';
                return `<td class="text-end"><span class="${cls} fw-semibold">${sign}${val.toFixed(2)}%</span></td>`;
            }

            let rows = '';

            // Portfolio row
            rows += `<tr>
                <td><strong><span style="color:#667eea;">&#9679;</span> ${pf.name || 'My Portfolio'}</strong>
                    <small class="text-muted d-block">XIRR</small></td>`;
            periods.forEach(p => { rows += returnCell(pfReturns[p]); });
            rows += '</tr>';

            // Benchmark rows
            benchmarks.forEach((bm, i) => {
                const bmReturns = bm.returns || {};
                const color = BENCHMARK_COLORS[i % BENCHMARK_COLORS.length];
                const name = bm.name.length > 35 ? bm.name.substring(0, 35) + '...' : bm.name;
                rows += `<tr>
                    <td><span style="color:${color};">&#9679;</span> ${name}
                        <small class="text-muted d-block">CAGR</small></td>`;
                periods.forEach(p => { rows += returnCell(bmReturns[p]); });
                rows += '</tr>';
            });

            // Alpha row (only if there are benchmarks)
            if (benchmarks.length > 0) {
                rows += '<tr class="table-light fw-bold"><td>Alpha</td>';
                periods.forEach(p => { rows += returnCell(alpha[p]); });
                rows += '</tr>';
            }

            tbody.innerHTML = rows || '<tr><td colspan="6" class="text-center text-muted">No data</td></tr>';
        }

        // --- Performance by Asset ---

        async function loadAssetPerformance() {
            const loading = document.getElementById('assetPerfLoading');
            const table = document.getElementById('assetPerfTable');
            const empty = document.getElementById('assetPerfEmpty');
            if (!loading || !table) return;

            loading.style.display = '';
            table.style.display = 'none';
            if (empty) empty.style.display = 'none';

            try {
                const res = await fetch(`/api/investors/${investorId}/xirr`);
                const data = await res.json();
                loading.style.display = 'none';

                const folios = (data.folios || []).filter(f => f.current_value && f.current_value > 0);
                if (folios.length === 0) {
                    if (empty) empty.style.display = '';
                    return;
                }

                renderAssetPerfTable(folios);
                table.style.display = '';
            } catch(e) {
                console.error('Failed to load asset performance:', e);
                loading.style.display = 'none';
                if (empty) {
                    empty.style.display = '';
                    empty.textContent = 'Failed to load fund data';
                }
            }
        }

        function renderAssetPerfTable(folios) {
            const tbody = document.getElementById('assetPerfBody');
            if (!tbody) return;

            // Sort by current_value descending
            folios.sort((a, b) => (b.current_value || 0) - (a.current_value || 0));

            // Check if any ISIN has multiple folios (to show folio numbers)
            const isinCount = {};
            folios.forEach(f => {
                const key = f.isin || f.folio_id;
                isinCount[key] = (isinCount[key] || 0) + 1;
            });

            let rows = '';
            folios.forEach(f => {
                const name = f.scheme_name || 'Unknown Fund';
                const displayName = name.length > 50 ? name.substring(0, 50) + '...' : name;
                const hasDuplicateIsin = isinCount[f.isin] > 1;
                const folioTag = hasDuplicateIsin
                    ? `<small class="text-muted d-block">Folio: ${f.folio_number || f.folio_id}</small>`
                    : '';

                // XIRR cell
                let xirrCell;
                if (f.xirr === null || f.xirr === undefined) {
                    xirrCell = '<td class="text-end text-muted">-</td>';
                } else {
                    const cls = f.xirr >= 0 ? 'text-success' : 'text-danger';
                    const sign = f.xirr > 0 ? '+' : '';
                    xirrCell = `<td class="text-end"><span class="${cls} fw-semibold">${sign}${f.xirr.toFixed(2)}%</span></td>`;
                }

                // Valuation cell
                const val = f.current_value || 0;
                const valFormatted = val.toLocaleString('en-IN', {maximumFractionDigits: 0});
                const valCell = `<td class="text-end fw-semibold">\u20b9${valFormatted}</td>`;

                rows += `<tr>
                    <td>${displayName}${folioTag}</td>
                    ${xirrCell}
                    ${valCell}
                </tr>`;
            });

            // Total row
            const totalVal = folios.reduce((s, f) => s + (f.current_value || 0), 0);
            const totalFormatted = totalVal.toLocaleString('en-IN', {maximumFractionDigits: 0});
            rows += `<tr class="table-light fw-bold">
                <td>Total</td>
                <td></td>
                <td class="text-end">\u20b9${totalFormatted}</td>
            </tr>`;

            tbody.innerHTML = rows;
        }

        // --- Benchmark search ---

        function openBenchmarkSearch() {
            document.getElementById('benchmarkSearchInput').value = '';
            document.getElementById('benchmarkSearchResults').innerHTML = '<p class="text-muted text-center">Type to search for index funds</p>';
            new bootstrap.Modal(document.getElementById('benchmarkSearchModal')).show();
            setTimeout(() => document.getElementById('benchmarkSearchInput').focus(), 300);
        }

        function debouncedBenchmarkSearch() {
            clearTimeout(benchmarkSearchTimer);
            benchmarkSearchTimer = setTimeout(searchBenchmarkFunds, 400);
        }

        async function searchBenchmarkFunds() {
            const q = document.getElementById('benchmarkSearchInput').value.trim();
            const results = document.getElementById('benchmarkSearchResults');
            const spinner = document.getElementById('benchmarkSearchSpinner');

            if (q.length < 2) {
                results.innerHTML = '<p class="text-muted text-center">Type at least 2 characters</p>';
                return;
            }

            spinner.style.display = '';
            results.innerHTML = '';

            try {
                const res = await fetch(`/api/mfapi/search?q=${encodeURIComponent(q)}`);
                const data = await res.json();
                spinner.style.display = 'none';

                if (data.error) {
                    results.innerHTML = `<p class="text-danger text-center">${data.error}</p>`;
                    return;
                }

                if (data.length === 0) {
                    results.innerHTML = '<p class="text-muted text-center">No funds found</p>';
                    return;
                }

                // Show up to 20 results
                const items = data.slice(0, 20);
                const alreadyAdded = new Set(savedBenchmarks.map(b => b.scheme_code));

                results.innerHTML = items.map(fund => {
                    const added = alreadyAdded.has(fund.schemeCode);
                    return `<div class="d-flex justify-content-between align-items-center p-2 border-bottom" style="cursor:${added ? 'default' : 'pointer'};"
                                ${added ? '' : `onclick="addBenchmarkFromSearch(${fund.schemeCode}, '${fund.schemeName.replace(/'/g, "\\'")}')"`}>
                        <div style="font-size:0.85rem;">${fund.schemeName}</div>
                        ${added
                            ? '<span class="badge bg-secondary">Added</span>'
                            : '<button class="btn btn-sm btn-outline-primary"><i class="bi bi-plus"></i></button>'}
                    </div>`;
                }).join('');
            } catch(e) {
                spinner.style.display = 'none';
                results.innerHTML = '<p class="text-danger text-center">Search failed</p>';
            }
        }

        async function addBenchmarkFromSearch(schemeCode, schemeName) {
            try {
                const res = await fetch(`/api/investors/${investorId}/benchmarks`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ scheme_code: schemeCode, scheme_name: schemeName })
                });
                await res.json();

                // Close modal and refresh
                bootstrap.Modal.getInstance(document.getElementById('benchmarkSearchModal'))?.hide();
                await fetchSavedBenchmarks();
                await updatePerformanceChart();
            } catch(e) { console.error('Failed to add benchmark:', e); }
        }

        async function removeBenchmark(benchmarkId, event) {
            event.stopPropagation();
            try {
                await fetch(`/api/investors/${investorId}/benchmarks/${benchmarkId}`, { method: 'DELETE' });
                await fetchSavedBenchmarks();
                await updatePerformanceChart();
            } catch(e) { console.error('Failed to remove benchmark:', e); }
        }

        // Initialize
        loadData();
    </script>
    {% include '_feature_request_widget.html' %}
<script>
// Auth: redirect to login on 401
const _origFetch = window.fetch;
window.fetch = function() {
    return _origFetch.apply(this, arguments).then(resp => {
        if (resp.status === 401) window.location.href = '/login';
        return resp;
    });
};
</script>
</body>
</html>
