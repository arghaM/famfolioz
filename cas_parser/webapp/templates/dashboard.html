<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Famfolio - Family Portfolio Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; margin: 0; }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.75rem 0;
            position: sticky;
            top: 0;
            z-index: 1030;
        }
        .header h1 { font-size: 1.4rem; margin-bottom: 0; }
        .header p { font-size: 0.8rem; }

        /* App layout */
        .app-layout {
            display: flex;
            min-height: calc(100vh - 60px);
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            min-width: 280px;
            background: white;
            border-right: 1px solid #e9ecef;
            display: flex;
            flex-direction: column;
            position: sticky;
            top: 60px;
            height: calc(100vh - 60px);
            overflow-y: auto;
        }
        .sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid #e9ecef;
        }
        .family-name-display {
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .family-name-display:hover .edit-hint {
            opacity: 1;
        }
        .edit-hint {
            opacity: 0;
            transition: opacity 0.2s;
            font-size: 0.75rem;
            color: #6c757d;
        }
        .family-name-input {
            font-size: 1.1rem;
            font-weight: 600;
            border: 1px solid #667eea;
            border-radius: 6px;
            padding: 0.25rem 0.5rem;
            width: 100%;
        }
        .member-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem 0;
        }
        .member-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-left: 3px solid transparent;
            transition: background 0.15s, border-color 0.15s;
            gap: 0.75rem;
        }
        .member-item:hover {
            background: #f8f9fa;
        }
        .member-item.active {
            background: #eef2ff;
            border-left-color: #667eea;
        }
        .member-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.85rem;
            color: white;
            flex-shrink: 0;
        }
        .member-info {
            flex: 1;
            min-width: 0;
        }
        .member-name {
            font-weight: 500;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .member-value {
            font-size: 0.8rem;
            color: #28a745;
            font-weight: 500;
        }

        /* Main content */
        .main-content {
            flex: 1;
            padding: 1.5rem;
            min-width: 0;
        }

        /* Alert styles (unchanged) */
        .alert-unmapped {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
        }
        .alert-nps-unmapped {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
        }
        .alert-alloc-review {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            color: #78350f;
            border: none;
        }
        .alert-fd-maturing {
            background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
            color: #333;
            border: none;
        }
        .alert-fd-matured {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
            color: white;
            border: none;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        body.mask-amounts .mask-amount {
            filter: blur(8px);
            user-select: none;
        }

        /* Family overview hero */
        .wealth-hero {
            text-align: center;
            padding: 2rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px;
            color: white;
            margin-bottom: 1.5rem;
        }
        .wealth-hero h2 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }
        .wealth-hero p {
            opacity: 0.85;
            margin-bottom: 0;
        }

        /* Summary cards row */
        .summary-card {
            background: white;
            border-radius: 12px;
            padding: 1.25rem;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        .summary-card h4 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        /* Member summary cards in family overview */
        .member-summary-card {
            background: white;
            border-radius: 12px;
            padding: 1.25rem;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        .member-summary-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.12);
        }

        /* Asset bar */
        .asset-bar {
            height: 6px;
            border-radius: 3px;
            overflow: hidden;
            display: flex;
            margin-top: 0.5rem;
        }
        .asset-bar .mf-segment { background: #667eea; }
        .asset-bar .nps-segment { background: #11998e; }
        .asset-bar .fd-segment { background: #fd7e14; }
        .asset-bar .other-segment { background: #6f42c1; }

        .badge-mf { background-color: #667eea; }
        .badge-nps { background-color: #11998e; }
        .badge-fd { background-color: #fd7e14; }

        .value-breakdown {
            display: flex;
            gap: 1rem;
            margin-top: 0.5rem;
        }
        .value-item {
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }
        .value-item small {
            font-size: 0.75rem;
        }

        /* Tree view */
        .tree-header {
            padding: 1.5rem;
            background: white;
            border-radius: 12px;
            margin-bottom: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        .tree-node {
            background: white;
            border-radius: 10px;
            margin-bottom: 0.75rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        .tree-node-header {
            display: flex;
            align-items: center;
            padding: 1rem 1.25rem;
            cursor: pointer;
            transition: background 0.15s;
            gap: 0.75rem;
        }
        .tree-node-header:hover {
            background: #f8f9fa;
        }
        .tree-node-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }
        .tree-node-info {
            flex: 1;
        }
        .tree-node-label {
            font-weight: 600;
            font-size: 0.95rem;
        }
        .tree-node-meta {
            font-size: 0.8rem;
            color: #6c757d;
        }
        .tree-node-value {
            font-weight: 600;
            font-size: 1.1rem;
            text-align: right;
        }
        .tree-node-arrow {
            color: #adb5bd;
            font-size: 1.2rem;
        }
        .tree-children {
            border-top: 1px solid #e9ecef;
            padding: 0.5rem 1rem 0.5rem 3.5rem;
            background: #fafbfc;
        }
        .tree-child-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
        }
        .tree-child-item:last-child { border-bottom: none; }
        .tree-child-item:hover { color: #667eea; }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
        }
        .empty-state i {
            font-size: 4rem;
            color: #dee2e6;
        }

        /* FD items in modals */
        .fd-item {
            padding: 0.75rem;
            border-bottom: 1px solid #eee;
        }
        .fd-item:last-child { border-bottom: none; }
        .fd-maturity-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .app-layout {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                min-width: 100%;
                position: relative;
                top: 0;
                height: auto;
                max-height: 300px;
                border-right: none;
                border-bottom: 1px solid #e9ecef;
            }
            .main-content {
                padding: 1rem;
            }
            .wealth-hero h2 {
                font-size: 1.8rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="container-fluid px-3">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1><i class="bi bi-house-heart"></i> Famfolio</h1>
                </div>
                <div class="d-flex align-items-center">
                    <button class="btn btn-outline-light btn-sm me-2" id="maskToggle" onclick="toggleMask()" title="Toggle amount visibility">
                        <i class="bi bi-eye" id="maskIcon"></i>
                    </button>
                    {% if current_user and current_user.role == 'admin' %}
                    <a href="/settings" class="btn btn-outline-light btn-sm me-2">
                        <i class="bi bi-gear"></i>
                    </a>
                    {% endif %}
                    <a href="/mutual-funds" class="btn btn-outline-light btn-sm me-2">
                        <i class="bi bi-bank"></i>
                    </a>
                    {% if current_user and current_user.role == 'admin' %}
                    <div class="dropdown">
                        <button class="btn btn-light btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="bi bi-cloud-arrow-up"></i> Upload
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="/upload"><i class="bi bi-file-earmark-pdf"></i> CAS PDF (Mutual Funds)</a></li>
                            <li><a class="dropdown-item" href="#" onclick="openNpsUpload()"><i class="bi bi-shield-check"></i> NPS Statement</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="openFdUpload()"><i class="bi bi-safe"></i> FD Statement (CSV)</a></li>
                        </ul>
                    </div>
                    {% endif %}
                    {% include '_auth_nav.html' %}
                </div>
            </div>
        </div>
    </div>

    <div class="app-layout">
        <!-- LEFT SIDEBAR -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div id="familyNameDisplay" class="family-name-display" onclick="editFamilyName()">
                    <i class="bi bi-people-fill" style="color: #667eea;"></i>
                    <span id="familyNameText">{{ family_name }}</span>
                    <span class="edit-hint"><i class="bi bi-pencil"></i></span>
                </div>
                <div id="familyNameEdit" style="display: none;">
                    <input type="text" class="family-name-input" id="familyNameInput"
                           onkeydown="if(event.key==='Enter')saveFamilyName();if(event.key==='Escape')cancelFamilyNameEdit();"
                           onblur="saveFamilyName()">
                </div>
                <button class="btn btn-outline-primary btn-sm w-100 mt-2" onclick="showAddMemberModal()">
                    <i class="bi bi-person-plus"></i> Add Member
                </button>
            </div>
            <div class="member-list" id="memberList">
                <!-- Family Overview + member items rendered by JS -->
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <div class="main-content">
            <!-- Alerts Container -->
            <div id="alertsContainer">
                <!-- Transaction Conflicts Alert -->
                <div id="conflictsAlert" class="alert alert-warning mb-3" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="bi bi-exclamation-triangle"></i>
                            <strong id="conflictCount">0</strong> transaction conflicts need to be resolved
                        </div>
                        <a href="/resolve-conflicts" class="btn btn-dark btn-sm">
                            <i class="bi bi-check2-square"></i> Resolve Now
                        </a>
                    </div>
                </div>

                <!-- Unmapped Folios Alert -->
                <div id="unmappedAlert" class="alert alert-unmapped mb-3" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="bi bi-exclamation-triangle"></i>
                            <strong id="unmappedCount">0</strong> mutual fund portfolios need to be mapped to an investor
                        </div>
                        <a href="/map-folios" class="btn btn-light btn-sm">
                            <i class="bi bi-link"></i> Map Folios
                        </a>
                    </div>
                </div>

                <!-- Unmapped NPS Alert -->
                <div id="unmappedNpsAlert" class="alert alert-nps-unmapped mb-3" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="bi bi-shield-check"></i>
                            <strong id="unmappedNpsCount">0</strong> NPS accounts need to be mapped to an investor
                        </div>
                        <button class="btn btn-light btn-sm" onclick="openNpsMappingModal()">
                            <i class="bi bi-link"></i> Map NPS
                        </button>
                    </div>
                </div>

                <!-- FD Maturing Soon Alert -->
                <div id="fdMaturingAlert" class="alert alert-fd-maturing mb-3" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="bi bi-clock-history"></i>
                            <strong id="fdMaturingCount">0</strong> FD(s) maturing in next 30 days
                        </div>
                        <button class="btn btn-dark btn-sm" data-bs-toggle="modal" data-bs-target="#fdMaturingModal">
                            <i class="bi bi-eye"></i> View Details
                        </button>
                    </div>
                </div>

                <!-- FD Matured Alert (flashing) -->
                <div id="fdMaturedAlert" class="alert alert-fd-matured mb-3" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="bi bi-exclamation-circle"></i>
                            <strong id="fdMaturedCount">0</strong> FD(s) have matured - Action Required!
                        </div>
                        <button class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#fdMaturedModal">
                            <i class="bi bi-check2-circle"></i> Mark Received
                        </button>
                    </div>
                </div>

                <!-- Allocation Review Alert -->
                <div id="allocReviewAlert" class="alert alert-alloc-review mb-3" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="bi bi-clock-history"></i>
                            <strong id="allocReviewCount">0</strong> fund allocation(s) need review (30+ days since last check)
                        </div>
                        <a href="/mutual-funds" class="btn btn-dark btn-sm">
                            <i class="bi bi-pie-chart"></i> Review Now
                        </a>
                    </div>
                </div>
            </div>

            <!-- Family Overview (default view) -->
            <div id="familyOverviewView">
                <div class="wealth-hero">
                    <p>Total Family Wealth</p>
                    <h2 class="mask-amount" id="totalPortfolioValue">-</h2>
                </div>

                <div class="row g-3 mb-4" id="summaryCards">
                    <div class="col-6 col-md-3">
                        <div class="summary-card">
                            <small class="text-muted text-uppercase">Total Portfolio</small>
                            <h4 class="mb-0 mask-amount" id="totalPortfolioValue2">-</h4>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="summary-card">
                            <small class="text-muted text-uppercase"><i class="bi bi-bank"></i> Mutual Funds</small>
                            <h4 class="mb-0 mask-amount text-primary" id="totalMfValue">-</h4>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="summary-card">
                            <small class="text-muted text-uppercase"><i class="bi bi-shield-check"></i> NPS</small>
                            <h4 class="mb-0 mask-amount" id="totalNpsValue" style="color: #11998e;">-</h4>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="summary-card">
                            <small class="text-muted text-uppercase"><i class="bi bi-safe"></i> Fixed Deposits</small>
                            <h4 class="mb-0 mask-amount" id="totalFdValue" style="color: #fd7e14;">-</h4>
                        </div>
                    </div>
                    <div class="col-6 col-md-3" id="otherAssetsCard" style="display: none;">
                        <div class="summary-card">
                            <small class="text-muted text-uppercase"><i class="bi bi-wallet2"></i> Other Assets</small>
                            <h4 class="mb-0 mask-amount" id="totalOtherValue" style="color: #6f42c1;">-</h4>
                        </div>
                    </div>
                </div>

                <!-- Member summary cards grid -->
                <h5 class="mb-3"><i class="bi bi-people"></i> Members</h5>
                <div class="row g-3" id="memberCardsGrid">
                    <!-- Rendered by JS -->
                </div>
            </div>

            <!-- Member Tree View (shown on member click) -->
            <div id="memberTreeView" style="display: none;">
                <div class="tree-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h4 class="mb-1" id="treeMemberName">-</h4>
                            <small class="text-muted" id="treeMemberPan">-</small>
                        </div>
                        <div class="text-end">
                            <div class="text-muted small">Total Value</div>
                            <h3 class="mb-0 mask-amount" id="treeMemberValue" style="color: #28a745;">-</h3>
                        </div>
                    </div>
                </div>
                <div id="treeNodes">
                    <!-- Tree nodes rendered by JS -->
                </div>
            </div>

            <!-- Empty State (no investors) -->
            <div id="emptyState" style="display: none;">
                <div class="empty-state">
                    <i class="bi bi-inbox"></i>
                    <h3 class="mt-3 text-muted">No investors yet</h3>
                    <p class="text-muted">Upload a CAS PDF or NPS statement to get started</p>
                    <div class="d-flex justify-content-center gap-3 mt-3">
                        <a href="/upload" class="btn btn-primary btn-lg">
                            <i class="bi bi-file-earmark-pdf"></i> Upload CAS PDF
                        </a>
                        <button class="btn btn-outline-success btn-lg" onclick="openNpsUpload()">
                            <i class="bi bi-shield-check"></i> Upload NPS
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Member Modal -->
    <div class="modal fade" id="addMemberModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-person-plus"></i> Add Family Member</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addMemberForm">
                        <div class="mb-3">
                            <label class="form-label">Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="memberName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">PAN</label>
                            <input type="text" class="form-control" id="memberPan" placeholder="ABCDE1234F" maxlength="10"
                                   style="text-transform: uppercase;">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" id="memberEmail">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Mobile</label>
                            <input type="tel" class="form-control" id="memberMobile">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addMember()">
                        <i class="bi bi-person-plus"></i> Add Member
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- NPS Upload Modal -->
    <div class="modal fade" id="npsUploadModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-shield-check"></i> Upload NPS Statement</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="npsUploadForm">
                        <div class="mb-3">
                            <label class="form-label">NPS Statement PDF</label>
                            <input type="file" class="form-control" id="npsFile" accept=".pdf" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Password (if encrypted)</label>
                            <input type="password" class="form-control" id="npsPassword" placeholder="Leave blank if not encrypted">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Link to Investor (optional)</label>
                            <select class="form-select" id="npsInvestorSelect">
                                <option value="">-- Select Investor --</option>
                            </select>
                        </div>
                    </form>
                    <div id="npsUploadProgress" style="display: none;">
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 100%"></div>
                        </div>
                        <p class="text-center mt-2">Parsing NPS statement...</p>
                    </div>
                    <div id="npsUploadResult" class="alert" style="display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="npsUploadBtn" onclick="uploadNps()">
                        <i class="bi bi-upload"></i> Upload & Parse
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- NPS Mapping Modal -->
    <div class="modal fade" id="npsMappingModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-link"></i> Map NPS Accounts to Investors</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="unmappedNpsList">
                        <!-- Unmapped NPS accounts will be shown here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- FD Upload Modal -->
    <div class="modal fade" id="fdUploadModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-safe"></i> Upload FD Statement (CSV)</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Step 1: Upload -->
                    <div id="fdUploadStep1">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Select Investor</label>
                                    <select class="form-select" id="fdInvestorSelect" required>
                                        <option value="">-- Select Investor --</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">CSV File</label>
                                    <input type="file" class="form-control" id="fdCsvFile" accept=".csv" required>
                                </div>
                            </div>
                        </div>
                        <div class="alert alert-info small">
                            <strong>Expected CSV Format:</strong>
                            <code>Account No./Nick Name, Deposit Date, ROI(%p.a), Maturity Date, Balance</code>
                        </div>
                        <div id="fdUploadProgress" style="display: none;" class="text-center py-3">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="mt-2">Parsing CSV...</p>
                        </div>
                    </div>

                    <!-- Step 2: Preview -->
                    <div id="fdUploadStep2" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <span class="badge bg-success me-2" id="fdValidCount">0 Valid</span>
                                <span class="badge bg-danger" id="fdInvalidCount">0 Invalid</span>
                            </div>
                            <button class="btn btn-outline-secondary btn-sm" onclick="resetFdUpload()">
                                <i class="bi bi-arrow-left"></i> Back
                            </button>
                        </div>
                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                            <table class="table table-sm table-bordered" id="fdPreviewTable">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th>#</th>
                                        <th>Account/Name</th>
                                        <th>Deposit Date</th>
                                        <th>Maturity Date</th>
                                        <th>ROI%</th>
                                        <th>Balance</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="fdPreviewBody"></tbody>
                            </table>
                        </div>
                        <div id="fdImportResult" class="mt-3" style="display: none;"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="fdParseBtn" onclick="parseFdCsv()">
                        <i class="bi bi-search"></i> Parse & Preview
                    </button>
                    <button type="button" class="btn btn-success" id="fdImportBtn" onclick="importFdData()" style="display: none;">
                        <i class="bi bi-check2-circle"></i> Import Valid FDs
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- FD Maturing Modal -->
    <div class="modal fade" id="fdMaturingModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title"><i class="bi bi-clock-history"></i> FDs Maturing Soon</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="fdMaturingList"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- FD Matured Modal -->
    <div class="modal fade" id="fdMaturedModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="bi bi-exclamation-circle"></i> Matured FDs - Action Required</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted">These FDs have matured. Please confirm if you have received the money.</p>
                    <div id="fdMaturedList"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let npsUploadModal, npsMappingModal;
        let fdUploadModal, fdMaturingModal, fdMaturedModal;
        let addMemberModal;
        let investors = [];
        let unmappedNps = [];
        let maturingFds = [], maturedFds = [];
        let activeMemberId = null; // null = family overview

        const avatarColors = ['#667eea', '#764ba2', '#11998e', '#fd7e14', '#e74c3c', '#3498db', '#9b59b6', '#1abc9c'];

        document.addEventListener('DOMContentLoaded', function() {
            npsUploadModal = new bootstrap.Modal(document.getElementById('npsUploadModal'));
            npsMappingModal = new bootstrap.Modal(document.getElementById('npsMappingModal'));
            fdUploadModal = new bootstrap.Modal(document.getElementById('fdUploadModal'));
            fdMaturingModal = new bootstrap.Modal(document.getElementById('fdMaturingModal'));
            fdMaturedModal = new bootstrap.Modal(document.getElementById('fdMaturedModal'));
            addMemberModal = new bootstrap.Modal(document.getElementById('addMemberModal'));
            loadDashboard();
        });

        // ==================== Mask Amounts ====================
        function isMaskEnabled() {
            return localStorage.getItem('maskAmounts') === 'true';
        }

        function toggleMask() {
            const currentState = isMaskEnabled();
            localStorage.setItem('maskAmounts', !currentState);
            applyMask();
        }

        function applyMask() {
            const masked = isMaskEnabled();
            const icon = document.getElementById('maskIcon');

            if (masked) {
                document.body.classList.add('mask-amounts');
                icon.className = 'bi bi-eye-slash';
            } else {
                document.body.classList.remove('mask-amounts');
                icon.className = 'bi bi-eye';
            }
        }

        applyMask();

        // ==================== Family Name Editing ====================
        function editFamilyName() {
            document.getElementById('familyNameDisplay').style.display = 'none';
            const editDiv = document.getElementById('familyNameEdit');
            const input = document.getElementById('familyNameInput');
            editDiv.style.display = 'block';
            input.value = document.getElementById('familyNameText').textContent;
            input.focus();
            input.select();
        }

        function cancelFamilyNameEdit() {
            document.getElementById('familyNameEdit').style.display = 'none';
            document.getElementById('familyNameDisplay').style.display = 'flex';
        }

        async function saveFamilyName() {
            const input = document.getElementById('familyNameInput');
            const newName = input.value.trim();
            if (!newName) {
                cancelFamilyNameEdit();
                return;
            }

            try {
                await fetch('/api/config/family_name', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ value: newName })
                });
                document.getElementById('familyNameText').textContent = newName;
            } catch (e) {
                console.error('Failed to save family name:', e);
            }

            cancelFamilyNameEdit();
        }

        // ==================== Add Member ====================
        function showAddMemberModal() {
            document.getElementById('addMemberForm').reset();
            addMemberModal.show();
        }

        async function addMember() {
            const name = document.getElementById('memberName').value.trim();
            if (!name) {
                alert('Please enter a name');
                return;
            }

            const data = {
                name: name,
                pan: document.getElementById('memberPan').value.trim().toUpperCase() || null,
                email: document.getElementById('memberEmail').value.trim() || null,
                mobile: document.getElementById('memberMobile').value.trim() || null
            };

            try {
                const res = await fetch('/api/investors', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (res.ok) {
                    addMemberModal.hide();
                    loadDashboard();
                } else {
                    const result = await res.json();
                    alert('Error: ' + (result.error || 'Failed to add member'));
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        // ==================== Dashboard Loading ====================
        async function loadDashboard() {
            try {
                // Load investors (now includes NPS data)
                const investorsRes = await fetch('/api/investors');
                investors = await investorsRes.json();

                {% if current_user and current_user.role == 'admin' %}
                // Admin-only alerts
                try {
                    const unmappedRes = await fetch('/api/unmapped-folios');
                    if (unmappedRes.ok) {
                        const unmappedFolios = await unmappedRes.json();
                        if (unmappedFolios.length > 0) {
                            document.getElementById('unmappedAlert').style.display = 'block';
                            document.getElementById('unmappedCount').textContent = unmappedFolios.length;
                        }
                    }
                } catch (e) { /* ignore */ }

                try {
                    const unmappedNpsRes = await fetch('/api/nps/unmapped');
                    if (unmappedNpsRes.ok) {
                        unmappedNps = await unmappedNpsRes.json();
                        if (unmappedNps.length > 0) {
                            document.getElementById('unmappedNpsAlert').style.display = 'block';
                            document.getElementById('unmappedNpsCount').textContent = unmappedNps.length;
                        }
                    }
                } catch (e) { /* ignore */ }

                try {
                    const conflictsRes = await fetch('/api/conflicts/stats');
                    if (conflictsRes.ok) {
                        const conflictStats = await conflictsRes.json();
                        if (conflictStats.pending_groups > 0) {
                            document.getElementById('conflictsAlert').style.display = 'block';
                            document.getElementById('conflictCount').textContent = conflictStats.pending_groups;
                        }
                    }
                } catch (e) { /* ignore */ }

                // Load FD maturity alerts
                await loadFdAlerts();

                // Load allocation review alerts
                try {
                    const reviewRes = await fetch('/api/mutual-funds/review-alerts');
                    if (reviewRes.ok) {
                        const reviewData = await reviewRes.json();
                        if (reviewData.count > 0) {
                            document.getElementById('allocReviewAlert').style.display = 'block';
                            document.getElementById('allocReviewCount').textContent = reviewData.count;
                        }
                    }
                } catch (e) { /* ignore */ }
                {% endif %}

                // Load manual asset values for each investor (FDs + other assets)
                for (const inv of investors) {
                    try {
                        const maRes = await fetch(`/api/manual-assets?investor_id=${inv.id}`);
                        const assets = await maRes.json();
                        const fdAssets = assets.filter(a => a.asset_type === 'fd');
                        const otherAssets = assets.filter(a => a.asset_type !== 'fd');
                        inv.fd_value = fdAssets.reduce((sum, a) => sum + (a.calculated_value || a.fd_principal || 0), 0);
                        inv.fd_count = fdAssets.length;
                        inv.ma_other_value = otherAssets.reduce((sum, a) => sum + (a.calculated_value || a.current_value || a.purchase_value || 0), 0);
                        inv.ma_other_count = otherAssets.length;
                    } catch (e) {
                        inv.fd_value = 0;
                        inv.fd_count = 0;
                        inv.ma_other_value = 0;
                        inv.ma_other_count = 0;
                    }
                }

                // Calculate totals
                let totalMf = 0, totalNps = 0, totalFd = 0, totalOther = 0;
                investors.forEach(inv => {
                    totalMf += inv.mf_value || 0;
                    totalNps += inv.nps_value || 0;
                    totalFd += inv.fd_value || 0;
                    totalOther += inv.ma_other_value || 0;
                });

                // Add unmapped NPS to total
                unmappedNps.forEach(nps => {
                    totalNps += nps.total_value || 0;
                });

                const totalAll = totalMf + totalNps + totalFd + totalOther;
                document.getElementById('totalPortfolioValue').textContent = formatCurrency(totalAll);
                document.getElementById('totalPortfolioValue2').textContent = formatCurrency(totalAll);
                document.getElementById('totalMfValue').textContent = formatCurrency(totalMf);
                document.getElementById('totalNpsValue').textContent = formatCurrency(totalNps);
                document.getElementById('totalFdValue').textContent = formatCurrency(totalFd);
                if (totalOther > 0) {
                    document.getElementById('totalOtherValue').textContent = formatCurrency(totalOther);
                    document.getElementById('otherAssetsCard').style.display = 'block';
                }

                // Render sidebar and views
                renderSidebar();

                if (investors.length === 0 && unmappedNps.length === 0) {
                    document.getElementById('familyOverviewView').style.display = 'none';
                    document.getElementById('memberTreeView').style.display = 'none';
                    document.getElementById('emptyState').style.display = 'block';
                } else if (activeMemberId) {
                    showMemberTree(activeMemberId);
                } else {
                    showFamilyOverview();
                }

                // Populate investor select in NPS upload modal
                populateInvestorSelects();

            } catch (error) {
                console.error('Failed to load dashboard:', error);
            }
        }

        // ==================== Sidebar ====================
        function renderSidebar() {
            const list = document.getElementById('memberList');
            let html = '';

            // Family Overview item (always first)
            html += `
                <div class="member-item ${activeMemberId === null ? 'active' : ''}" onclick="showFamilyOverview()">
                    <div class="member-avatar" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                        <i class="bi bi-house-heart"></i>
                    </div>
                    <div class="member-info">
                        <div class="member-name">Family Overview</div>
                        <div class="member-value mask-amount">${formatCurrency(getTotalWealth())}</div>
                    </div>
                </div>
            `;

            // Member items
            investors.forEach((inv, idx) => {
                const initials = getInitials(inv.name || 'U');
                const color = avatarColors[idx % avatarColors.length];
                const totalValue = (inv.mf_value || 0) + (inv.nps_value || 0) + (inv.fd_value || 0) + (inv.ma_other_value || 0);

                html += `
                    <div class="member-item ${activeMemberId === inv.id ? 'active' : ''}" onclick="showMemberTree(${inv.id})">
                        <div class="member-avatar" style="background: ${color};">${initials}</div>
                        <div class="member-info">
                            <div class="member-name">${inv.name || 'Unknown'}</div>
                            <div class="member-value mask-amount">${formatCurrency(totalValue)}</div>
                        </div>
                    </div>
                `;
            });

            list.innerHTML = html;
        }

        function getInitials(name) {
            return name.split(' ').map(w => w[0]).join('').substring(0, 2).toUpperCase();
        }

        function getTotalWealth() {
            let total = 0;
            investors.forEach(inv => {
                total += (inv.mf_value || 0) + (inv.nps_value || 0) + (inv.fd_value || 0) + (inv.ma_other_value || 0);
            });
            unmappedNps.forEach(nps => {
                total += nps.total_value || 0;
            });
            return total;
        }

        // ==================== Family Overview ====================
        function showFamilyOverview() {
            activeMemberId = null;
            document.getElementById('familyOverviewView').style.display = 'block';
            document.getElementById('memberTreeView').style.display = 'none';
            document.getElementById('emptyState').style.display = 'none';
            renderSidebar();
            renderFamilyOverview();
        }

        function renderFamilyOverview() {
            const grid = document.getElementById('memberCardsGrid');

            if (investors.length === 0) {
                grid.innerHTML = '<div class="col-12"><p class="text-muted text-center">No members yet. Click "Add Member" to get started.</p></div>';
                return;
            }

            grid.innerHTML = investors.map((inv, idx) => {
                const mfValue = inv.mf_value || 0;
                const npsValue = inv.nps_value || 0;
                const fdValue = inv.fd_value || 0;
                const otherValue = inv.ma_other_value || 0;
                const totalValue = mfValue + npsValue + fdValue + otherValue;
                const mfPct = totalValue > 0 ? (mfValue / totalValue * 100) : 0;
                const npsPct = totalValue > 0 ? (npsValue / totalValue * 100) : 0;
                const fdPct = totalValue > 0 ? (fdValue / totalValue * 100) : 0;
                const otherPct = totalValue > 0 ? (otherValue / totalValue * 100) : 0;
                const initials = getInitials(inv.name || 'U');
                const color = avatarColors[idx % avatarColors.length];

                return `
                <div class="col-md-4 col-sm-6 mb-3">
                    <div class="member-summary-card" onclick="showMemberTree(${inv.id})">
                        <div class="d-flex align-items-center gap-3 mb-2">
                            <div class="member-avatar" style="background: ${color};">${initials}</div>
                            <div>
                                <div style="font-weight: 600;">${inv.name || 'Unknown'}</div>
                                <small class="text-muted">${inv.pan || 'No PAN'}</small>
                            </div>
                        </div>
                        <div style="font-size: 1.4rem; font-weight: 700; color: #28a745;" class="mask-amount">
                            ${formatCurrency(totalValue)}
                        </div>
                        ${totalValue > 0 ? `
                        <div class="asset-bar">
                            ${mfPct > 0 ? `<div class="mf-segment" style="width: ${mfPct}%;" title="MF: ${formatCurrency(mfValue)}"></div>` : ''}
                            ${npsPct > 0 ? `<div class="nps-segment" style="width: ${npsPct}%;" title="NPS: ${formatCurrency(npsValue)}"></div>` : ''}
                            ${fdPct > 0 ? `<div class="fd-segment" style="width: ${fdPct}%;" title="FD: ${formatCurrency(fdValue)}"></div>` : ''}
                            ${otherPct > 0 ? `<div class="other-segment" style="width: ${otherPct}%;" title="Other: ${formatCurrency(otherValue)}"></div>` : ''}
                        </div>
                        <div class="value-breakdown mt-2">
                            ${mfValue > 0 ? `<div class="value-item"><span class="badge badge-mf" style="font-size: 0.65rem;">MF</span><small class="text-muted mask-amount">${formatCurrency(mfValue)}</small></div>` : ''}
                            ${npsValue > 0 ? `<div class="value-item"><span class="badge badge-nps" style="font-size: 0.65rem;">NPS</span><small class="text-muted mask-amount">${formatCurrency(npsValue)}</small></div>` : ''}
                            ${fdValue > 0 ? `<div class="value-item"><span class="badge badge-fd" style="font-size: 0.65rem;">FD</span><small class="text-muted mask-amount">${formatCurrency(fdValue)}</small></div>` : ''}
                            ${otherValue > 0 ? `<div class="value-item"><span class="badge" style="font-size: 0.65rem; background: #6f42c1; color: white;">Other</span><small class="text-muted mask-amount">${formatCurrency(otherValue)}</small></div>` : ''}
                        </div>
                        ` : ''}
                    </div>
                </div>`;
            }).join('');
        }

        // ==================== Member Tree View ====================
        async function showMemberTree(investorId) {
            activeMemberId = investorId;
            document.getElementById('familyOverviewView').style.display = 'none';
            document.getElementById('memberTreeView').style.display = 'block';
            document.getElementById('emptyState').style.display = 'none';
            renderSidebar();

            const inv = investors.find(i => i.id === investorId);
            if (!inv) return;

            const mfValue = inv.mf_value || 0;
            const npsValue = inv.nps_value || 0;
            const fdValue = inv.fd_value || 0;
            const otherValue = inv.ma_other_value || 0;
            const totalValue = mfValue + npsValue + fdValue + otherValue;

            document.getElementById('treeMemberName').textContent = inv.name || 'Unknown';
            document.getElementById('treeMemberPan').textContent = inv.pan ? `PAN: ${inv.pan}` : '';
            document.getElementById('treeMemberValue').textContent = formatCurrency(totalValue);

            // Fetch goals for this investor
            let goals = [];
            try {
                const goalsRes = await fetch(`/api/investors/${investorId}/goals`);
                goals = await goalsRes.json();
            } catch (e) { /* ignore */ }

            // Build tree nodes
            let nodesHtml = '';

            // Mutual Funds node
            if (inv.folio_count > 0 || mfValue > 0) {
                nodesHtml += buildTreeNode({
                    icon: 'bi-bank',
                    iconBg: '#667eea',
                    label: 'Mutual Funds',
                    meta: `${inv.folio_count || 0} folios`,
                    value: mfValue,
                    valueColor: '#667eea',
                    linkUrl: `/investor/${investorId}#mf-tab`
                });
            }

            // NPS node
            if (inv.nps_count > 0 || npsValue > 0) {
                nodesHtml += buildTreeNode({
                    icon: 'bi-shield-check',
                    iconBg: '#11998e',
                    label: 'NPS',
                    meta: `${inv.nps_count || 0} schemes`,
                    value: npsValue,
                    valueColor: '#11998e',
                    linkUrl: `/investor/${investorId}#nps-tab`
                });
            }

            // Fixed Deposits node
            if (inv.fd_count > 0 || fdValue > 0) {
                nodesHtml += buildTreeNode({
                    icon: 'bi-safe',
                    iconBg: '#fd7e14',
                    label: 'Fixed Deposits',
                    meta: `${inv.fd_count || 0} FDs`,
                    value: fdValue,
                    valueColor: '#fd7e14',
                    linkUrl: `/investor/${investorId}#fd-tab`
                });
            }

            // Other Assets node (SGBs, PPF, stocks, house, car, gold, etc.)
            if ((inv.ma_other_count || 0) > 0 || otherValue > 0) {
                nodesHtml += buildTreeNode({
                    icon: 'bi-wallet2',
                    iconBg: '#6f42c1',
                    label: 'Other Assets',
                    meta: `${inv.ma_other_count || 0} assets`,
                    value: otherValue,
                    valueColor: '#6f42c1',
                    linkUrl: `/investor/${investorId}#fd-tab`
                });
            }

            // Goals node (expandable)
            if (goals.length > 0) {
                const goalsValue = goals.reduce((sum, g) => sum + (g.current_value || 0), 0);
                let childrenHtml = goals.map(g => `
                    <div class="tree-child-item" onclick="window.location='/investor/${investorId}/goals'">
                        <div>
                            <span>${g.name}</span>
                            <small class="text-muted ms-2">${g.target_date ? formatDate(g.target_date) : ''}</small>
                        </div>
                        <span class="mask-amount" style="font-weight: 500;">${formatCurrency(g.current_value || 0)}</span>
                    </div>
                `).join('');

                nodesHtml += `
                <div class="tree-node">
                    <div class="tree-node-header" onclick="toggleTreeNode('goalsChildren')">
                        <div class="tree-node-icon" style="background: rgba(155, 89, 182, 0.12); color: #9b59b6;">
                            <i class="bi bi-bullseye"></i>
                        </div>
                        <div class="tree-node-info">
                            <div class="tree-node-label">Goals</div>
                            <div class="tree-node-meta">${goals.length} goals</div>
                        </div>
                        <div class="tree-node-value mask-amount" style="color: #9b59b6;">${formatCurrency(goalsValue)}</div>
                        <div class="tree-node-arrow">
                            <i class="bi bi-chevron-down" id="goalsChildrenArrow"></i>
                        </div>
                    </div>
                    <div class="tree-children" id="goalsChildren" style="display: none;">
                        ${childrenHtml}
                    </div>
                </div>`;
            }

            // If nothing to show
            if (!nodesHtml) {
                nodesHtml = `
                <div class="text-center py-4 text-muted">
                    <i class="bi bi-inbox" style="font-size: 2rem;"></i>
                    <p class="mt-2">No assets yet. Upload a CAS PDF, NPS statement, or FD CSV.</p>
                </div>`;
            }

            document.getElementById('treeNodes').innerHTML = nodesHtml;
        }

        function buildTreeNode({icon, iconBg, label, meta, value, valueColor, linkUrl}) {
            return `
            <div class="tree-node">
                <div class="tree-node-header" onclick="window.location='${linkUrl}'">
                    <div class="tree-node-icon" style="background: ${iconBg}22; color: ${iconBg};">
                        <i class="bi ${icon}"></i>
                    </div>
                    <div class="tree-node-info">
                        <div class="tree-node-label">${label}</div>
                        <div class="tree-node-meta">${meta}</div>
                    </div>
                    <div class="tree-node-value mask-amount" style="color: ${valueColor};">${formatCurrency(value)}</div>
                    <div class="tree-node-arrow">
                        <i class="bi bi-chevron-right"></i>
                    </div>
                </div>
            </div>`;
        }

        function toggleTreeNode(nodeId) {
            const children = document.getElementById(nodeId);
            const arrow = document.getElementById(nodeId + 'Arrow');
            if (children.style.display === 'none') {
                children.style.display = 'block';
                arrow.className = 'bi bi-chevron-up';
            } else {
                children.style.display = 'none';
                arrow.className = 'bi bi-chevron-down';
            }
        }

        // ==================== Investor Selects ====================
        function populateInvestorSelects() {
            const selects = [
                document.getElementById('npsInvestorSelect'),
                document.getElementById('fdInvestorSelect')
            ];

            selects.forEach(select => {
                if (!select) return;
                // Clear existing options except the first one
                while (select.options.length > 1) {
                    select.remove(1);
                }
                investors.forEach(inv => {
                    const option = document.createElement('option');
                    option.value = inv.id;
                    option.textContent = `${inv.name} (${inv.pan || 'No PAN'})`;
                    select.appendChild(option);
                });
            });
        }

        // ==================== FD Functions ====================

        async function loadFdAlerts() {
            try {
                // Load maturing FDs
                const maturingRes = await fetch('/api/fd/maturing?days=30');
                maturingFds = await maturingRes.json();

                if (maturingFds.length > 0) {
                    document.getElementById('fdMaturingAlert').style.display = 'block';
                    document.getElementById('fdMaturingCount').textContent = maturingFds.length;
                    renderFdMaturingList();
                }

                // Load matured FDs
                const maturedRes = await fetch('/api/fd/matured');
                maturedFds = await maturedRes.json();

                if (maturedFds.length > 0) {
                    document.getElementById('fdMaturedAlert').style.display = 'block';
                    document.getElementById('fdMaturedCount').textContent = maturedFds.length;
                    renderFdMaturedList();
                }
            } catch (error) {
                console.error('Failed to load FD alerts:', error);
            }
        }

        function renderFdMaturingList() {
            const container = document.getElementById('fdMaturingList');
            if (maturingFds.length === 0) {
                container.innerHTML = '<p class="text-muted">No FDs maturing soon.</p>';
                return;
            }

            container.innerHTML = maturingFds.map(fd => {
                const daysLeft = Math.ceil((new Date(fd.fd_maturity_date) - new Date()) / (1000 * 60 * 60 * 24));
                const maturityValue = fd.fd_details?.maturity_value || fd.fd_principal;

                return `
                <div class="fd-item d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${fd.name}</strong>
                        <small class="text-muted d-block">${fd.investor_name} | ${fd.fd_bank_name || 'Bank'}</small>
                    </div>
                    <div class="text-end">
                        <span class="badge fd-maturity-badge ${daysLeft <= 7 ? 'bg-danger' : 'bg-warning text-dark'}">
                            ${daysLeft} days left
                        </span>
                        <div class="small text-muted">Matures: ${formatDate(fd.fd_maturity_date)}</div>
                        <div class="small"><strong>${formatCurrency(maturityValue)}</strong></div>
                    </div>
                </div>`;
            }).join('');
        }

        function renderFdMaturedList() {
            const container = document.getElementById('fdMaturedList');
            if (maturedFds.length === 0) {
                container.innerHTML = '<p class="text-muted">No matured FDs pending.</p>';
                return;
            }

            container.innerHTML = maturedFds.map(fd => {
                const daysPast = Math.ceil((new Date() - new Date(fd.fd_maturity_date)) / (1000 * 60 * 60 * 24));
                const maturityValue = fd.fd_details?.maturity_value || fd.fd_principal;

                return `
                <div class="fd-item d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${fd.name}</strong>
                        <small class="text-muted d-block">${fd.investor_name} | ${fd.fd_bank_name || 'Bank'}</small>
                        <small class="text-danger">Matured ${daysPast} days ago</small>
                    </div>
                    <div class="text-end">
                        <div class="mb-2"><strong>${formatCurrency(maturityValue)}</strong></div>
                        <button class="btn btn-success btn-sm" onclick="markFdReceived(${fd.id}, true)">
                            <i class="bi bi-check2"></i> Money Received
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="markFdReceived(${fd.id}, false)">
                            <i class="bi bi-x"></i> Not Received
                        </button>
                    </div>
                </div>`;
            }).join('');
        }

        async function markFdReceived(fdId, received) {
            try {
                const res = await fetch(`/api/fd/${fdId}/close`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ money_received: received })
                });

                if (res.ok) {
                    // Reload the FD alerts
                    await loadFdAlerts();

                    // If no more matured FDs, hide alert and close modal
                    if (maturedFds.length === 0) {
                        document.getElementById('fdMaturedAlert').style.display = 'none';
                        fdMaturedModal.hide();
                    }

                    // Show success toast or message
                    alert(received ? 'FD marked as received and closed.' : 'FD marked as closed (not received).');
                } else {
                    alert('Failed to update FD status.');
                }
            } catch (error) {
                console.error('Error closing FD:', error);
                alert('Error updating FD status.');
            }
        }

        let fdPreviewData = [];

        function openFdUpload() {
            resetFdUpload();
            fdUploadModal.show();
        }

        function resetFdUpload() {
            document.getElementById('fdCsvFile').value = '';
            document.getElementById('fdUploadStep1').style.display = 'block';
            document.getElementById('fdUploadStep2').style.display = 'none';
            document.getElementById('fdUploadProgress').style.display = 'none';
            document.getElementById('fdParseBtn').style.display = 'inline-block';
            document.getElementById('fdImportBtn').style.display = 'none';
            document.getElementById('fdImportResult').style.display = 'none';
            fdPreviewData = [];
        }

        async function parseFdCsv() {
            const fileInput = document.getElementById('fdCsvFile');
            const investorId = document.getElementById('fdInvestorSelect').value;

            if (!fileInput.files.length) {
                alert('Please select a CSV file');
                return;
            }

            if (!investorId) {
                alert('Please select an investor');
                return;
            }

            document.getElementById('fdUploadProgress').style.display = 'block';

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('investor_id', investorId);

            try {
                const res = await fetch('/api/fd/upload-csv', {
                    method: 'POST',
                    body: formData
                });

                const result = await res.json();
                document.getElementById('fdUploadProgress').style.display = 'none';

                if (!res.ok) {
                    alert('Error: ' + result.error);
                    return;
                }

                // Store preview data
                fdPreviewData = result.rows;

                // Update counts
                document.getElementById('fdValidCount').textContent = result.valid_count + ' Valid';
                document.getElementById('fdInvalidCount').textContent = result.invalid_count + ' Invalid';

                // Build preview table
                const tbody = document.getElementById('fdPreviewBody');
                tbody.innerHTML = result.rows.map(row => {
                    const rowClass = row.is_valid ? 'table-success' : 'table-danger';
                    const statusHtml = row.is_valid
                        ? '<span class="badge bg-success"><i class="bi bi-check"></i> Valid</span>'
                        : `<span class="badge bg-danger" title="${row.errors.join(', ')}"><i class="bi bi-x"></i> ${row.errors[0]}</span>`;

                    return `
                    <tr class="${rowClass}">
                        <td>${row.row_num}</td>
                        <td>${row.name || '<em class="text-muted">Empty</em>'}</td>
                        <td>${row.deposit_date || '-'}</td>
                        <td>${row.maturity_date || '-'}</td>
                        <td>${row.roi || '-'}%</td>
                        <td>${row.balance ? formatCurrency(row.balance) : '-'}</td>
                        <td>${statusHtml}</td>
                    </tr>`;
                }).join('');

                // Show step 2
                document.getElementById('fdUploadStep1').style.display = 'none';
                document.getElementById('fdUploadStep2').style.display = 'block';
                document.getElementById('fdParseBtn').style.display = 'none';

                // Show import button only if there are valid rows
                if (result.valid_count > 0) {
                    document.getElementById('fdImportBtn').style.display = 'inline-block';
                }

            } catch (error) {
                document.getElementById('fdUploadProgress').style.display = 'none';
                alert('Error: ' + error.message);
            }
        }

        async function importFdData() {
            const investorId = document.getElementById('fdInvestorSelect').value;
            const validRows = fdPreviewData.filter(r => r.is_valid);

            if (validRows.length === 0) {
                alert('No valid rows to import');
                return;
            }

            document.getElementById('fdImportBtn').disabled = true;
            document.getElementById('fdImportBtn').innerHTML = '<span class="spinner-border spinner-border-sm"></span> Importing...';

            try {
                const res = await fetch('/api/fd/import', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        investor_id: investorId,
                        rows: validRows
                    })
                });

                const result = await res.json();

                const resultDiv = document.getElementById('fdImportResult');
                resultDiv.style.display = 'block';

                if (res.ok && result.success) {
                    resultDiv.className = 'alert alert-success';
                    resultDiv.innerHTML = `
                        <i class="bi bi-check-circle"></i>
                        <strong>Success!</strong> Imported ${result.created} FD(s).
                        ${result.skipped > 0 ? ` Skipped ${result.skipped} duplicates.` : ''}
                    `;

                    document.getElementById('fdImportBtn').style.display = 'none';

                    // Reload dashboard after delay
                    setTimeout(() => {
                        fdUploadModal.hide();
                        loadDashboard();
                    }, 1500);
                } else {
                    resultDiv.className = 'alert alert-danger';
                    resultDiv.innerHTML = `<i class="bi bi-x-circle"></i> Error: ${result.error}`;
                    document.getElementById('fdImportBtn').disabled = false;
                    document.getElementById('fdImportBtn').innerHTML = '<i class="bi bi-check2-circle"></i> Import Valid FDs';
                }
            } catch (error) {
                const resultDiv = document.getElementById('fdImportResult');
                resultDiv.style.display = 'block';
                resultDiv.className = 'alert alert-danger';
                resultDiv.innerHTML = `<i class="bi bi-x-circle"></i> Error: ${error.message}`;
                document.getElementById('fdImportBtn').disabled = false;
                document.getElementById('fdImportBtn').innerHTML = '<i class="bi bi-check2-circle"></i> Import Valid FDs';
            }
        }

        // ==================== NPS Functions ====================

        function openNpsUpload() {
            document.getElementById('npsUploadForm').reset();
            document.getElementById('npsUploadProgress').style.display = 'none';
            document.getElementById('npsUploadResult').style.display = 'none';
            document.getElementById('npsUploadBtn').disabled = false;
            npsUploadModal.show();
        }

        async function uploadNps() {
            const fileInput = document.getElementById('npsFile');
            const password = document.getElementById('npsPassword').value;
            const investorId = document.getElementById('npsInvestorSelect').value;

            if (!fileInput.files.length) {
                alert('Please select a PDF file');
                return;
            }

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            if (password) formData.append('password', password);
            if (investorId) formData.append('investor_id', investorId);

            document.getElementById('npsUploadBtn').disabled = true;
            document.getElementById('npsUploadProgress').style.display = 'block';
            document.getElementById('npsUploadResult').style.display = 'none';

            try {
                const res = await fetch('/api/nps/upload', {
                    method: 'POST',
                    body: formData
                });

                const result = await res.json();
                document.getElementById('npsUploadProgress').style.display = 'none';

                const resultDiv = document.getElementById('npsUploadResult');
                if (result.success) {
                    resultDiv.className = 'alert alert-success';
                    resultDiv.innerHTML = `
                        <strong>Success!</strong><br>
                        Name: ${result.subscriber_name || '-'}<br>
                        PRAN: ${result.pran}<br>
                        ${result.total_value > 0 ? `<strong>Total Value: ${formatCurrency(result.total_value)}</strong><br>` : ''}
                        Schemes: ${result.schemes_imported}<br>
                        Transactions: ${result.transactions_imported} imported
                    `;
                    // Reload dashboard
                    setTimeout(() => {
                        npsUploadModal.hide();
                        loadDashboard();
                    }, 2000);
                } else {
                    resultDiv.className = 'alert alert-danger';
                    resultDiv.innerHTML = `<strong>Error:</strong> ${result.error}`;
                    document.getElementById('npsUploadBtn').disabled = false;
                }
                resultDiv.style.display = 'block';

            } catch (error) {
                document.getElementById('npsUploadProgress').style.display = 'none';
                const resultDiv = document.getElementById('npsUploadResult');
                resultDiv.className = 'alert alert-danger';
                resultDiv.innerHTML = `<strong>Error:</strong> ${error.message}`;
                resultDiv.style.display = 'block';
                document.getElementById('npsUploadBtn').disabled = false;
            }
        }

        function openNpsMappingModal() {
            const container = document.getElementById('unmappedNpsList');

            if (unmappedNps.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">No unmapped NPS accounts</p>';
            } else {
                container.innerHTML = unmappedNps.map(nps => `
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">${nps.name}</h6>
                                    <small class="text-muted">PRAN: ${nps.pran}</small>
                                    ${nps.pan ? `<br><small class="text-muted">PAN: ${nps.pan}</small>` : ''}
                                    <br><strong class="text-success">${formatCurrency(nps.total_value || 0)}</strong>
                                </div>
                                <div>
                                    <select class="form-select form-select-sm" id="npsMap_${nps.pran}" style="width: 200px;">
                                        <option value="">-- Select Investor --</option>
                                        ${investors.map(inv => `
                                            <option value="${inv.id}">${inv.name} (${inv.pan || 'No PAN'})</option>
                                        `).join('')}
                                    </select>
                                    <button class="btn btn-primary btn-sm mt-2" onclick="linkNpsToInvestor('${nps.pran}')">
                                        <i class="bi bi-link"></i> Link
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            npsMappingModal.show();
        }

        async function linkNpsToInvestor(pran) {
            const select = document.getElementById(`npsMap_${pran}`);
            const investorId = select.value;

            if (!investorId) {
                alert('Please select an investor');
                return;
            }

            try {
                const res = await fetch('/api/nps/link', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pran, investor_id: parseInt(investorId) })
                });

                const result = await res.json();
                if (result.success) {
                    npsMappingModal.hide();
                    loadDashboard();
                } else {
                    alert('Failed to link NPS account');
                }
            } catch (error) {
                console.error('Failed to link NPS:', error);
                alert('Failed to link NPS account');
            }
        }

        // ==================== Utilities ====================

        function formatCurrency(value) {
            return new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR',
                maximumFractionDigits: 0
            }).format(value);
        }

        function formatDate(dateStr) {
            if (!dateStr) return '-';
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-IN', {
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            });
        }
    </script>
    {% include '_feature_request_widget.html' %}
<script>
// Auth: redirect to login on 401
const _origFetch = window.fetch;
window.fetch = function() {
    return _origFetch.apply(this, arguments).then(resp => {
        if (resp.status === 401) window.location.href = '/login';
        return resp;
    });
};
</script>
</body>
</html>
