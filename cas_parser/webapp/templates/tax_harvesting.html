<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Famfolio - Tax-Loss Harvesting</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .header {
            background: linear-gradient(135deg, #e65100 0%, #ff8f00 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        .summary-card {
            background: white;
            border-radius: 12px;
            padding: 1.25rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            height: 100%;
        }
        .summary-card h3 { font-size: 1.5rem; margin-bottom: 0; }
        .summary-card p { margin-bottom: 0.25rem; color: #6c757d; font-size: 0.85rem; }
        .loss { color: #dc3545; }
        .gain { color: #198754; }
        .urgent-badge {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffc107;
            border-radius: 6px;
            padding: 2px 8px;
            font-size: 0.75rem;
            font-weight: 600;
            animation: urgentPulse 2s infinite;
        }
        @keyframes urgentPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .urgency-alert {
            background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%);
            border: 1px solid #ffc107;
            border-radius: 10px;
            padding: 1rem 1.25rem;
        }
        .opportunity-row {
            cursor: pointer;
            transition: background 0.15s;
        }
        .opportunity-row:hover { background: #f8f9fa; }
        .similar-fund-panel {
            background: #f1f3f5;
            border-radius: 8px;
            padding: 1rem;
            margin: 0.5rem 0;
        }
        .realized-card {
            border-left: 4px solid #667eea;
            background: white;
            border-radius: 8px;
            padding: 1rem 1.25rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .realized-card h5 a { cursor: pointer; }
        .realized-card h5 a:hover { text-decoration: underline !important; }
        .exemption-bar {
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }
        .exemption-bar .fill {
            height: 100%;
            background: linear-gradient(90deg, #198754, #20c997);
            border-radius: 4px;
            transition: width 0.5s;
        }
        .exit-load-input {
            width: 70px;
            display: inline-block;
            padding: 2px 6px;
            font-size: 0.85rem;
        }
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }
        .empty-state i { font-size: 3rem; }
        body.mask-amounts .mask-amount {
            filter: blur(8px);
            user-select: none;
        }
        .toast-container { position: fixed; bottom: 1rem; right: 1rem; z-index: 1090; }
        .chevron-icon { transition: transform 0.2s; }
        .chevron-icon.open { transform: rotate(180deg); }
        .table th { font-size: 0.8rem; text-transform: uppercase; color: #6c757d; }
        .table td { vertical-align: middle; font-size: 0.9rem; }
        .warning-banner {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            font-size: 0.85rem;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="container">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <a href="/investor/{{ investor.id }}" class="text-white text-decoration-none">
                        <i class="bi bi-arrow-left"></i> Back to Portfolio
                    </a>
                    <h1 class="mt-3"><i class="bi bi-scissors"></i> Tax-Loss Harvesting</h1>
                    <p class="mb-0 opacity-75">Identify loss lots to offset gains and reduce tax liability</p>
                </div>
                <div>
                    <button class="btn btn-sm btn-outline-light" id="maskToggle" onclick="toggleMask()">
                        <i class="bi bi-eye" id="maskIcon"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Tax Slab Selector -->
        <div class="card mb-4">
            <div class="card-body d-flex align-items-center gap-3">
                <label class="fw-semibold mb-0">Income Tax Slab:</label>
                <select id="taxSlabSelect" class="form-select form-select-sm" style="width: 120px;">
                    <option value="0">0%</option>
                    <option value="5">5%</option>
                    <option value="10">10%</option>
                    <option value="15">15%</option>
                    <option value="20">20%</option>
                    <option value="25">25%</option>
                    <option value="30">30%</option>
                </select>
                <button class="btn btn-sm btn-primary" onclick="saveTaxSlab()">
                    <i class="bi bi-check-lg"></i> Save
                </button>
                <small class="text-muted">Used for debt fund tax calculations</small>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="row mb-4 g-3" id="summarySection">
            <div class="col-md-3">
                <div class="summary-card">
                    <p>Total Unrealized Loss</p>
                    <h3 class="loss mask-amount" id="totalLoss">-</h3>
                </div>
            </div>
            <div class="col-md-3">
                <div class="summary-card">
                    <p>Potential Tax Savings</p>
                    <h3 class="gain mask-amount" id="totalTaxSaved">-</h3>
                </div>
            </div>
            <div class="col-md-3">
                <div class="summary-card">
                    <p>Net Benefit (after costs)</p>
                    <h3 class="gain mask-amount" id="totalNetBenefit">-</h3>
                </div>
            </div>
            <div class="col-md-3">
                <div class="summary-card">
                    <p>Opportunities</p>
                    <h3 id="oppCount">-</h3>
                    <small class="text-muted" id="urgentLabel"></small>
                </div>
            </div>
        </div>

        <!-- Urgency Alerts -->
        <div id="urgencyAlerts" class="mb-4" style="display:none;"></div>

        <!-- Warnings -->
        <div id="warningsSection" class="mb-4" style="display:none;"></div>

        <!-- Realized Gains This FY -->
        <div class="mb-4">
            <h5><i class="bi bi-graph-up"></i> Realized Gains This FY</h5>
            <div class="row g-3" id="realizedSection">
                <div class="col-md-4">
                    <div class="realized-card">
                        <small class="text-muted">Equity STCG</small>
                        <h5 class="mask-amount"><a href="#" class="text-decoration-none" id="eqStcg" onclick="showGainDetails('equity_stcg'); return false;">-</a></h5>
                        <small class="text-muted">Tax @ 20%</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="realized-card">
                        <small class="text-muted">Equity LTCG</small>
                        <h5 class="mask-amount"><a href="#" class="text-decoration-none" id="eqLtcg" onclick="showGainDetails('equity_ltcg'); return false;">-</a></h5>
                        <div class="mt-2">
                            <small class="text-muted">LTCG Exemption (&#8377;1.25L)</small>
                            <div class="exemption-bar mt-1">
                                <div class="fill" id="exemptionBar" style="width:0%"></div>
                            </div>
                            <small id="exemptionLabel" class="text-muted"></small>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="realized-card">
                        <small class="text-muted">Debt / Other Gains</small>
                        <h5 class="mask-amount"><a href="#" class="text-decoration-none" id="debtGains" onclick="showGainDetails('debt_gains'); return false;">-</a></h5>
                        <small class="text-muted">Tax @ slab rate</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Opportunities Table -->
        <div class="mb-4">
            <h5><i class="bi bi-lightbulb"></i> Harvesting Opportunities</h5>
            <div id="opportunitiesSection"></div>
        </div>
    </div>

    <!-- Realized Gain Details Modal -->
    <div class="modal fade" id="gainDetailModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="gainDetailTitle">Sale Transactions</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-sm mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th style="width:30px"></th>
                                    <th>Scheme</th>
                                    <th>Sell Date</th>
                                    <th class="text-end">Units Sold</th>
                                    <th class="text-end">Sell NAV</th>
                                    <th class="text-end">Gain/Loss</th>
                                    <th style="width:40px"></th>
                                </tr>
                            </thead>
                            <tbody id="gainDetailBody"></tbody>
                            <tfoot>
                                <tr class="table-light fw-bold">
                                    <td colspan="5">Total</td>
                                    <td class="text-end" id="gainDetailTotal">-</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const INVESTOR_ID = {{ investor.id }};
        const INVESTOR_TAX_SLAB = {{ investor.tax_slab_pct if investor.tax_slab_pct else 30 }};
        let analysisData = null;

        // ---- Init ----
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('taxSlabSelect').value = INVESTOR_TAX_SLAB;
            loadAnalysis();
        });

        // ---- Mask toggle ----
        function toggleMask() {
            document.body.classList.toggle('mask-amounts');
            const icon = document.getElementById('maskIcon');
            icon.className = document.body.classList.contains('mask-amounts')
                ? 'bi bi-eye-slash' : 'bi bi-eye';
        }

        // ---- Currency formatting ----
        function formatCurrency(n) {
            if (n == null || isNaN(n)) return '-';
            const neg = n < 0;
            const abs = Math.abs(n);
            const formatted = abs.toLocaleString('en-IN', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            return (neg ? '-' : '') + '\u20B9' + formatted;
        }

        // ---- Toast ----
        function showToast(msg, type = 'success') {
            const container = document.getElementById('toastContainer');
            const bg = type === 'success' ? 'bg-success' : type === 'danger' ? 'bg-danger' : 'bg-warning';
            const html = `<div class="toast align-items-center text-white ${bg} border-0 show" role="alert">
                <div class="d-flex"><div class="toast-body">${msg}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div></div>`;
            container.insertAdjacentHTML('beforeend', html);
            const el = container.lastElementChild;
            setTimeout(() => el.remove(), 3000);
        }

        // ---- Save tax slab ----
        async function saveTaxSlab() {
            const val = parseFloat(document.getElementById('taxSlabSelect').value);
            try {
                const res = await fetch(`/api/investors/${INVESTOR_ID}/tax-slab`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ tax_slab_pct: val })
                });
                if (res.ok) {
                    showToast('Tax slab saved');
                    loadAnalysis();
                } else {
                    showToast('Failed to save', 'danger');
                }
            } catch (e) {
                showToast('Error: ' + e.message, 'danger');
            }
        }

        // ---- Load analysis ----
        async function loadAnalysis() {
            const slab = document.getElementById('taxSlabSelect').value;
            try {
                const res = await fetch(`/api/investors/${INVESTOR_ID}/tax-harvesting?tax_slab=${slab}`);
                analysisData = await res.json();
                renderSummary(analysisData);
                renderUrgencyAlerts(analysisData.opportunities);
                renderWarnings(analysisData.warnings);
                renderRealizedGains(analysisData.realized_gains);
                renderOpportunities(analysisData.opportunities);
            } catch (e) {
                showToast('Failed to load analysis: ' + e.message, 'danger');
            }
        }

        // ---- Render summary cards ----
        function renderSummary(data) {
            const s = data.summary;
            document.getElementById('totalLoss').textContent = formatCurrency(s.total_unrealized_loss);
            document.getElementById('totalTaxSaved').textContent = formatCurrency(s.total_tax_savings);
            document.getElementById('totalNetBenefit').textContent = formatCurrency(s.total_net_benefit);
            document.getElementById('oppCount').textContent = s.opportunity_count;
            const urgentLabel = document.getElementById('urgentLabel');
            if (s.urgent_count > 0) {
                urgentLabel.innerHTML = `<span class="urgent-badge">${s.urgent_count} urgent</span>`;
            } else {
                urgentLabel.textContent = '';
            }
        }

        // ---- Urgency alerts ----
        function renderUrgencyAlerts(opportunities) {
            const urgent = opportunities.filter(o => o.urgent);
            const container = document.getElementById('urgencyAlerts');
            if (!urgent.length) { container.style.display = 'none'; return; }
            container.style.display = 'block';
            container.innerHTML = urgent.map(o => `
                <div class="urgency-alert mb-2">
                    <i class="bi bi-exclamation-triangle-fill text-warning"></i>
                    <strong>${o.fund_name}</strong> &mdash; lot from ${o.lot_date} becomes long-term in
                    <strong>${o.urgency_days_remaining} days</strong>.
                    Selling now saves <span class="mask-amount">${formatCurrency(o.net_benefit)}</span> net.
                    STCL converts to LTCL (offsets only LTCG, not STCG).
                </div>
            `).join('');
        }

        // ---- Warnings ----
        function renderWarnings(warnings) {
            const container = document.getElementById('warningsSection');
            if (!warnings || !warnings.length) { container.style.display = 'none'; return; }
            container.style.display = 'block';
            container.innerHTML = warnings.map(w => `
                <div class="warning-banner mb-2">
                    <i class="bi bi-exclamation-circle text-warning"></i> ${w}
                </div>
            `).join('');
        }

        // ---- Realized gains ----
        function renderRealizedGains(rg) {
            const stcgEl = document.getElementById('eqStcg');
            const ltcgEl = document.getElementById('eqLtcg');
            const debtEl = document.getElementById('debtGains');

            stcgEl.textContent = formatCurrency(rg.equity_stcg);
            ltcgEl.textContent = formatCurrency(rg.equity_ltcg);
            debtEl.textContent = formatCurrency(rg.debt_gains);

            // Color the links based on gain/loss
            stcgEl.style.color = rg.equity_stcg >= 0 ? '#198754' : '#dc3545';
            ltcgEl.style.color = rg.equity_ltcg >= 0 ? '#198754' : '#dc3545';
            debtEl.style.color = rg.debt_gains >= 0 ? '#198754' : '#dc3545';

            const used = rg.ltcg_exemption_used || 0;
            const pct = Math.min(100, (used / 125000) * 100);
            document.getElementById('exemptionBar').style.width = pct + '%';
            document.getElementById('exemptionLabel').textContent =
                `${formatCurrency(used)} used / ${formatCurrency(rg.ltcg_exemption_remaining)} remaining`;
        }

        // ---- Show gain details modal ----
        function showGainDetails(gainType) {
            if (!analysisData || !analysisData.realized_gains) return;
            const rg = analysisData.realized_gains;
            const titles = {
                'equity_stcg': 'Equity Short-Term Capital Gains — Sale Details',
                'equity_ltcg': 'Equity Long-Term Capital Gains — Sale Details',
                'debt_gains': 'Debt / Other Gains — Sale Details',
            };
            const details = rg[gainType + '_details'] || [];
            document.getElementById('gainDetailTitle').textContent = titles[gainType] || 'Sale Details';

            const tbody = document.getElementById('gainDetailBody');
            if (!details.length) {
                tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted py-3">No sale transactions in this category for the current FY.</td></tr>`;
                document.getElementById('gainDetailTotal').textContent = '-';
            } else {
                // Group by tx_id (one redemption = one group)
                const groups = {};
                const groupOrder = [];
                details.forEach(d => {
                    if (!groups[d.tx_id]) {
                        groups[d.tx_id] = [];
                        groupOrder.push(d.tx_id);
                    }
                    groups[d.tx_id].push(d);
                });

                let grandTotal = 0;
                let html = '';

                groupOrder.forEach(txId => {
                    const lots = groups[txId];
                    const first = lots[0];
                    const totalUnits = lots.reduce((s, l) => s + l.units_sold, 0);
                    const totalGain = lots.reduce((s, l) => s + l.realized_gain, 0);
                    const gainClass = totalGain >= 0 ? 'gain' : 'loss';
                    grandTotal += totalGain;

                    // Transaction summary row (clickable)
                    html += `<tr class="sale-tx-row" style="cursor:pointer" onclick="toggleSaleDetail(${txId})">
                        <td class="text-center">
                            <i class="bi bi-chevron-right sale-chevron" id="sale-chev-${txId}" style="transition:transform 0.2s; display:inline-block; font-size:0.8rem;"></i>
                        </td>
                        <td>
                            <a href="/folio/${first.folio_id}" class="text-decoration-none fw-semibold">${first.scheme_name}</a>
                            <br><small class="text-muted">Folio: ${first.folio_number}</small>
                        </td>
                        <td>${first.sell_date}</td>
                        <td class="text-end">${totalUnits.toFixed(3)}</td>
                        <td class="text-end">${'\u20B9' + first.sell_nav.toFixed(2)}</td>
                        <td class="text-end ${gainClass} fw-semibold">${formatCurrency(totalGain)}</td>
                        <td>
                            <a href="/folio/${first.folio_id}" class="btn btn-sm btn-outline-secondary" title="View Folio">
                                <i class="bi bi-box-arrow-up-right"></i>
                            </a>
                        </td>
                    </tr>`;

                    // FIFO lot sub-header (hidden)
                    html += `<tr class="fifo-row-${txId}" style="display:none">
                        <td></td>
                        <td colspan="6">
                            <table class="table table-sm table-borderless mb-0" style="font-size:0.85rem;">
                                <thead><tr class="text-muted">
                                    <th>Buy Date</th>
                                    <th class="text-end">Lot Units</th>
                                    <th class="text-end">Buy NAV</th>
                                    <th class="text-end">Gain/Loss</th>
                                    <th class="text-end">Days Held</th>
                                </tr></thead>
                                <tbody>`;
                    lots.forEach(lot => {
                        const lotGainClass = lot.realized_gain >= 0 ? 'gain' : 'loss';
                        html += `<tr>
                            <td>${lot.buy_date}</td>
                            <td class="text-end">${lot.units_sold.toFixed(3)}</td>
                            <td class="text-end">${'\u20B9' + lot.buy_nav.toFixed(2)}</td>
                            <td class="text-end ${lotGainClass}">${formatCurrency(lot.realized_gain)}</td>
                            <td class="text-end">${lot.holding_days}d</td>
                        </tr>`;
                    });
                    html += `</tbody></table></td></tr>`;
                });

                tbody.innerHTML = html;
                const totalClass = grandTotal >= 0 ? 'gain' : 'loss';
                document.getElementById('gainDetailTotal').innerHTML = `<span class="${totalClass}">${formatCurrency(grandTotal)}</span>`;
            }

            const modal = new bootstrap.Modal(document.getElementById('gainDetailModal'));
            modal.show();
        }

        function toggleSaleDetail(txId) {
            const rows = document.querySelectorAll(`.fifo-row-${txId}`);
            const chevron = document.getElementById(`sale-chev-${txId}`);
            const visible = rows.length > 0 && rows[0].style.display !== 'none';
            rows.forEach(r => r.style.display = visible ? 'none' : '');
            if (chevron) chevron.style.transform = visible ? '' : 'rotate(90deg)';
        }

        // ---- Opportunities table ----
        function renderOpportunities(opps) {
            const container = document.getElementById('opportunitiesSection');
            if (!opps.length) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-emoji-smile"></i>
                        <h5 class="mt-3">No harvesting opportunities</h5>
                        <p>None of your holdings have loss lots with positive net benefit after costs.</p>
                    </div>`;
                return;
            }

            let html = `<div class="table-responsive"><table class="table table-hover mb-0">
                <thead><tr>
                    <th></th><th>Fund</th><th>Lot Date</th><th>Units</th><th>Loss</th>
                    <th>Type</th><th>Tax Saved</th><th>Costs</th><th>Net Benefit</th>
                    <th>Exit Load</th><th></th>
                </tr></thead><tbody>`;

            opps.forEach((o, idx) => {
                const urgentBadge = o.urgent
                    ? `<span class="urgent-badge ms-1">${o.urgency_days_remaining}d</span>` : '';
                html += `
                <tr class="opportunity-row" onclick="toggleOpportunityDetail(${idx})">
                    <td><i class="bi bi-chevron-down chevron-icon" id="chevron-${idx}"></i></td>
                    <td><strong>${o.fund_name}</strong>${urgentBadge}<br><small class="text-muted">${o.amc || ''}</small></td>
                    <td>${o.lot_date}</td>
                    <td>${o.lot_units}</td>
                    <td class="loss mask-amount">${formatCurrency(o.unrealized_loss)}</td>
                    <td><span class="badge ${o.is_long_term ? 'bg-info' : 'bg-secondary'}">${o.gain_type}</span>
                        <br><small>${o.tax_type} @ ${o.tax_rate}%</small></td>
                    <td class="gain mask-amount">${formatCurrency(o.tax_savings)}</td>
                    <td class="mask-amount">${formatCurrency(o.total_costs)}</td>
                    <td class="gain fw-bold mask-amount">${formatCurrency(o.net_benefit)}</td>
                    <td>
                        <div class="d-flex align-items-center" onclick="event.stopPropagation()">
                            <input type="number" class="form-control form-control-sm exit-load-input"
                                   value="${o.exit_load_pct}" step="0.1" min="0" max="5"
                                   id="exitLoad-${idx}" onchange="updateExitLoad(${o.mf_id}, this.value)">
                            <small class="ms-1">%</small>
                        </div>
                    </td>
                    <td>${o.holding_days}d</td>
                </tr>
                <tr id="detail-${idx}" style="display:none;">
                    <td colspan="11" class="p-0">
                        <div class="similar-fund-panel mx-3 my-2">
                            <h6 class="mb-2"><i class="bi bi-arrow-repeat"></i> Similar Funds to Switch Into</h6>
                            ${renderSimilarFunds(o.similar_funds)}
                        </div>
                    </td>
                </tr>`;
            });

            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        function renderSimilarFunds(funds) {
            if (!funds || !funds.length) {
                return '<p class="text-muted mb-0">No similar funds found. Classify funds by category and geography on the Mutual Funds page.</p>';
            }
            let html = '<div class="table-responsive"><table class="table table-sm mb-0"><thead><tr><th>Fund</th><th>AMC</th><th>NAV</th><th>Cap Split</th></tr></thead><tbody>';
            funds.forEach(f => {
                const name = f.display_name || f.amfi_scheme_name || f.scheme_name;
                html += `<tr>
                    <td>${name}</td>
                    <td><small>${f.amc || '-'}</small></td>
                    <td>${f.current_nav ? '\u20B9' + f.current_nav.toFixed(2) : '-'}</td>
                    <td><small>L:${f.large_cap_pct}% M:${f.mid_cap_pct}% S:${f.small_cap_pct}%</small></td>
                </tr>`;
            });
            html += '</tbody></table></div>';
            return html;
        }

        // ---- Toggle detail row ----
        function toggleOpportunityDetail(idx) {
            const row = document.getElementById(`detail-${idx}`);
            const chevron = document.getElementById(`chevron-${idx}`);
            const visible = row.style.display !== 'none';
            row.style.display = visible ? 'none' : '';
            chevron.classList.toggle('open', !visible);
        }

        // ---- Update exit load ----
        async function updateExitLoad(mfId, val) {
            try {
                const res = await fetch(`/api/mutual-funds/${mfId}/exit-load`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ exit_load_pct: parseFloat(val) })
                });
                if (res.ok) {
                    showToast('Exit load updated');
                    loadAnalysis();
                } else {
                    showToast('Failed to update', 'danger');
                }
            } catch (e) {
                showToast('Error: ' + e.message, 'danger');
            }
        }
    </script>
    {% include '_feature_request_widget.html' %}
</body>
</html>
