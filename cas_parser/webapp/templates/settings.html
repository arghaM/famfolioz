<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Famfolio - Settings</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        .action-card {
            border-left: 4px solid #667eea;
            transition: transform 0.2s;
        }
        .action-card:hover {
            transform: translateY(-2px);
        }
        .action-card.danger {
            border-left-color: #dc3545;
        }
        .action-card.success {
            border-left-color: #28a745;
        }
        .action-card.warning {
            border-left-color: #ffc107;
        }
        .backup-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
        }
        .backup-item:hover {
            background: #e9ecef;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="container">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <a href="/" class="text-white text-decoration-none">
                        <i class="bi bi-arrow-left"></i> Back to Dashboard
                    </a>
                    <h1 class="mt-3"><i class="bi bi-gear"></i> Settings</h1>
                    <p class="mb-0">Manage folios, ISIN resolution, quarantine, and more</p>
                </div>
                {% include '_auth_nav.html' %}
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Backup & Restore Link Card -->
        <div class="row mb-4">
            <div class="col-12">
                <a href="/settings/backup" class="text-decoration-none">
                    <div class="card action-card shadow-sm" style="border-left-color: #0dcaf0;">
                        <div class="card-body d-flex align-items-center justify-content-between py-3">
                            <div>
                                <h5 class="mb-1 text-dark"><i class="bi bi-shield-check text-info"></i> Backup & Restore</h5>
                                <p class="text-muted mb-0 small">Full database backups, config-only backups, restore from file upload, and database reset</p>
                            </div>
                            <i class="bi bi-chevron-right text-muted fs-4"></i>
                        </div>
                    </div>
                </a>
            </div>
        </div>

        <!-- User Management Section -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-people"></i> User Management</h5>
                <button class="btn btn-sm btn-success" onclick="showAddUserModal()">
                    <i class="bi bi-person-plus"></i> Add User
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-striped table-hover align-middle mb-0" id="usersTable" style="display:none;">
                        <thead class="table-light">
                            <tr>
                                <th>Username</th>
                                <th>Display Name</th>
                                <th>Role</th>
                                <th>Accessible Investors</th>
                                <th>Status</th>
                                <th>Last Login</th>
                                <th class="text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersBody"></tbody>
                    </table>
                </div>
                <div id="usersLoading" class="text-center py-3">
                    <div class="spinner-border spinner-border-sm" role="status"></div>
                    Loading users...
                </div>
            </div>
        </div>

        <!-- Add/Edit User Modal -->
        <div class="modal fade" id="userModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="userModalTitle">Add User</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div id="userModalError" class="alert alert-danger py-2" style="display:none;"></div>
                        <input type="hidden" id="editUserId">
                        <div class="mb-3">
                            <label class="form-label">Username</label>
                            <input type="text" class="form-control" id="userUsername" pattern="[a-zA-Z0-9_]+" required>
                            <div class="form-text">Letters, numbers, underscores only</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Display Name</label>
                            <input type="text" class="form-control" id="userDisplayName" required>
                        </div>
                        <div class="mb-3" id="passwordGroup">
                            <label class="form-label">Password</label>
                            <input type="password" class="form-control" id="userPassword">
                            <div class="form-text">Minimum 4 characters</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Role</label>
                            <select class="form-select" id="userRole">
                                <option value="member">Member</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Own Portfolio <small class="text-muted">(the investor this user represents)</small></label>
                            <select class="form-select" id="userInvestorId">
                                <option value="">None</option>
                            </select>
                        </div>
                        <div class="mb-3" id="custodianGroup" style="display:none;">
                            <label class="form-label">Additional Investor Access <small class="text-muted">(custodian)</small></label>
                            <div id="custodianList" class="mb-2"></div>
                            <div class="input-group input-group-sm">
                                <select class="form-select" id="addCustodianSelect">
                                    <option value="">Grant access to...</option>
                                </select>
                                <button class="btn btn-outline-success" type="button" onclick="addCustodianAccess()">
                                    <i class="bi bi-plus"></i> Add
                                </button>
                            </div>
                            <div class="form-text">This user can view and manage these additional portfolios</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="userModalSave" onclick="saveUser()">Save</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reset Password Modal -->
        <div class="modal fade" id="resetPwModal" tabindex="-1">
            <div class="modal-dialog modal-sm">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Reset Password</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div id="resetPwError" class="alert alert-danger py-2" style="display:none;"></div>
                        <input type="hidden" id="resetPwUserId">
                        <p class="mb-2">Reset password for <strong id="resetPwUsername"></strong></p>
                        <div class="mb-3">
                            <label class="form-label">New Password</label>
                            <input type="password" class="form-control" id="resetPwInput">
                            <div class="form-text">Minimum 4 characters</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-warning" onclick="resetPassword()">Reset Password</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Folio Management Section -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-folder2-open"></i> Folio Management</h5>
                <div>
                    <span id="folioCountBadges"></span>
                    <button class="btn btn-sm btn-outline-primary ms-2" onclick="loadAllFolios()">
                        <i class="bi bi-arrow-clockwise"></i> Refresh
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <input type="text" class="form-control form-control-sm" id="folioSearchInput"
                               placeholder="Search by scheme name, folio number, or investor..."
                               oninput="filterFolios()">
                    </div>
                    <div class="col-md-3">
                        <select class="form-select form-select-sm" id="folioFilterSelect" onchange="filterFolios()">
                            <option value="all">All Folios</option>
                            <option value="assigned">Assigned Only</option>
                            <option value="unassigned">Unassigned Only</option>
                        </select>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm table-striped table-hover align-middle mb-0" id="folioMgmtTable" style="display:none;">
                        <thead class="table-light">
                            <tr>
                                <th>Folio Number</th>
                                <th>Scheme Name</th>
                                <th>AMC</th>
                                <th>Investor</th>
                                <th class="text-end">Value</th>
                                <th class="text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="folioMgmtBody"></tbody>
                    </table>
                </div>
                <div id="folioMgmtLoading" class="text-center py-3">
                    <div class="spinner-border spinner-border-sm" role="status"></div>
                    Loading folios...
                </div>
                <div id="folioMgmtEmpty" class="text-center py-3 text-muted" style="display:none;">
                    No folios found
                </div>
            </div>
        </div>

        <!-- ISIN Resolver Section -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-search"></i> ISIN Resolver</h5>
            </div>
            <div class="card-body">
                <p class="text-muted">
                    When PDF extraction truncates ISINs, the resolver uses AMFI database and manual mappings to recover full ISINs.
                </p>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6><i class="bi bi-database"></i> AMFI Database</h6>
                                <p class="small text-muted mb-2">Official mutual fund database from AMFI India</p>
                                <div class="d-flex align-items-center">
                                    <span id="amfiStatus" class="badge bg-secondary me-2">Loading...</span>
                                    <button class="btn btn-sm btn-primary" onclick="refreshAmfi()" id="refreshAmfiBtn">
                                        <i class="bi bi-arrow-clockwise"></i> Refresh AMFI Data
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6><i class="bi bi-pencil-square"></i> Manual Mappings</h6>
                                <p class="small text-muted mb-2">Custom scheme name to ISIN mappings</p>
                                <span id="manualMappingsCount" class="badge bg-info">0 mappings</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Add Manual Mapping -->
                <div class="card bg-light mb-3">
                    <div class="card-body">
                        <h6>Add Manual ISIN Mapping</h6>
                        <p class="small text-muted">Use this when automatic resolution fails. The scheme pattern will be matched (case-insensitive) against scheme names.</p>
                        <div class="row g-2">
                            <div class="col-md-5">
                                <input type="text" class="form-control form-control-sm" id="schemePatternInput" placeholder="Scheme pattern (e.g., 'Multi-Asset Fund')">
                            </div>
                            <div class="col-md-4">
                                <input type="text" class="form-control form-control-sm" id="isinInput" placeholder="ISIN (e.g., INF109K015K4)" maxlength="12">
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-success btn-sm w-100" onclick="addMapping()">
                                    <i class="bi bi-plus"></i> Add Mapping
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Current Mappings -->
                <div id="mappingsList"></div>

                <!-- ISIN Search -->
                <div class="card bg-light mb-3">
                    <div class="card-body">
                        <h6><i class="bi bi-search"></i> Search ISIN by Scheme Name</h6>
                        <p class="small text-muted">Search the AMFI database to find the correct ISIN for any scheme.</p>
                        <div class="input-group">
                            <input type="text" class="form-control" id="isinSearchInput" placeholder="Enter scheme name (e.g., 'ICICI Multi Asset')">
                            <button class="btn btn-primary" onclick="searchIsin()">
                                <i class="bi bi-search"></i> Search
                            </button>
                        </div>
                        <div id="searchResults" class="mt-2"></div>
                    </div>
                </div>

                <!-- Unresolved ISINs -->
                <div class="mt-3">
                    <h6><i class="bi bi-exclamation-circle text-warning"></i> Unresolved ISINs in Database</h6>
                    <p class="small text-muted">These funds have missing or invalid ISINs. Green suggestions are auto-detected from AMFI database.</p>
                    <div id="unresolvedList"></div>
                </div>
            </div>
        </div>

        <!-- Quarantine Section -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-inbox text-warning"></i> Quarantined Items</h5>
                <button class="btn btn-sm btn-outline-primary" onclick="loadQuarantine()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle"></i> When PDF parsing encounters broken/truncated ISINs, the related holdings and transactions are quarantined here.
                    Once you provide the correct ISIN, re-import the CAS PDF to import the data properly.
                </div>

                <div id="quarantineStats" class="mb-3">
                    <span class="badge bg-secondary">Loading...</span>
                </div>

                <div id="quarantineList">
                    <div class="text-center py-3">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                        Loading quarantine...
                    </div>
                </div>
            </div>
        </div>

        <!-- Feature Requests -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-lightbulb text-primary"></i> Feature Requests</h5>
                <button class="btn btn-sm btn-outline-primary" onclick="loadFeatureRequests()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
            </div>
            <div class="card-body">
                <div id="featureRequestsList">
                    <div class="text-center py-3">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                        Loading feature requests...
                    </div>
                </div>
            </div>
        </div>

        <!-- Manual Asset Types (Admin only) -->
        {% if current_user and current_user.role == 'admin' %}
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-wallet2"></i> Manual Asset Types</h5>
                <button class="btn btn-sm btn-success" onclick="showAddAssetTypeForm()">
                    <i class="bi bi-plus"></i> Add Type
                </button>
            </div>
            <div class="card-body">
                <p class="text-muted small mb-3">Configure which asset types appear in the Manual Assets page.</p>

                <!-- Add Type Inline Form (hidden by default) -->
                <div id="addAssetTypeForm" class="card bg-light mb-3" style="display:none;">
                    <div class="card-body">
                        <div class="row g-2 align-items-end">
                            <div class="col-md-3">
                                <label class="form-label small">Key</label>
                                <input type="text" class="form-control form-control-sm" id="newTypeKey" placeholder="e.g., real_estate">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small">Label</label>
                                <input type="text" class="form-control form-control-sm" id="newTypeLabel" placeholder="e.g., Real Estate">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label small">Icon (Bootstrap)</label>
                                <input type="text" class="form-control form-control-sm" id="newTypeIcon" placeholder="bi-house" value="bi-box">
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-success btn-sm w-100" onclick="addAssetType()">
                                    <i class="bi bi-plus"></i> Add
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Asset Types List -->
                <div id="assetTypesList">
                    <div class="text-center py-3">
                        <div class="spinner-border spinner-border-sm" role="status"></div>
                        Loading...
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Status Log -->
        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <h5 class="mb-0"><i class="bi bi-terminal"></i> Activity Log</h5>
            </div>
            <div class="card-body">
                <div id="logArea" class="bg-dark text-light p-3 rounded" style="max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 0.85rem;">
                    <div class="text-muted">Ready.</div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function log(message, type = 'info') {
            const logArea = document.getElementById('logArea');
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type === 'error' ? 'text-danger' : (type === 'success' ? 'text-success' : 'text-info');
            logArea.innerHTML += `<div class="${colorClass}">[${timestamp}] ${message}</div>`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        // ==================== User Management Functions ====================

        let usersData = [];
        let investorsForUsers = [];
        let custodianData = {}; // userId -> [{investor_id, investor_name, custodian_user_id, id}]

        async function loadUsers() {
            const loading = document.getElementById('usersLoading');
            const table = document.getElementById('usersTable');
            loading.style.display = '';
            table.style.display = 'none';

            try {
                const [usersRes, investorsRes] = await Promise.all([
                    fetch('/api/users'),
                    fetch('/api/investors')
                ]);
                usersData = await usersRes.json();
                investorsForUsers = await investorsRes.json();

                // Load custodian access for each user
                custodianData = {};
                await Promise.all(investorsForUsers.map(async inv => {
                    try {
                        const res = await fetch(`/api/investors/${inv.id}/custodians`);
                        if (res.ok) {
                            const custodians = await res.json();
                            for (const c of custodians) {
                                if (!custodianData[c.custodian_user_id]) custodianData[c.custodian_user_id] = [];
                                custodianData[c.custodian_user_id].push({
                                    id: c.id,
                                    investor_id: inv.id,
                                    investor_name: inv.name
                                });
                            }
                        }
                    } catch(e) {}
                }));

                loading.style.display = 'none';
                renderUsersTable();
                table.style.display = '';

                // Populate investor dropdowns in modal
                const invOptions = investorsForUsers.map(inv =>
                    `<option value="${inv.id}">${inv.name}${inv.pan ? ' (' + inv.pan + ')' : ''}</option>`
                ).join('');
                document.getElementById('userInvestorId').innerHTML = '<option value="">None</option>' + invOptions;
                document.getElementById('addCustodianSelect').innerHTML = '<option value="">Grant access to...</option>' + invOptions;
            } catch(e) {
                loading.innerHTML = '<span class="text-danger">Failed to load users</span>';
            }
        }

        function renderUsersTable() {
            const tbody = document.getElementById('usersBody');
            let html = '';
            for (const u of usersData) {
                const roleBadge = u.role === 'admin'
                    ? '<span class="badge bg-warning text-dark">Admin</span>'
                    : '<span class="badge bg-info">Member</span>';
                const statusBadge = u.is_active
                    ? '<span class="badge bg-success">Active</span>'
                    : '<span class="badge bg-secondary">Disabled</span>';
                const lastLogin = u.last_login
                    ? new Date(u.last_login).toLocaleDateString()
                    : '<span class="text-muted">Never</span>';

                // Build accessible investors list
                let investorBadges = '';
                if (u.role === 'admin') {
                    investorBadges = '<span class="badge bg-warning text-dark">All (admin)</span>';
                } else {
                    const badges = [];
                    if (u.investor_id) {
                        const own = investorsForUsers.find(i => i.id === u.investor_id);
                        badges.push(`<span class="badge bg-primary">${own ? own.name : '#' + u.investor_id}</span>`);
                    }
                    const custodians = custodianData[u.id] || [];
                    for (const c of custodians) {
                        badges.push(`<span class="badge bg-outline-secondary border">${c.investor_name}</span>`);
                    }
                    investorBadges = badges.length > 0 ? badges.join(' ') : '<span class="text-muted">â€”</span>';
                }

                html += `<tr${!u.is_active ? ' class="table-secondary"' : ''}>
                    <td><code>${u.username}</code></td>
                    <td>${u.display_name}</td>
                    <td>${roleBadge}</td>
                    <td>${investorBadges}</td>
                    <td>${statusBadge}</td>
                    <td><small>${lastLogin}</small></td>
                    <td class="text-center">
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="editUser(${u.id})" title="Edit">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-outline-warning" onclick="showResetPw(${u.id}, '${u.username}')" title="Reset Password">
                                <i class="bi bi-key"></i>
                            </button>
                            <button class="btn btn-outline-${u.is_active ? 'danger' : 'success'}"
                                    onclick="toggleUserActive(${u.id}, ${u.is_active ? 0 : 1})"
                                    title="${u.is_active ? 'Disable' : 'Enable'}">
                                <i class="bi bi-${u.is_active ? 'person-x' : 'person-check'}"></i>
                            </button>
                        </div>
                    </td>
                </tr>`;
            }
            tbody.innerHTML = html || '<tr><td colspan="7" class="text-center text-muted">No users</td></tr>';
        }

        function showAddUserModal() {
            document.getElementById('editUserId').value = '';
            document.getElementById('userModalTitle').textContent = 'Add User';
            document.getElementById('userUsername').value = '';
            document.getElementById('userUsername').disabled = false;
            document.getElementById('userDisplayName').value = '';
            document.getElementById('userPassword').value = '';
            document.getElementById('passwordGroup').style.display = '';
            document.getElementById('userRole').value = 'member';
            document.getElementById('userInvestorId').value = '';
            document.getElementById('userModalError').style.display = 'none';
            document.getElementById('custodianGroup').style.display = 'none';
            document.getElementById('custodianList').innerHTML = '';
            new bootstrap.Modal(document.getElementById('userModal')).show();
        }

        function editUser(userId) {
            const u = usersData.find(x => x.id === userId);
            if (!u) return;
            document.getElementById('editUserId').value = u.id;
            document.getElementById('userModalTitle').textContent = 'Edit User';
            document.getElementById('userUsername').value = u.username;
            document.getElementById('userUsername').disabled = true;
            document.getElementById('userDisplayName').value = u.display_name;
            document.getElementById('userPassword').value = '';
            document.getElementById('passwordGroup').style.display = 'none';
            document.getElementById('userRole').value = u.role;
            document.getElementById('userInvestorId').value = u.investor_id || '';
            document.getElementById('userModalError').style.display = 'none';

            // Show custodian access section for existing users
            document.getElementById('custodianGroup').style.display = '';
            renderCustodianList(u.id);

            new bootstrap.Modal(document.getElementById('userModal')).show();
        }

        function renderCustodianList(userId) {
            const container = document.getElementById('custodianList');
            const custodians = custodianData[userId] || [];
            if (custodians.length === 0) {
                container.innerHTML = '<small class="text-muted">No additional access granted</small>';
                return;
            }
            container.innerHTML = custodians.map(c =>
                `<span class="badge bg-light text-dark border me-1 mb-1" style="font-size: 0.85rem;">
                    ${c.investor_name}
                    <button type="button" class="btn-close btn-close-sm ms-1" style="font-size: 0.5rem;"
                            onclick="removeCustodianAccess(${c.investor_id}, ${userId})" title="Remove access"></button>
                </span>`
            ).join('');
        }

        async function addCustodianAccess() {
            const userId = document.getElementById('editUserId').value;
            if (!userId) return;
            const investorId = document.getElementById('addCustodianSelect').value;
            if (!investorId) return;

            try {
                const res = await fetch(`/api/investors/${investorId}/custodians`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ user_id: parseInt(userId) })
                });
                const result = await res.json();
                if (res.ok) {
                    // Update local data
                    if (!custodianData[userId]) custodianData[userId] = [];
                    const inv = investorsForUsers.find(i => i.id == investorId);
                    custodianData[userId].push({
                        id: result.id,
                        investor_id: parseInt(investorId),
                        investor_name: inv ? inv.name : '#' + investorId
                    });
                    renderCustodianList(parseInt(userId));
                    renderUsersTable();
                    document.getElementById('addCustodianSelect').value = '';
                    log('Custodian access granted', 'success');
                } else {
                    alert(result.error || 'Failed to grant access');
                }
            } catch(e) {
                alert('Error: ' + e.message);
            }
        }

        async function removeCustodianAccess(investorId, userId) {
            if (!confirm('Remove this investor access?')) return;
            try {
                const res = await fetch(`/api/investors/${investorId}/custodians/${userId}`, { method: 'DELETE' });
                const result = await res.json();
                if (result.success) {
                    // Update local data
                    if (custodianData[userId]) {
                        custodianData[userId] = custodianData[userId].filter(c => c.investor_id !== investorId);
                    }
                    renderCustodianList(userId);
                    renderUsersTable();
                    log('Custodian access revoked', 'success');
                } else {
                    alert(result.error || 'Failed');
                }
            } catch(e) {
                alert('Error: ' + e.message);
            }
        }

        async function saveUser() {
            const errorEl = document.getElementById('userModalError');
            errorEl.style.display = 'none';
            const editId = document.getElementById('editUserId').value;
            const isEdit = !!editId;

            const data = {
                display_name: document.getElementById('userDisplayName').value.trim(),
                role: document.getElementById('userRole').value,
                investor_id: document.getElementById('userInvestorId').value || null
            };

            if (!isEdit) {
                data.username = document.getElementById('userUsername').value.trim();
                data.password = document.getElementById('userPassword').value;
                if (!data.username) { errorEl.textContent = 'Username is required'; errorEl.style.display = ''; return; }
                if (data.password.length < 4) { errorEl.textContent = 'Password must be at least 4 characters'; errorEl.style.display = ''; return; }
            }
            if (!data.display_name) { errorEl.textContent = 'Display name is required'; errorEl.style.display = ''; return; }

            try {
                const url = isEdit ? `/api/users/${editId}` : '/api/users';
                const method = isEdit ? 'PUT' : 'POST';
                const res = await fetch(url, {
                    method,
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (res.ok && (result.success || result.id)) {
                    bootstrap.Modal.getInstance(document.getElementById('userModal')).hide();
                    loadUsers();
                    log(isEdit ? 'User updated' : 'User created', 'success');
                } else {
                    errorEl.textContent = result.error || 'Failed to save';
                    errorEl.style.display = '';
                }
            } catch(e) {
                errorEl.textContent = 'Error: ' + e.message;
                errorEl.style.display = '';
            }
        }

        function showResetPw(userId, username) {
            document.getElementById('resetPwUserId').value = userId;
            document.getElementById('resetPwUsername').textContent = username;
            document.getElementById('resetPwInput').value = '';
            document.getElementById('resetPwError').style.display = 'none';
            new bootstrap.Modal(document.getElementById('resetPwModal')).show();
        }

        async function resetPassword() {
            const errorEl = document.getElementById('resetPwError');
            errorEl.style.display = 'none';
            const userId = document.getElementById('resetPwUserId').value;
            const password = document.getElementById('resetPwInput').value;
            if (password.length < 4) {
                errorEl.textContent = 'Password must be at least 4 characters';
                errorEl.style.display = '';
                return;
            }
            try {
                const res = await fetch(`/api/users/${userId}/reset-password`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ password })
                });
                const result = await res.json();
                if (result.success) {
                    bootstrap.Modal.getInstance(document.getElementById('resetPwModal')).hide();
                    log('Password reset successfully', 'success');
                } else {
                    errorEl.textContent = result.error || 'Failed';
                    errorEl.style.display = '';
                }
            } catch(e) {
                errorEl.textContent = 'Error: ' + e.message;
                errorEl.style.display = '';
            }
        }

        async function toggleUserActive(userId, newActive) {
            const action = newActive ? 'enable' : 'disable';
            if (!confirm(`Are you sure you want to ${action} this user?`)) return;
            try {
                const res = await fetch(`/api/users/${userId}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ is_active: newActive })
                });
                const result = await res.json();
                if (result.success) {
                    loadUsers();
                    log(`User ${action}d`, 'success');
                } else {
                    alert(result.error || 'Failed');
                }
            } catch(e) {
                alert('Error: ' + e.message);
            }
        }

        // Load users on page load
        loadUsers();

        // ==================== Folio Management Functions ====================

        let allFoliosData = [];
        let allInvestorsData = [];

        async function loadAllFolios() {
            const loading = document.getElementById('folioMgmtLoading');
            const table = document.getElementById('folioMgmtTable');
            const empty = document.getElementById('folioMgmtEmpty');
            loading.style.display = '';
            table.style.display = 'none';
            empty.style.display = 'none';

            try {
                const [foliosRes, investorsRes] = await Promise.all([
                    fetch('/api/folios/all'),
                    fetch('/api/investors')
                ]);
                allFoliosData = await foliosRes.json();
                allInvestorsData = await investorsRes.json();

                loading.style.display = 'none';

                if (!allFoliosData.length) {
                    empty.style.display = '';
                    return;
                }

                // Update count badges
                const total = allFoliosData.length;
                const assigned = allFoliosData.filter(f => f.investor_id).length;
                const unassigned = total - assigned;
                document.getElementById('folioCountBadges').innerHTML =
                    `<span class="badge bg-secondary">${total} Total</span> ` +
                    `<span class="badge bg-success">${assigned} Assigned</span> ` +
                    (unassigned > 0 ? `<span class="badge bg-danger">${unassigned} Unassigned</span>` : '');

                renderFolioTable();
                table.style.display = '';
            } catch(e) {
                console.error('Failed to load folios:', e);
                loading.style.display = 'none';
                empty.style.display = '';
                empty.textContent = 'Failed to load folios';
            }
        }

        function renderFolioTable() {
            const tbody = document.getElementById('folioMgmtBody');
            const search = (document.getElementById('folioSearchInput').value || '').toLowerCase();
            const filter = document.getElementById('folioFilterSelect').value;

            let filtered = allFoliosData;
            if (filter === 'assigned') filtered = filtered.filter(f => f.investor_id);
            if (filter === 'unassigned') filtered = filtered.filter(f => !f.investor_id);
            if (search) {
                filtered = filtered.filter(f =>
                    (f.scheme_name || '').toLowerCase().includes(search) ||
                    (f.folio_number || '').toLowerCase().includes(search) ||
                    (f.investor_name || '').toLowerCase().includes(search) ||
                    (f.amc || '').toLowerCase().includes(search)
                );
            }

            if (!filtered.length) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No matching folios</td></tr>';
                return;
            }

            const investorOptions = allInvestorsData.map(inv =>
                `<option value="${inv.id}">${inv.name}${inv.pan ? ' (' + inv.pan + ')' : ''}</option>`
            ).join('');

            let rows = '';
            for (const f of filtered) {
                const val = f.current_value ? Number(f.current_value).toLocaleString('en-IN', {style: 'currency', currency: 'INR', maximumFractionDigits: 0}) : '-';
                const schemeName = (f.scheme_name || '').length > 40
                    ? f.scheme_name.substring(0, 40) + '...' : (f.scheme_name || '');

                let investorCell, actionsCell;
                if (f.investor_id) {
                    investorCell = `<span class="text-success fw-semibold">${f.investor_name}</span>`;
                    actionsCell = `
                        <div class="d-flex gap-1 justify-content-center align-items-center">
                            <select class="form-select form-select-sm" style="width:140px;font-size:0.75rem;"
                                    id="reassign-${f.id}" title="Reassign to another investor">
                                <option value="">Reassign...</option>
                                ${investorOptions}
                            </select>
                            <button class="btn btn-sm btn-outline-primary px-1 py-0" onclick="reassignFolio(${f.id})" title="Reassign">
                                <i class="bi bi-arrow-repeat"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger px-1 py-0" onclick="unlinkFolio(${f.id}, '${(f.scheme_name || '').replace(/'/g, "\\'")}')">
                                <i class="bi bi-x-circle"></i>
                            </button>
                        </div>`;
                } else {
                    investorCell = '<span class="text-danger fst-italic">Unassigned</span>';
                    actionsCell = `
                        <div class="d-flex gap-1 justify-content-center align-items-center">
                            <select class="form-select form-select-sm" style="width:140px;font-size:0.75rem;"
                                    id="reassign-${f.id}" title="Assign to investor">
                                <option value="">Assign to...</option>
                                ${investorOptions}
                            </select>
                            <button class="btn btn-sm btn-outline-success px-1 py-0" onclick="reassignFolio(${f.id})" title="Assign">
                                <i class="bi bi-link-45deg"></i>
                            </button>
                        </div>`;
                }

                rows += `<tr>
                    <td><code class="small">${f.folio_number || '-'}</code></td>
                    <td title="${f.scheme_name || ''}">${schemeName}</td>
                    <td class="small">${f.amc || '-'}</td>
                    <td>${investorCell}</td>
                    <td class="text-end">${val}</td>
                    <td>${actionsCell}</td>
                </tr>`;
            }
            tbody.innerHTML = rows;
        }

        function filterFolios() {
            renderFolioTable();
        }

        async function reassignFolio(folioId) {
            const select = document.getElementById(`reassign-${folioId}`);
            const investorId = select ? select.value : '';
            if (!investorId) {
                select.focus();
                return;
            }
            try {
                const res = await fetch('/api/map-folios', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({investor_id: parseInt(investorId), folio_ids: [folioId]})
                });
                const result = await res.json();
                if (result.success) {
                    await loadAllFolios();
                    logActivity('Folio reassigned successfully');
                } else {
                    alert('Failed to reassign folio: ' + (result.error || 'Unknown error'));
                }
            } catch(e) {
                alert('Error reassigning folio: ' + e.message);
            }
        }

        async function unlinkFolio(folioId, schemeName) {
            if (!confirm(`Unlink "${schemeName}" from its investor?\n\nThe folio will become unassigned.`)) return;
            try {
                const res = await fetch('/api/unmap-folio', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({folio_id: folioId})
                });
                const result = await res.json();
                if (result.success) {
                    await loadAllFolios();
                    logActivity('Folio unlinked successfully');
                } else {
                    alert('Failed to unlink folio: ' + (result.error || 'Unknown error'));
                }
            } catch(e) {
                alert('Error unlinking folio: ' + e.message);
            }
        }

        // Load folios on page load
        loadAllFolios();

        // ==================== ISIN Resolver Functions ====================

        async function loadIsinResolverStatus() {
            try {
                const res = await fetch('/api/isin-resolver/status');
                const status = await res.json();

                // Update AMFI status
                const amfiStatus = document.getElementById('amfiStatus');
                if (status.amfi_scheme_count > 0) {
                    amfiStatus.className = 'badge bg-success me-2';
                    amfiStatus.textContent = `${status.amfi_scheme_count.toLocaleString()} schemes`;
                } else {
                    amfiStatus.className = 'badge bg-warning me-2';
                    amfiStatus.textContent = 'Not loaded';
                }

                // Update manual mappings count
                const mappingsCount = Object.keys(status.manual_mappings || {}).length;
                document.getElementById('manualMappingsCount').textContent = `${mappingsCount} mappings`;

                // Load mappings list
                loadMappingsList(status.manual_mappings);
            } catch (error) {
                console.error('Failed to load ISIN resolver status:', error);
            }
        }

        function loadMappingsList(mappings) {
            const container = document.getElementById('mappingsList');

            if (!mappings || Object.keys(mappings).length === 0) {
                container.innerHTML = '<p class="small text-muted">No manual mappings configured.</p>';
                return;
            }

            let html = '<table class="table table-sm table-striped"><thead><tr><th>Scheme Pattern</th><th>ISIN</th><th></th></tr></thead><tbody>';
            for (const [pattern, isin] of Object.entries(mappings)) {
                html += `<tr>
                    <td><code>${pattern}</code></td>
                    <td><code>${isin}</code></td>
                    <td><button class="btn btn-sm btn-outline-danger" onclick="deleteMapping('${pattern.replace(/'/g, "\\'")}')"><i class="bi bi-trash"></i></button></td>
                </tr>`;
            }
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        async function refreshAmfi() {
            const btn = document.getElementById('refreshAmfiBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Refreshing...';
            log('Fetching AMFI scheme database...');

            try {
                const res = await fetch('/api/isin-resolver/refresh-amfi', { method: 'POST' });
                const result = await res.json();

                if (result.success) {
                    log(`AMFI data refreshed: ${result.scheme_count.toLocaleString()} schemes loaded`, 'success');
                    loadIsinResolverStatus();
                } else {
                    log('Failed to refresh AMFI data: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                log('Failed to refresh AMFI data: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Refresh AMFI Data';
            }
        }

        async function addMapping() {
            const pattern = document.getElementById('schemePatternInput').value.trim();
            const isin = document.getElementById('isinInput').value.trim().toUpperCase();

            if (!pattern || !isin) {
                alert('Please enter both scheme pattern and ISIN');
                return;
            }

            if (isin.length !== 12 || !isin.startsWith('INF')) {
                alert('ISIN must be 12 characters starting with INF');
                return;
            }

            try {
                const res = await fetch('/api/isin-resolver/mappings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ scheme_pattern: pattern, isin: isin })
                });
                const result = await res.json();

                if (result.success) {
                    log(`Added mapping: '${pattern}' -> ${isin}`, 'success');
                    document.getElementById('schemePatternInput').value = '';
                    document.getElementById('isinInput').value = '';
                    loadIsinResolverStatus();
                } else {
                    log('Failed to add mapping: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                log('Failed to add mapping: ' + error.message, 'error');
            }
        }

        async function deleteMapping(pattern) {
            if (!confirm(`Delete mapping for '${pattern}'?`)) return;

            try {
                const res = await fetch(`/api/isin-resolver/mappings/${encodeURIComponent(pattern)}`, { method: 'DELETE' });
                const result = await res.json();

                if (result.success) {
                    log(`Deleted mapping: '${pattern}'`, 'success');
                    loadIsinResolverStatus();
                } else {
                    log('Failed to delete mapping', 'error');
                }
            } catch (error) {
                log('Failed to delete mapping: ' + error.message, 'error');
            }
        }

        async function loadUnresolvedIsins() {
            const container = document.getElementById('unresolvedList');

            try {
                const res = await fetch('/api/mutual-funds/unresolved-isins');
                const funds = await res.json();

                if (funds.length === 0) {
                    container.innerHTML = '<p class="small text-success"><i class="bi bi-check-circle"></i> All ISINs are valid!</p>';
                    return;
                }

                let html = '<table class="table table-sm"><thead><tr><th>Scheme Name</th><th>Current ISIN</th><th>Suggested</th><th>Action</th></tr></thead><tbody>';
                for (const fund of funds) {
                    const suggested = fund.suggested_isin;
                    const suggestedHtml = suggested
                        ? `<code class="text-success" title="Click to use" style="cursor:pointer" onclick="document.getElementById('fix-${fund.id}').value='${suggested}'">${suggested}</code> <i class="bi bi-check-circle text-success"></i>`
                        : `<span class="text-muted">Not found - <a href="#" onclick="searchScheme('${(fund.scheme_name || '').replace(/'/g, "\\'")}'); return false;">search</a></span>`;

                    html += `<tr>
                        <td>
                            <strong>${fund.scheme_name || '<em>Unknown</em>'}</strong>
                            ${fund.partial_isin ? `<br><small class="text-muted">Partial: ${fund.partial_isin}</small>` : ''}
                        </td>
                        <td><code class="text-danger">${fund.isin || 'MISSING'}</code></td>
                        <td>${suggestedHtml}</td>
                        <td>
                            <div class="input-group input-group-sm" style="width:200px">
                                <input type="text" class="form-control" placeholder="ISIN" id="fix-${fund.id}" maxlength="12" value="${suggested || ''}">
                                <button class="btn btn-success" onclick="fixIsin(${fund.id})"><i class="bi bi-check"></i></button>
                            </div>
                        </td>
                    </tr>`;
                }
                html += '</tbody></table>';
                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = `<p class="small text-danger">Failed to load: ${error.message}</p>`;
            }
        }

        function searchScheme(schemeName) {
            document.getElementById('isinSearchInput').value = schemeName;
            searchIsin();
            // Scroll to search section
            document.getElementById('isinSearchInput').scrollIntoView({ behavior: 'smooth' });
        }

        async function searchIsin() {
            const query = document.getElementById('isinSearchInput').value.trim();
            const container = document.getElementById('searchResults');

            if (query.length < 3) {
                container.innerHTML = '<p class="small text-muted">Enter at least 3 characters to search</p>';
                return;
            }

            container.innerHTML = '<div class="spinner-border spinner-border-sm"></div> Searching...';

            try {
                const res = await fetch(`/api/isin-resolver/search?q=${encodeURIComponent(query)}`);
                const results = await res.json();

                if (results.length === 0) {
                    container.innerHTML = '<p class="small text-warning">No matches found. Try different keywords or refresh AMFI data.</p>';
                    return;
                }

                let html = '<table class="table table-sm table-striped"><thead><tr><th>Scheme Name</th><th>ISIN</th><th>AMC</th><th></th></tr></thead><tbody>';
                for (const r of results) {
                    html += `<tr>
                        <td><small>${r.scheme_name}</small></td>
                        <td><code>${r.isin}</code></td>
                        <td><small class="text-muted">${r.amc || ''}</small></td>
                        <td>
                            <button class="btn btn-sm btn-outline-success" onclick="copyIsin('${r.isin}')">
                                <i class="bi bi-clipboard"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-primary" onclick="addMappingFromSearch('${r.isin}')">
                                <i class="bi bi-plus"></i> Map
                            </button>
                        </td>
                    </tr>`;
                }
                html += '</tbody></table>';
                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = `<p class="small text-danger">Search failed: ${error.message}</p>`;
            }
        }

        function copyIsin(isin) {
            navigator.clipboard.writeText(isin);
            log(`Copied ISIN: ${isin}`, 'success');
        }

        function addMappingFromSearch(isin) {
            const query = document.getElementById('isinSearchInput').value.trim();
            document.getElementById('schemePatternInput').value = query;
            document.getElementById('isinInput').value = isin;
            // Scroll to mapping section
            document.getElementById('schemePatternInput').scrollIntoView({ behavior: 'smooth' });
            log(`Ready to add mapping: '${query}' -> ${isin}. Click "Add Mapping" to save.`, 'info');
        }

        async function fixIsin(fundId) {
            const input = document.getElementById(`fix-${fundId}`);
            const isin = input.value.trim().toUpperCase();

            if (isin.length !== 12 || !isin.startsWith('INF')) {
                alert('ISIN must be 12 characters starting with INF');
                return;
            }

            try {
                const res = await fetch(`/api/mutual-funds/${fundId}/update-isin`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ isin: isin })
                });
                const result = await res.json();

                if (result.success) {
                    log(`Updated fund ${fundId} ISIN to ${isin}`, 'success');
                    loadUnresolvedIsins();
                } else {
                    log('Failed to update ISIN: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                log('Failed to update ISIN: ' + error.message, 'error');
            }
        }

        // Load ISIN resolver status on page load
        loadIsinResolverStatus();
        loadUnresolvedIsins();

        // ==================== Quarantine Functions ====================

        async function loadQuarantine() {
            const statsContainer = document.getElementById('quarantineStats');
            const listContainer = document.getElementById('quarantineList');

            try {
                // Load stats
                const statsRes = await fetch('/api/quarantine/stats');
                const stats = await statsRes.json();

                if (stats.pending > 0) {
                    statsContainer.innerHTML = `
                        <span class="badge bg-warning">${stats.pending} pending items</span>
                        <span class="badge bg-secondary">${stats.unique_isins} unique ISINs</span>
                    `;
                } else {
                    statsContainer.innerHTML = '<span class="badge bg-success">No items in quarantine</span>';
                }

                // Load summary
                const summaryRes = await fetch('/api/quarantine/summary');
                const summary = await summaryRes.json();

                if (summary.length === 0) {
                    listContainer.innerHTML = '<p class="text-muted">No quarantined items. All ISINs are properly resolved.</p>';
                    return;
                }

                let html = '<table class="table table-sm table-striped"><thead><tr><th>Partial ISIN</th><th>Scheme Name</th><th>Source File</th><th>Items</th><th>Action</th></tr></thead><tbody>';
                for (let idx = 0; idx < summary.length; idx++) {
                    const item = summary[idx];
                    const itemKey = item.partial_isin || `scheme_${idx}`;
                    const escapedScheme = (item.scheme_name || '').replace(/'/g, "\\'");
                    html += `<tr>
                        <td><code class="text-warning">${item.partial_isin || '(missing)'}</code></td>
                        <td><small>${item.scheme_name || '-'}</small><br><small class="text-muted">${item.amc || ''}</small></td>
                        <td><small class="text-muted">${item.source_files || '-'}</small></td>
                        <td>
                            <span class="badge bg-info">${item.holdings_count || 0} holdings</span>
                            <span class="badge bg-secondary">${item.transactions_count || 0} txns</span>
                        </td>
                        <td>
                            <div class="input-group input-group-sm" style="width:240px">
                                <input type="text" class="form-control" placeholder="Correct ISIN" id="qfix-${itemKey}" maxlength="12">
                                <button class="btn btn-success" onclick="resolveQuarantine('${item.partial_isin || ''}', '${escapedScheme}')" title="Resolve">
                                    <i class="bi bi-check"></i>
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteQuarantine('${item.partial_isin || ''}', '${escapedScheme}')" title="Delete">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>`;
                }
                html += '</tbody></table>';
                html += '<div class="alert alert-secondary mt-2"><small><i class="bi bi-info-circle"></i> After resolving, re-import your CAS PDF to import the quarantined items with the correct ISIN.</small></div>';
                listContainer.innerHTML = html;

            } catch (error) {
                listContainer.innerHTML = `<p class="text-danger">Failed to load: ${error.message}</p>`;
            }
        }

        async function resolveQuarantine(partialIsin, schemeName) {
            // Find the input - use partial_isin if available, else use index-based key
            const inputKey = partialIsin || `scheme_${Array.from(document.querySelectorAll('[id^="qfix-"]')).findIndex(el => el.id.includes('scheme_'))}`;
            let input = document.getElementById(`qfix-${partialIsin || inputKey}`);

            // Fallback: find by iterating
            if (!input) {
                const inputs = document.querySelectorAll('[id^="qfix-"]');
                for (const inp of inputs) {
                    if (inp.value) {
                        input = inp;
                        break;
                    }
                }
            }

            if (!input) {
                alert('Could not find input field');
                return;
            }

            const resolvedIsin = input.value.trim().toUpperCase();

            if (!resolvedIsin || resolvedIsin.length !== 12 || !resolvedIsin.startsWith('INF')) {
                alert('Please enter a valid 12-character ISIN starting with INF');
                return;
            }

            try {
                const res = await fetch('/api/quarantine/resolve', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        partial_isin: partialIsin,
                        scheme_name: schemeName,
                        resolved_isin: resolvedIsin
                    })
                });
                const result = await res.json();

                if (result.success) {
                    log(`Resolved quarantine: ${partialIsin || schemeName} -> ${resolvedIsin}. ${result.message}`, 'success');
                    loadQuarantine();
                    loadUnresolvedIsins();
                } else {
                    log('Failed to resolve: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                log('Failed to resolve: ' + error.message, 'error');
            }
        }

        async function deleteQuarantine(partialIsin, schemeName) {
            const identifier = partialIsin || schemeName;
            if (!confirm(`Delete all quarantined items for ${identifier}? This cannot be undone.`)) {
                return;
            }

            try {
                // Use POST with body for delete when we need to pass scheme_name
                const res = await fetch('/api/quarantine/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        partial_isin: partialIsin,
                        scheme_name: schemeName
                    })
                });
                const result = await res.json();

                if (result.success) {
                    log(`Deleted ${result.deleted} quarantined items`, 'success');
                    loadQuarantine();
                } else {
                    log('Failed to delete: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                log('Failed to delete: ' + error.message, 'error');
            }
        }

        // Load quarantine on page load
        loadQuarantine();

        // ==================== Feature Requests ====================

        async function loadFeatureRequests() {
            const container = document.getElementById('featureRequestsList');

            try {
                const res = await fetch('/api/feature-requests');
                const requests = await res.json();

                if (requests.length === 0) {
                    container.innerHTML = `
                        <div class="text-center py-4 text-muted">
                            <i class="bi bi-lightbulb" style="font-size:2rem;"></i>
                            <p class="mt-2">No feature requests yet</p>
                            <p class="small">Click the <i class="bi bi-lightbulb"></i> button to submit one!</p>
                        </div>
                    `;
                    return;
                }

                let html = '<div class="table-responsive"><table class="table table-sm table-striped align-middle"><thead><tr><th>Title</th><th>Description</th><th>Page</th><th>Status</th><th>Date</th></tr></thead><tbody>';
                for (const req of requests) {
                    const statusClass = req.status === 'done' ? 'bg-success' : req.status === 'rejected' ? 'bg-danger' : 'bg-primary';
                    const date = new Date(req.created_at).toLocaleDateString();
                    html += `<tr>
                        <td><strong>${escapeHtml(req.title)}</strong></td>
                        <td><small class="text-muted">${escapeHtml(req.description || '-')}</small></td>
                        <td><code class="small">${escapeHtml(req.page || '/')}</code></td>
                        <td><span class="badge ${statusClass}">${req.status}</span></td>
                        <td><small class="text-muted">${date}</small></td>
                    </tr>`;
                }
                html += '</tbody></table></div>';
                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = `<div class="text-danger">Failed to load feature requests: ${error.message}</div>`;
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Load feature requests on page load
        loadFeatureRequests();

        // ==================== Manual Asset Types ====================

        let manualAssetTypes = [];

        async function loadManualAssetTypes() {
            const container = document.getElementById('assetTypesList');
            if (!container) return; // Not admin

            try {
                const res = await fetch('/api/manual-asset-types');
                manualAssetTypes = await res.json();
                renderManualAssetTypes();
            } catch (e) {
                container.innerHTML = '<span class="text-danger">Failed to load</span>';
            }
        }

        function renderManualAssetTypes() {
            const container = document.getElementById('assetTypesList');
            if (!manualAssetTypes.length) {
                container.innerHTML = '<p class="text-muted">No asset types configured.</p>';
                return;
            }

            let html = '<table class="table table-sm table-striped align-middle mb-0"><thead><tr><th>Icon</th><th>Key</th><th>Label</th><th>Status</th><th class="text-center">Actions</th></tr></thead><tbody>';
            for (let i = 0; i < manualAssetTypes.length; i++) {
                const t = manualAssetTypes[i];
                const statusBadge = t.status === 'active'
                    ? '<span class="badge bg-success">Active</span>'
                    : '<span class="badge bg-secondary">Coming Soon</span>';
                const toggleLabel = t.status === 'active' ? 'Deactivate' : 'Activate';
                const toggleIcon = t.status === 'active' ? 'bi-pause-circle' : 'bi-play-circle';
                html += `<tr>
                    <td><i class="bi ${escapeHtml(t.icon || 'bi-box')} fs-5"></i></td>
                    <td><code>${escapeHtml(t.key)}</code></td>
                    <td>${escapeHtml(t.label)}</td>
                    <td>${statusBadge}</td>
                    <td class="text-center">
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="toggleAssetTypeStatus(${i})" title="${toggleLabel}">
                                <i class="bi ${toggleIcon}"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteAssetType(${i})" title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>`;
            }
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function showAddAssetTypeForm() {
            const form = document.getElementById('addAssetTypeForm');
            form.style.display = form.style.display === 'none' ? '' : 'none';
        }

        async function addAssetType() {
            const key = document.getElementById('newTypeKey').value.trim().toLowerCase().replace(/[^a-z0-9_]/g, '_');
            const label = document.getElementById('newTypeLabel').value.trim();
            const icon = document.getElementById('newTypeIcon').value.trim() || 'bi-box';

            if (!key || !label) {
                alert('Key and Label are required');
                return;
            }

            if (manualAssetTypes.some(t => t.key === key)) {
                alert('A type with this key already exists');
                return;
            }

            manualAssetTypes.push({ key, label, icon, status: 'coming_soon' });
            await saveManualAssetTypes();
            document.getElementById('newTypeKey').value = '';
            document.getElementById('newTypeLabel').value = '';
            document.getElementById('newTypeIcon').value = 'bi-box';
            document.getElementById('addAssetTypeForm').style.display = 'none';
        }

        async function toggleAssetTypeStatus(index) {
            const t = manualAssetTypes[index];
            t.status = t.status === 'active' ? 'coming_soon' : 'active';
            await saveManualAssetTypes();
        }

        async function deleteAssetType(index) {
            const t = manualAssetTypes[index];
            if (!confirm(`Delete "${t.label}"? This only removes it from the selector.`)) return;
            manualAssetTypes.splice(index, 1);
            await saveManualAssetTypes();
        }

        async function saveManualAssetTypes() {
            try {
                const res = await fetch('/api/manual-asset-types', {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(manualAssetTypes)
                });
                const result = await res.json();
                if (result.success) {
                    renderManualAssetTypes();
                    log('Asset types updated', 'success');
                } else {
                    alert('Error: ' + (result.error || 'Unknown'));
                }
            } catch (e) {
                alert('Failed: ' + e.message);
            }
        }

        // Load asset types on page load
        loadManualAssetTypes();
    </script>
    {% include '_feature_request_widget.html' %}
<script>
// Auth: redirect to login on 401
const _origFetch = window.fetch;
window.fetch = function() {
    return _origFetch.apply(this, arguments).then(resp => {
        if (resp.status === 401) window.location.href = '/login';
        return resp;
    });
};
</script>
</body>
</html>
