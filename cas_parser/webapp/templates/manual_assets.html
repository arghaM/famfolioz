<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Famfolio - Manual Assets</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .header {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        .coming-soon-box {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 12px;
        }
        .tx-table th { font-size: 0.85rem; }
        .tx-table td { font-size: 0.9rem; }
        .badge-investment { background-color: #198754; }
        .badge-interest { background-color: #0d6efd; }
        .badge-withdrawal { background-color: #dc3545; }
        .badge-buy { background-color: #198754; }
        .badge-sell { background-color: #dc3545; }
        .value-positive { color: #28a745; }
        .value-negative { color: #dc3545; }

        /* Account tabs */
        .account-tabs { display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center; }
        .account-tab {
            display: inline-flex; align-items: center; gap: 0.4rem;
            padding: 0.45rem 1rem; border-radius: 2rem;
            border: 2px solid #dee2e6; background: #fff;
            cursor: pointer; font-size: 0.9rem; transition: all 0.15s;
        }
        .account-tab:hover { border-color: #0d6efd; }
        .account-tab.active { background: #0d6efd; color: #fff; border-color: #0d6efd; }
        .account-tab .tab-value { font-weight: 600; font-size: 0.8rem; opacity: 0.85; }
        .account-tab .tab-close {
            display: inline-flex; align-items: center; justify-content: center;
            width: 20px; height: 20px; border-radius: 50%;
            font-size: 0.7rem; border: none; padding: 0;
            background: rgba(0,0,0,0.1); color: inherit; cursor: pointer;
            opacity: 0; transition: opacity 0.15s;
        }
        .account-tab:hover .tab-close { opacity: 1; }
        .account-tab.active .tab-close { background: rgba(255,255,255,0.3); }
        .add-tab {
            display: inline-flex; align-items: center; justify-content: center;
            width: 36px; height: 36px; border-radius: 50%;
            border: 2px dashed #adb5bd; background: transparent;
            cursor: pointer; color: #6c757d; font-size: 1.1rem;
            transition: all 0.15s;
        }
        .add-tab:hover { border-color: #198754; color: #198754; background: #e8f5e9; }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="container">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <a href="/investor/{{ investor_id }}" class="text-white text-decoration-none">
                        <i class="bi bi-arrow-left"></i> Back to Portfolio
                    </a>
                    <h1 class="mt-3"><i class="bi bi-wallet2"></i> Manual Assets</h1>
                    <p class="mb-0">Track PPF, EPF, FDs, and other investments</p>
                </div>
                {% include '_auth_nav.html' %}
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Asset Type Combobox Selector -->
        <div class="row mb-4">
            <div class="col-md-6">
                <label class="form-label fw-bold">Asset Type</label>
                <select class="form-select form-select-lg" id="assetTypeSelector" onchange="onAssetTypeChanged()">
                    <option value="">-- Select Asset Type --</option>
                </select>
            </div>
        </div>

        <!-- Coming Soon Placeholder -->
        <div id="comingSoonSection" style="display:none;">
            <div class="coming-soon-box text-center py-5">
                <i class="bi bi-clock-history text-muted" style="font-size:4rem;"></i>
                <h4 class="mt-3">Coming Soon</h4>
                <p class="text-muted" id="comingSoonLabel">Support for this asset type will be available in a future update.</p>
            </div>
        </div>

        <!-- PPF/EPF Section -->
        <div id="ppfEpfSection" style="display:none;">
            <!-- Account Tabs -->
            <div class="mb-3">
                <label class="form-label fw-bold mb-2">Accounts</label>
                <div class="account-tabs" id="ppfAccountTabs">
                    <!-- Tabs rendered by JS -->
                </div>
            </div>

            <!-- No accounts message -->
            <div id="ppfNoAccounts" class="text-center py-5" style="display:none;">
                <i class="bi bi-piggy-bank text-muted" style="font-size:3rem;"></i>
                <h5 class="mt-3 text-muted">No PPF/EPF accounts yet</h5>
                <p class="text-muted">Click the <strong>+</strong> button above to add your first account</p>
            </div>

            <!-- Active account content (visible when a tab is selected) -->
            <div id="ppfActiveContent" style="display:none;">
                <!-- Transaction Form -->
                <div class="card shadow-sm mb-3">
                    <div class="card-body">
                        <div class="row g-3 align-items-end">
                            <div class="col-md-2">
                                <label class="form-label">Type</label>
                                <select class="form-select" id="ppfTxType">
                                    <option value="investment">Investment</option>
                                    <option value="interest">Interest</option>
                                    <option value="withdrawal">Withdrawal</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Date</label>
                                <input type="date" class="form-control" id="ppfTxDate">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Amount</label>
                                <input type="number" class="form-control" id="ppfTxAmount" step="0.01" min="0" placeholder="0.00">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Narration</label>
                                <input type="text" class="form-control" id="ppfTxNarration" placeholder="Optional note">
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-primary w-100" onclick="savePpfTransaction()">
                                    <i class="bi bi-check-lg"></i> Save
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Transaction List -->
                <div class="card shadow-sm">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h6 class="mb-0" id="ppfTxListTitle">Transactions</h6>
                        <span class="badge bg-success fs-6" id="ppfCurrentValueBadge" style="display:none;">
                            Balance: <span id="ppfCurrentValueText">-</span>
                        </span>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover tx-table mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Date</th>
                                        <th>Type</th>
                                        <th class="text-end">Amount</th>
                                        <th>Narration</th>
                                        <th class="text-end">Running Balance</th>
                                        <th class="text-center">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="ppfTxBody"></tbody>
                            </table>
                        </div>
                        <div id="ppfTxEmpty" class="text-center py-4 text-muted" style="display:none;">
                            <i class="bi bi-receipt" style="font-size:2rem;"></i>
                            <p class="mt-2 mb-0">No transactions yet. Add one above.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gold Section -->
        <div id="goldSection" style="display:none;">
            <!-- Account Tabs -->
            <div class="mb-3">
                <label class="form-label fw-bold mb-2">Gold Lots</label>
                <div class="account-tabs" id="goldLotTabs">
                    <!-- Tabs rendered by JS -->
                </div>
            </div>

            <!-- No lots message -->
            <div id="goldNoLots" class="text-center py-5" style="display:none;">
                <i class="bi bi-gem text-muted" style="font-size:3rem;"></i>
                <h5 class="mt-3 text-muted">No gold lots yet</h5>
                <p class="text-muted">Click the <strong>+</strong> button above to add your first gold lot</p>
            </div>

            <!-- Active lot content (visible when a tab is selected) -->
            <div id="goldActiveContent" style="display:none;">
                <!-- Price Update Section -->
                <div class="card shadow-sm mb-3 border-warning">
                    <div class="card-body py-2">
                        <div class="d-flex align-items-center justify-content-between mb-2">
                            <div>
                                <small class="text-muted">Current Price/g:</small>
                                <span class="fw-bold ms-1" id="goldLotCurrentPrice">--</span>
                                <small class="text-muted ms-2" id="goldLotPriceDate"></small>
                            </div>
                            <button class="btn btn-sm btn-outline-secondary py-0" type="button"
                                    data-bs-toggle="collapse" data-bs-target="#goldLotPriceHistory">
                                <i class="bi bi-clock-history"></i> History
                            </button>
                        </div>
                        <div class="row g-2 align-items-end">
                            <div class="col-auto">
                                <label class="form-label small mb-0">Date</label>
                                <input type="date" class="form-control form-control-sm" id="goldLotPriceDateInput">
                            </div>
                            <div class="col-auto">
                                <label class="form-label small mb-0">Price/g</label>
                                <input type="number" class="form-control form-control-sm" id="goldLotPriceInput"
                                       step="0.01" min="0" placeholder="0.00" style="width:120px;">
                            </div>
                            <div class="col-auto">
                                <label class="form-label small mb-0">&nbsp;</label>
                                <button class="btn btn-sm btn-warning d-block" onclick="saveGoldLotPrice()">
                                    Update
                                </button>
                            </div>
                        </div>
                        <div class="collapse mt-2" id="goldLotPriceHistory">
                            <table class="table table-sm table-bordered mb-0" style="font-size:0.8rem;">
                                <thead class="table-light"><tr><th>Date</th><th class="text-end">Price/g</th></tr></thead>
                                <tbody id="goldLotPriceHistoryBody">
                                    <tr><td colspan="2" class="text-center text-muted">No history</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Transaction Form -->
                <div class="card shadow-sm mb-3">
                    <div class="card-body">
                        <div class="row g-3 align-items-end">
                            <div class="col-md-2">
                                <label class="form-label">Type</label>
                                <select class="form-select" id="goldTxType">
                                    <option value="buy">Buy</option>
                                    <option value="sell">Sell</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Date</label>
                                <input type="date" class="form-control" id="goldTxDate">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Quantity (g)</label>
                                <input type="number" class="form-control" id="goldTxQty" step="0.001" min="0" placeholder="0.000"
                                       oninput="calcGoldAmount()">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Rate/g (&#8377;)</label>
                                <input type="number" class="form-control" id="goldTxRate" step="0.01" min="0" placeholder="0.00"
                                       oninput="calcGoldAmount()">
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">Amount (&#8377;)</label>
                                <input type="number" class="form-control" id="goldTxAmount" step="0.01" min="0" placeholder="0.00">
                            </div>
                            <div class="col-md-2">
                                <button class="btn btn-primary w-100" onclick="saveGoldTransaction()">
                                    <i class="bi bi-check-lg"></i> Save
                                </button>
                            </div>
                        </div>
                        <div class="row g-3 mt-1">
                            <div class="col-md-10">
                                <input type="text" class="form-control" id="goldTxNarration" placeholder="Narration (optional)">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Transaction List -->
                <div class="card shadow-sm">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h6 class="mb-0" id="goldTxListTitle">Transactions</h6>
                        <div>
                            <span class="badge bg-warning text-dark fs-6 me-1" id="goldQtyBadge" style="display:none;">
                                <span id="goldQtyText">-</span> g
                            </span>
                            <span class="badge bg-success fs-6" id="goldValueBadge" style="display:none;">
                                Value: <span id="goldValueText">-</span>
                            </span>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover tx-table mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Date</th>
                                        <th>Type</th>
                                        <th class="text-end">Qty (g)</th>
                                        <th class="text-end">Rate/g</th>
                                        <th class="text-end">Amount</th>
                                        <th>Narration</th>
                                        <th class="text-end">Running Qty</th>
                                        <th class="text-center">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="goldTxBody"></tbody>
                            </table>
                        </div>
                        <div id="goldTxEmpty" class="text-center py-4 text-muted" style="display:none;">
                            <i class="bi bi-receipt" style="font-size:2rem;"></i>
                            <p class="mt-2 mb-0">No transactions yet. Add one above.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Empty State (shown when no type is selected) -->
        <div id="emptyState" class="text-center py-5">
            <i class="bi bi-wallet2 text-muted" style="font-size: 4rem;"></i>
            <h4 class="mt-3 text-muted">Select an asset type above to get started</h4>
            <p class="text-muted">Choose from PPF/EPF, FDs, Gold, and more</p>
        </div>
    </div>

    <!-- New PPF/EPF Asset Modal -->
    <div class="modal fade" id="newPpfModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-piggy-bank"></i> New PPF/EPF Account</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Type</label>
                        <select class="form-select" id="newPpfType">
                            <option value="ppf">PPF</option>
                            <option value="epf">EPF</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Bank / Institution</label>
                        <input type="text" class="form-control" id="newPpfBank" placeholder="e.g., SBI, Post Office">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Account / Reference Number</label>
                        <input type="text" class="form-control" id="newPpfRefNo" placeholder="e.g., 12345678">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="createPpfAsset()">
                        <i class="bi bi-check-lg"></i> Create Account
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- New Gold Lot Modal -->
    <div class="modal fade" id="newGoldLotModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-gem"></i> New Gold Lot</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Name / Description <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="newGoldName" placeholder="e.g., Physical Gold Bar 24K, Gold Coins">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Reference / Invoice Number</label>
                        <input type="text" class="form-control" id="newGoldRefNo" placeholder="Optional">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Seller</label>
                        <input type="text" class="form-control" id="newGoldSeller" placeholder="e.g., Tanishq, Local Jeweller">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Agent / Broker</label>
                        <input type="text" class="form-control" id="newGoldBroker" placeholder="Optional">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning" onclick="createGoldLot()">
                        <i class="bi bi-check-lg"></i> Create Lot
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const investorId = {{ investor_id }};
        let assetTypes = [];
        let ppfAssets = [];
        let selectedAssetId = null;
        let newPpfModal;
        let goldLots = [];
        let selectedGoldLotId = null;
        let newGoldLotModal;

        document.addEventListener('DOMContentLoaded', function() {
            newPpfModal = new bootstrap.Modal(document.getElementById('newPpfModal'));
            newGoldLotModal = new bootstrap.Modal(document.getElementById('newGoldLotModal'));
            document.getElementById('ppfTxDate').valueAsDate = new Date();
            document.getElementById('goldTxDate').valueAsDate = new Date();
            loadAssetTypes();
        });

        // ----- Asset Type Selector -----

        async function loadAssetTypes() {
            try {
                const res = await fetch('/api/manual-asset-types');
                assetTypes = await res.json();
                renderAssetTypeSelector();
            } catch (e) {
                console.error('Failed to load asset types:', e);
            }
        }

        function renderAssetTypeSelector() {
            const sel = document.getElementById('assetTypeSelector');
            sel.innerHTML = '<option value="">-- Select Asset Type --</option>';
            for (const t of assetTypes) {
                const disabled = t.status !== 'active' ? 'disabled' : '';
                const suffix = t.status !== 'active' ? ' (Coming Soon)' : '';
                sel.innerHTML += `<option value="${t.key}" ${disabled}>${t.label}${suffix}</option>`;
            }
        }

        function onAssetTypeChanged() {
            const key = document.getElementById('assetTypeSelector').value;
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('comingSoonSection').style.display = 'none';
            document.getElementById('ppfEpfSection').style.display = 'none';
            document.getElementById('goldSection').style.display = 'none';

            if (!key) {
                document.getElementById('emptyState').style.display = '';
                return;
            }

            const typeObj = assetTypes.find(t => t.key === key);

            if (key === 'ppf_epf') {
                document.getElementById('ppfEpfSection').style.display = '';
                loadPpfAssets();
            } else if (key === 'gold') {
                document.getElementById('goldSection').style.display = '';
                loadGoldLots();
            } else {
                document.getElementById('comingSoonSection').style.display = '';
                document.getElementById('comingSoonLabel').textContent =
                    `Support for ${typeObj ? typeObj.label : key} will be available in a future update.`;
            }
        }

        // ----- PPF/EPF Account Tabs -----

        async function loadPpfAssets() {
            try {
                const res = await fetch(`/api/ppf-epf-assets?investor_id=${investorId}`);
                ppfAssets = await res.json();
                renderAccountTabs();
            } catch (e) {
                console.error('Failed to load PPF assets:', e);
            }
        }

        function renderAccountTabs() {
            const container = document.getElementById('ppfAccountTabs');
            const noAccounts = document.getElementById('ppfNoAccounts');
            const content = document.getElementById('ppfActiveContent');

            let html = '';
            for (const a of ppfAssets) {
                const isActive = a.id == selectedAssetId;
                const val = a.current_value ? formatCurrency(a.current_value) : '';
                html += `<div class="account-tab ${isActive ? 'active' : ''}" onclick="selectAccount(${a.id})">
                    <i class="bi bi-piggy-bank"></i>
                    <span>${escapeHtml(a.name)}</span>
                    ${val ? `<span class="tab-value">${val}</span>` : ''}
                    <button class="tab-close" onclick="event.stopPropagation(); deleteAccount(${a.id}, '${escapeHtml(a.name)}')" title="Delete account">
                        <i class="bi bi-x"></i>
                    </button>
                </div>`;
            }
            html += `<button class="add-tab" onclick="showNewPpfModal()" title="Add new account"><i class="bi bi-plus"></i></button>`;
            container.innerHTML = html;

            if (ppfAssets.length === 0) {
                noAccounts.style.display = '';
                content.style.display = 'none';
                selectedAssetId = null;
            } else {
                noAccounts.style.display = 'none';
                // Auto-select first tab if none selected or selected was deleted
                if (!selectedAssetId || !ppfAssets.find(a => a.id == selectedAssetId)) {
                    selectAccount(ppfAssets[0].id);
                } else {
                    // Re-render the active tab content
                    content.style.display = '';
                    loadPpfTransactions(selectedAssetId);
                }
            }
        }

        function selectAccount(assetId) {
            selectedAssetId = assetId;
            // Update tab active states
            document.querySelectorAll('.account-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            // Find and activate the clicked tab
            const tabs = document.querySelectorAll('.account-tab');
            for (const tab of tabs) {
                if (tab.onclick && tab.onclick.toString().includes(assetId)) {
                    tab.classList.add('active');
                }
            }
            // Re-render to update active state properly
            renderAccountTabs();
        }

        async function deleteAccount(assetId, name) {
            if (!confirm(`Delete "${name}" and all its transactions?\n\nThis cannot be undone.`)) return;
            try {
                const res = await fetch(`/api/manual-assets/${assetId}`, { method: 'DELETE' });
                const result = await res.json();
                if (result.success) {
                    if (selectedAssetId == assetId) selectedAssetId = null;
                    await loadPpfAssets();
                } else {
                    alert('Error: ' + (result.error || 'Unknown error'));
                }
            } catch (e) {
                alert('Failed: ' + e.message);
            }
        }

        // ----- PPF/EPF Transactions -----

        async function loadPpfTransactions(assetId) {
            try {
                const res = await fetch(`/api/manual-assets/${assetId}/transactions`);
                const txns = await res.json();
                renderPpfTransactions(txns);

                const asset = ppfAssets.find(a => a.id == assetId);
                document.getElementById('ppfTxListTitle').textContent =
                    `Transactions for ${asset ? asset.name : 'Account'}`;

                const badge = document.getElementById('ppfCurrentValueBadge');
                if (txns.length > 0) {
                    const lastBalance = txns[txns.length - 1].running_balance;
                    document.getElementById('ppfCurrentValueText').textContent = formatCurrency(lastBalance);
                    badge.style.display = '';
                } else {
                    badge.style.display = 'none';
                }
            } catch (e) {
                console.error('Failed to load transactions:', e);
            }
        }

        function renderPpfTransactions(txns) {
            const tbody = document.getElementById('ppfTxBody');
            const empty = document.getElementById('ppfTxEmpty');

            if (txns.length === 0) {
                tbody.innerHTML = '';
                empty.style.display = '';
                return;
            }

            empty.style.display = 'none';
            tbody.innerHTML = txns.map(tx => {
                const badgeClass = `badge-${tx.tx_type}`;
                const typeLabel = tx.tx_type.charAt(0).toUpperCase() + tx.tx_type.slice(1);
                return `<tr>
                    <td>${tx.tx_date}</td>
                    <td><span class="badge ${badgeClass}">${typeLabel}</span></td>
                    <td class="text-end">${formatCurrency(tx.amount)}</td>
                    <td class="text-muted">${tx.narration || '-'}</td>
                    <td class="text-end fw-bold">${formatCurrency(tx.running_balance)}</td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-outline-danger" onclick="deletePpfTransaction(${tx.id})" title="Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>`;
            }).join('');
        }

        async function savePpfTransaction() {
            if (!selectedAssetId) return alert('Please select an account first');

            const txType = document.getElementById('ppfTxType').value;
            const txDate = document.getElementById('ppfTxDate').value;
            const amount = parseFloat(document.getElementById('ppfTxAmount').value);
            const narration = document.getElementById('ppfTxNarration').value || null;

            if (!txDate) return alert('Please enter a date');
            if (!amount || amount <= 0) return alert('Please enter a positive amount');

            try {
                const res = await fetch(`/api/manual-assets/${selectedAssetId}/transactions`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ tx_type: txType, tx_date: txDate, amount, narration })
                });
                const result = await res.json();
                if (res.ok && result.success) {
                    document.getElementById('ppfTxAmount').value = '';
                    document.getElementById('ppfTxNarration').value = '';
                    // Reload both tabs (value changed) and transactions
                    await loadPpfAssets();
                } else {
                    alert('Error: ' + (result.error || 'Unknown error'));
                }
            } catch (e) {
                alert('Failed: ' + e.message);
            }
        }

        async function deletePpfTransaction(txId) {
            if (!confirm('Delete this transaction?')) return;
            try {
                const res = await fetch(`/api/manual-assets/transactions/${txId}`, { method: 'DELETE' });
                const result = await res.json();
                if (result.success) {
                    await loadPpfAssets();
                } else {
                    alert('Error: ' + (result.error || 'Unknown error'));
                }
            } catch (e) {
                alert('Failed: ' + e.message);
            }
        }

        // ----- New PPF/EPF Asset Modal -----

        function showNewPpfModal() {
            document.getElementById('newPpfType').value = 'ppf';
            document.getElementById('newPpfBank').value = '';
            document.getElementById('newPpfRefNo').value = '';
            newPpfModal.show();
        }

        async function createPpfAsset() {
            const subType = document.getElementById('newPpfType').value;
            const bank = document.getElementById('newPpfBank').value.trim();
            const refNo = document.getElementById('newPpfRefNo').value.trim();

            try {
                const res = await fetch('/api/ppf-epf-assets', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        investor_id: investorId,
                        sub_type: subType,
                        bank: bank || null,
                        ref_no: refNo || null
                    })
                });
                const result = await res.json();
                if (res.ok && result.id) {
                    newPpfModal.hide();
                    selectedAssetId = result.id;
                    await loadPpfAssets();
                } else {
                    alert('Error: ' + (result.error || 'Unknown error'));
                }
            } catch (e) {
                alert('Failed: ' + e.message);
            }
        }

        // ----- Gold Lot Tabs -----

        async function loadGoldLots() {
            try {
                const res = await fetch(`/api/gold-assets?investor_id=${investorId}`);
                goldLots = await res.json();
                renderGoldLotTabs();
            } catch (e) {
                console.error('Failed to load gold lots:', e);
            }
        }

        function renderGoldLotTabs() {
            const container = document.getElementById('goldLotTabs');
            const noLots = document.getElementById('goldNoLots');
            const content = document.getElementById('goldActiveContent');

            let html = '';
            for (const lot of goldLots) {
                const isActive = lot.id == selectedGoldLotId;
                const val = (lot.calculated_value || lot.current_value) ? formatCurrency(lot.calculated_value || lot.current_value) : '';
                const qty = lot.units ? `${parseFloat(lot.units).toFixed(2)}g` : '';
                html += `<div class="account-tab ${isActive ? 'active' : ''}" onclick="selectGoldLot(${lot.id})">
                    <i class="bi bi-gem"></i>
                    <span>${escapeHtml(lot.name)}</span>
                    ${qty ? `<span class="tab-value">${qty}</span>` : ''}
                    ${val ? `<span class="tab-value">${val}</span>` : ''}
                    <button class="tab-close" onclick="event.stopPropagation(); deleteGoldLot(${lot.id}, '${escapeHtml(lot.name)}')" title="Delete lot">
                        <i class="bi bi-x"></i>
                    </button>
                </div>`;
            }
            html += `<button class="add-tab" onclick="showNewGoldLotModal()" title="Add new gold lot"><i class="bi bi-plus"></i></button>`;
            container.innerHTML = html;

            if (goldLots.length === 0) {
                noLots.style.display = '';
                content.style.display = 'none';
                selectedGoldLotId = null;
            } else {
                noLots.style.display = 'none';
                if (!selectedGoldLotId || !goldLots.find(l => l.id == selectedGoldLotId)) {
                    selectGoldLot(goldLots[0].id);
                } else {
                    content.style.display = '';
                    loadGoldTransactions(selectedGoldLotId);
                }
            }
        }

        function selectGoldLot(lotId) {
            selectedGoldLotId = lotId;
            renderGoldLotTabs();
        }

        async function deleteGoldLot(lotId, name) {
            if (!confirm(`Delete "${name}" and all its transactions?\n\nThis cannot be undone.`)) return;
            try {
                const res = await fetch(`/api/manual-assets/${lotId}`, { method: 'DELETE' });
                const result = await res.json();
                if (result.success) {
                    if (selectedGoldLotId == lotId) selectedGoldLotId = null;
                    await loadGoldLots();
                } else {
                    alert('Error: ' + (result.error || 'Unknown error'));
                }
            } catch (e) {
                alert('Failed: ' + e.message);
            }
        }

        // ----- Gold Transactions -----

        async function loadGoldTransactions(lotId) {
            try {
                const res = await fetch(`/api/manual-assets/${lotId}/transactions`);
                const txns = await res.json();
                renderGoldTransactions(txns);

                const lot = goldLots.find(l => l.id == lotId);
                document.getElementById('goldTxListTitle').textContent =
                    `Transactions for ${lot ? lot.name : 'Lot'}`;

                const qtyBadge = document.getElementById('goldQtyBadge');
                const valBadge = document.getElementById('goldValueBadge');
                if (txns.length > 0) {
                    const lastQty = txns[txns.length - 1].running_quantity;
                    const displayVal = lot ? (lot.calculated_value || lot.current_value || txns[txns.length - 1].running_balance) : txns[txns.length - 1].running_balance;
                    document.getElementById('goldQtyText').textContent = parseFloat(lastQty).toFixed(3);
                    document.getElementById('goldValueText').textContent = formatCurrency(displayVal);
                    qtyBadge.style.display = '';
                    valBadge.style.display = '';
                } else {
                    qtyBadge.style.display = 'none';
                    valBadge.style.display = 'none';
                }

                // Load price section
                loadGoldLotPriceHistory(lotId);
            } catch (e) {
                console.error('Failed to load gold transactions:', e);
            }
        }

        function renderGoldTransactions(txns) {
            const tbody = document.getElementById('goldTxBody');
            const empty = document.getElementById('goldTxEmpty');

            if (txns.length === 0) {
                tbody.innerHTML = '';
                empty.style.display = '';
                return;
            }

            empty.style.display = 'none';
            tbody.innerHTML = txns.map(tx => {
                const badgeClass = `badge-${tx.tx_type}`;
                const typeLabel = tx.tx_type.charAt(0).toUpperCase() + tx.tx_type.slice(1);
                const qty = tx.quantity ? parseFloat(tx.quantity).toFixed(3) : '-';
                const rate = tx.rate ? formatCurrency(tx.rate) : '-';
                const runQty = parseFloat(tx.running_quantity).toFixed(3);
                return `<tr>
                    <td>${tx.tx_date}</td>
                    <td><span class="badge ${badgeClass}">${typeLabel}</span></td>
                    <td class="text-end">${qty}</td>
                    <td class="text-end">${rate}</td>
                    <td class="text-end">${formatCurrency(tx.amount)}</td>
                    <td class="text-muted">${tx.narration || '-'}</td>
                    <td class="text-end fw-bold">${runQty} g</td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteGoldTransaction(${tx.id})" title="Delete">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>`;
            }).join('');
        }

        function calcGoldAmount() {
            const qty = parseFloat(document.getElementById('goldTxQty').value) || 0;
            const rate = parseFloat(document.getElementById('goldTxRate').value) || 0;
            if (qty > 0 && rate > 0) {
                document.getElementById('goldTxAmount').value = (qty * rate).toFixed(2);
            }
        }

        async function saveGoldTransaction() {
            if (!selectedGoldLotId) return alert('Please select a gold lot first');

            const txType = document.getElementById('goldTxType').value;
            const txDate = document.getElementById('goldTxDate').value;
            const qty = parseFloat(document.getElementById('goldTxQty').value);
            const rate = parseFloat(document.getElementById('goldTxRate').value);
            const amount = parseFloat(document.getElementById('goldTxAmount').value);
            const narration = document.getElementById('goldTxNarration').value || null;

            if (!txDate) return alert('Please enter a date');
            if (!qty || qty <= 0) return alert('Please enter a positive quantity');
            if (!amount || amount <= 0) return alert('Please enter a positive amount');

            try {
                const res = await fetch(`/api/manual-assets/${selectedGoldLotId}/transactions`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ tx_type: txType, tx_date: txDate, amount, narration, quantity: qty, rate: rate || null })
                });
                const result = await res.json();
                if (res.ok && result.success) {
                    document.getElementById('goldTxQty').value = '';
                    document.getElementById('goldTxRate').value = '';
                    document.getElementById('goldTxAmount').value = '';
                    document.getElementById('goldTxNarration').value = '';
                    await loadGoldLots();
                } else {
                    alert('Error: ' + (result.error || 'Unknown error'));
                }
            } catch (e) {
                alert('Failed: ' + e.message);
            }
        }

        async function deleteGoldTransaction(txId) {
            if (!confirm('Delete this transaction?')) return;
            try {
                const res = await fetch(`/api/manual-assets/transactions/${txId}`, { method: 'DELETE' });
                const result = await res.json();
                if (result.success) {
                    await loadGoldLots();
                } else {
                    alert('Error: ' + (result.error || 'Unknown error'));
                }
            } catch (e) {
                alert('Failed: ' + e.message);
            }
        }

        // ----- Gold Price Tracking -----

        function updateGoldLotPriceDisplay(lot) {
            const priceEl = document.getElementById('goldLotCurrentPrice');
            const dateEl = document.getElementById('goldLotPriceDate');
            if (!priceEl) return;

            if (lot && lot.current_nav) {
                priceEl.textContent = formatCurrency(lot.current_nav);
                dateEl.textContent = '';
            } else {
                priceEl.innerHTML = '<span class="text-muted fst-italic">No price set â€” showing cost basis</span>';
                dateEl.textContent = '';
            }
        }

        async function loadGoldLotPriceHistory(lotId) {
            const tbody = document.getElementById('goldLotPriceHistoryBody');
            if (!tbody) return;

            const lot = goldLots.find(l => l.id == lotId);
            updateGoldLotPriceDisplay(lot);

            // Set default date
            const dateInput = document.getElementById('goldLotPriceDateInput');
            if (dateInput && !dateInput.value) {
                dateInput.value = new Date().toISOString().split('T')[0];
            }

            try {
                const res = await fetch(`/api/manual-assets/${lotId}/prices?limit=10`);
                const prices = await res.json();

                if (prices.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="2" class="text-center text-muted">No history</td></tr>';
                    return;
                }

                const dateEl = document.getElementById('goldLotPriceDate');
                if (dateEl && prices.length > 0) {
                    dateEl.textContent = `(as of ${prices[0].price_date})`;
                }

                tbody.innerHTML = prices.map(p => `<tr>
                    <td>${p.price_date}</td>
                    <td class="text-end">${formatCurrency(p.price_per_unit)}</td>
                </tr>`).join('');
            } catch (e) {
                console.error('Failed to load price history:', e);
            }
        }

        async function saveGoldLotPrice() {
            if (!selectedGoldLotId) return;

            const priceDate = document.getElementById('goldLotPriceDateInput').value;
            const pricePerUnit = parseFloat(document.getElementById('goldLotPriceInput').value);

            if (!priceDate) { alert('Please enter a date.'); return; }
            if (!pricePerUnit || pricePerUnit <= 0) { alert('Please enter a valid price.'); return; }

            try {
                const res = await fetch(`/api/manual-assets/${selectedGoldLotId}/prices`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ price_date: priceDate, price_per_unit: pricePerUnit })
                });
                const result = await res.json();
                if (result.error) { alert('Error: ' + result.error); return; }

                document.getElementById('goldLotPriceInput').value = '';
                await loadGoldLots();
            } catch (e) {
                alert('Failed to save price: ' + e.message);
            }
        }

        // ----- New Gold Lot Modal -----

        function showNewGoldLotModal() {
            document.getElementById('newGoldName').value = '';
            document.getElementById('newGoldRefNo').value = '';
            document.getElementById('newGoldSeller').value = '';
            document.getElementById('newGoldBroker').value = '';
            newGoldLotModal.show();
        }

        async function createGoldLot() {
            const name = document.getElementById('newGoldName').value.trim();
            if (!name) return alert('Please enter a name');

            const refNo = document.getElementById('newGoldRefNo').value.trim();
            const seller = document.getElementById('newGoldSeller').value.trim();
            const broker = document.getElementById('newGoldBroker').value.trim();

            try {
                const res = await fetch('/api/gold-assets', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        investor_id: investorId,
                        name,
                        ref_no: refNo || null,
                        seller: seller || null,
                        broker: broker || null
                    })
                });
                const result = await res.json();
                if (res.ok && result.id) {
                    newGoldLotModal.hide();
                    selectedGoldLotId = result.id;
                    await loadGoldLots();
                } else {
                    alert('Error: ' + (result.error || 'Unknown error'));
                }
            } catch (e) {
                alert('Failed: ' + e.message);
            }
        }

        // ----- Utility -----

        function formatCurrency(value) {
            return new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR',
                maximumFractionDigits: 0
            }).format(value || 0);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
    {% include '_feature_request_widget.html' %}
<script>
// Auth: redirect to login on 401
const _origFetch = window.fetch;
window.fetch = function() {
    return _origFetch.apply(this, arguments).then(resp => {
        if (resp.status === 401) window.location.href = '/login';
        return resp;
    });
};
</script>
</body>
</html>
