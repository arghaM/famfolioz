<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Famfolio - Manual Assets</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .header {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        .asset-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .asset-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .asset-icon {
            font-size: 2rem;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
        }
        .asset-icon.fd { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .asset-icon.sgb { background: linear-gradient(135deg, #f5af19 0%, #f12711 100%); color: white; }
        .asset-icon.stock { background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%); color: white; }
        .asset-icon.ppf { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; }
        .asset-icon.nps { background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #333; }
        .asset-icon.other { background: linear-gradient(135deg, #d299c2 0%, #fef9d7 100%); color: #333; }
        .class-badge { font-size: 0.7rem; }
        .value-positive { color: #28a745; }
        .value-negative { color: #dc3545; }
        .progress-bar-fd { background: linear-gradient(90deg, #667eea, #764ba2); }
        .summary-card {
            border-left: 4px solid;
        }
        .summary-card.equity { border-color: #28a745; }
        .summary-card.debt { border-color: #007bff; }
        .summary-card.commodity { border-color: #ffc107; }
        .summary-card.cash { border-color: #17a2b8; }
        .summary-card.others { border-color: #6c757d; }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="container">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <a href="/investor/{{ investor_id }}" class="text-white text-decoration-none">
                        <i class="bi bi-arrow-left"></i> Back to Portfolio
                    </a>
                    <h1 class="mt-3"><i class="bi bi-wallet2"></i> Manual Assets</h1>
                    <p class="mb-0">Track FDs, SGBs, Stocks, PPF, and other investments</p>
                </div>
                {% include '_auth_nav.html' %}
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Summary Cards -->
        <div class="row mb-4" id="summaryCards">
            <!-- Summary will be loaded here -->
        </div>

        <!-- Add Asset Button -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4><i class="bi bi-collection"></i> Your Assets</h4>
            <button class="btn btn-success" onclick="openAddAssetModal()">
                <i class="bi bi-plus-lg"></i> Add Asset
            </button>
        </div>

        <!-- Assets List -->
        <div id="assetsList" class="row">
            <!-- Assets will be loaded here -->
        </div>

        <!-- Empty State -->
        <div id="emptyState" class="text-center py-5" style="display: none;">
            <i class="bi bi-wallet2 text-muted" style="font-size: 4rem;"></i>
            <h4 class="mt-3 text-muted">No manual assets yet</h4>
            <p class="text-muted">Add FDs, SGBs, Stocks, or other investments to track them here</p>
            <button class="btn btn-success btn-lg mt-2" onclick="openAddAssetModal()">
                <i class="bi bi-plus-lg"></i> Add Your First Asset
            </button>
        </div>
    </div>

    <!-- Add/Edit Asset Modal -->
    <div class="modal fade" id="assetModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="assetModalTitle">
                        <i class="bi bi-plus-circle"></i> Add New Asset
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="assetForm">
                        <input type="hidden" id="assetId">

                        <!-- Asset Type Selection -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Asset Type</label>
                                <select class="form-select" id="assetType" onchange="showAssetTypeFields()">
                                    <option value="fd">Fixed Deposit (FD)</option>
                                    <option value="sgb">Sovereign Gold Bond (SGB)</option>
                                    <option value="stock">Stock / Equity</option>
                                    <option value="ppf">PPF</option>
                                    <option value="nps">NPS</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Asset Class</label>
                                <select class="form-select" id="assetClass">
                                    <option value="debt">Debt</option>
                                    <option value="equity">Equity</option>
                                    <option value="commodity">Commodity</option>
                                    <option value="cash">Cash</option>
                                    <option value="others">Others</option>
                                </select>
                            </div>
                        </div>

                        <!-- Common Fields -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Name *</label>
                                <input type="text" class="form-control" id="assetName" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Description</label>
                                <input type="text" class="form-control" id="assetDescription">
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Purchase/Start Date</label>
                                <input type="date" class="form-control" id="purchaseDate">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Purchase Value</label>
                                <input type="number" class="form-control" id="purchaseValue" step="0.01">
                            </div>
                        </div>

                        <!-- FD Fields -->
                        <div id="fdFields" class="asset-type-fields">
                            <hr>
                            <h6><i class="bi bi-bank"></i> Fixed Deposit Details</h6>
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label class="form-label">Principal Amount *</label>
                                    <input type="number" class="form-control" id="fdPrincipal" step="0.01">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Interest Rate (%) *</label>
                                    <input type="number" class="form-control" id="fdInterestRate" step="0.01" value="7.0">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Tenure (Months) *</label>
                                    <input type="number" class="form-control" id="fdTenureMonths" value="12">
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label class="form-label">Compounding</label>
                                    <select class="form-select" id="fdCompounding">
                                        <option value="quarterly">Quarterly</option>
                                        <option value="monthly">Monthly</option>
                                        <option value="half_yearly">Half Yearly</option>
                                        <option value="yearly">Yearly</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Premature Penalty (%)</label>
                                    <input type="number" class="form-control" id="fdPenalty" step="0.1" value="1.0">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Bank Name</label>
                                    <input type="text" class="form-control" id="fdBankName">
                                </div>
                            </div>
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="calculateFD()">
                                <i class="bi bi-calculator"></i> Calculate Value
                            </button>
                            <div id="fdCalculation" class="alert alert-info mt-2" style="display: none;"></div>
                        </div>

                        <!-- SGB Fields -->
                        <div id="sgbFields" class="asset-type-fields" style="display: none;">
                            <hr>
                            <h6><i class="bi bi-gem"></i> Sovereign Gold Bond Details</h6>
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label class="form-label">Issue Price (per gram) *</label>
                                    <input type="number" class="form-control" id="sgbIssuePrice" step="0.01">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Grams *</label>
                                    <input type="number" class="form-control" id="sgbGrams" step="0.001">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Interest Rate (%)</label>
                                    <input type="number" class="form-control" id="sgbInterestRate" step="0.01" value="2.5">
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Current Gold Price (per gram)</label>
                                    <input type="number" class="form-control" id="sgbCurrentPrice" step="0.01" placeholder="Leave blank to use issue price">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Maturity Date</label>
                                    <input type="date" class="form-control" id="sgbMaturityDate">
                                </div>
                            </div>
                            <button type="button" class="btn btn-outline-warning btn-sm" onclick="calculateSGB()">
                                <i class="bi bi-calculator"></i> Calculate Value
                            </button>
                            <div id="sgbCalculation" class="alert alert-warning mt-2" style="display: none;"></div>
                        </div>

                        <!-- Stock Fields -->
                        <div id="stockFields" class="asset-type-fields" style="display: none;">
                            <hr>
                            <h6><i class="bi bi-graph-up-arrow"></i> Stock Details</h6>
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label class="form-label">Stock Symbol</label>
                                    <input type="text" class="form-control" id="stockSymbol" placeholder="e.g., RELIANCE">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Exchange</label>
                                    <select class="form-select" id="stockExchange">
                                        <option value="NSE">NSE</option>
                                        <option value="BSE">BSE</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Quantity *</label>
                                    <input type="number" class="form-control" id="stockQuantity" step="1">
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Average Buy Price *</label>
                                    <input type="number" class="form-control" id="stockAvgPrice" step="0.01">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Current Price</label>
                                    <input type="number" class="form-control" id="stockCurrentPrice" step="0.01" placeholder="For valuation">
                                </div>
                            </div>
                        </div>

                        <!-- PPF/NPS Fields -->
                        <div id="ppfFields" class="asset-type-fields" style="display: none;">
                            <hr>
                            <h6><i class="bi bi-piggy-bank"></i> PPF/NPS Details</h6>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Account Number</label>
                                    <input type="text" class="form-control" id="ppfAccountNumber">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Maturity Date</label>
                                    <input type="date" class="form-control" id="ppfMaturityDate">
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Current Value</label>
                                    <input type="number" class="form-control" id="ppfCurrentValue" step="0.01">
                                </div>
                            </div>
                        </div>

                        <!-- Other Asset Fields -->
                        <div id="otherFields" class="asset-type-fields" style="display: none;">
                            <hr>
                            <h6><i class="bi bi-box"></i> Other Asset Details</h6>
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label class="form-label">Units</label>
                                    <input type="number" class="form-control" id="otherUnits" step="0.001" value="1">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Current NAV / Price per Unit</label>
                                    <input type="number" class="form-control" id="otherCurrentNav" step="0.01">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Current Value</label>
                                    <input type="number" class="form-control" id="otherCurrentValue" step="0.01">
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="saveAsset()">
                        <i class="bi bi-check-lg"></i> Save Asset
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Asset Detail Modal -->
    <div class="modal fade" id="detailModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="detailModalTitle">Asset Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="detailModalBody">
                    <!-- Details loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-danger" id="deleteAssetBtn">
                        <i class="bi bi-trash"></i> Delete
                    </button>
                    <button type="button" class="btn btn-primary" id="editAssetBtn">
                        <i class="bi bi-pencil"></i> Edit
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const investorId = {{ investor_id }};
        let assets = [];
        let assetModal, detailModal;
        let currentAsset = null;

        document.addEventListener('DOMContentLoaded', function() {
            assetModal = new bootstrap.Modal(document.getElementById('assetModal'));
            detailModal = new bootstrap.Modal(document.getElementById('detailModal'));
            loadAssets();
        });

        async function loadAssets() {
            try {
                const res = await fetch(`/api/manual-assets?investor_id=${investorId}`);
                assets = await res.json();

                const summaryRes = await fetch(`/api/manual-assets/summary?investor_id=${investorId}`);
                const summary = await summaryRes.json();

                displaySummary(summary);
                displayAssets(assets);
            } catch (error) {
                console.error('Failed to load assets:', error);
            }
        }

        function displaySummary(summary) {
            const container = document.getElementById('summaryCards');
            const classes = ['equity', 'debt', 'commodity', 'cash', 'others'];
            const icons = {
                equity: 'bi-graph-up-arrow',
                debt: 'bi-bank',
                commodity: 'bi-gem',
                cash: 'bi-cash-stack',
                others: 'bi-box'
            };

            let html = `
                <div class="col-md-4 mb-3">
                    <div class="card h-100">
                        <div class="card-body text-center">
                            <h6 class="text-muted">Total Manual Assets</h6>
                            <h3 class="text-success">${formatCurrency(summary.total_value)}</h3>
                        </div>
                    </div>
                </div>
            `;

            for (const cls of classes) {
                const data = summary.by_asset_class[cls];
                if (data.count > 0) {
                    html += `
                        <div class="col-md-4 mb-3">
                            <div class="card summary-card ${cls} h-100">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="text-muted text-capitalize">${cls}</h6>
                                            <h5>${formatCurrency(data.value)}</h5>
                                            <small class="text-muted">${data.count} asset(s)</small>
                                        </div>
                                        <i class="bi ${icons[cls]} text-muted" style="font-size: 2rem;"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }

            container.innerHTML = html;
        }

        function displayAssets(assets) {
            const container = document.getElementById('assetsList');
            const emptyState = document.getElementById('emptyState');

            if (assets.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';

            container.innerHTML = assets.map(asset => {
                const value = asset.calculated_value || 0;
                const iconClass = asset.asset_type || 'other';
                const typeIcon = getTypeIcon(asset.asset_type);

                return `
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card asset-card h-100" onclick="showAssetDetail(${asset.id})" style="cursor: pointer;">
                            <div class="card-body">
                                <div class="d-flex align-items-start mb-3">
                                    <div class="asset-icon ${iconClass} me-3">
                                        <i class="bi ${typeIcon}"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">${asset.name}</h6>
                                        <span class="badge bg-secondary class-badge text-uppercase">${asset.asset_class}</span>
                                        <span class="badge bg-light text-dark class-badge text-uppercase ms-1">${asset.asset_type}</span>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between align-items-end">
                                    <div>
                                        <small class="text-muted">Current Value</small>
                                        <h5 class="mb-0 value-positive">${formatCurrency(value)}</h5>
                                    </div>
                                    ${renderAssetExtra(asset)}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getTypeIcon(type) {
            const icons = {
                fd: 'bi-bank',
                sgb: 'bi-gem',
                stock: 'bi-graph-up-arrow',
                ppf: 'bi-piggy-bank',
                nps: 'bi-shield-check',
                other: 'bi-box'
            };
            return icons[type] || 'bi-box';
        }

        function renderAssetExtra(asset) {
            if (asset.asset_type === 'fd' && asset.fd_details) {
                return `
                    <div class="text-end">
                        <small class="text-muted">Progress</small>
                        <div class="progress" style="width: 80px; height: 6px;">
                            <div class="progress-bar progress-bar-fd" style="width: ${asset.fd_details.progress_pct}%"></div>
                        </div>
                        <small class="text-muted">${asset.fd_details.progress_pct}%</small>
                    </div>
                `;
            }
            if (asset.asset_type === 'sgb' && asset.sgb_details) {
                const gain = asset.sgb_details.appreciation_pct;
                const gainClass = gain >= 0 ? 'value-positive' : 'value-negative';
                return `
                    <div class="text-end">
                        <small class="text-muted">Gold Gain</small>
                        <div class="${gainClass}">${gain >= 0 ? '+' : ''}${gain.toFixed(1)}%</div>
                    </div>
                `;
            }
            if (asset.asset_type === 'stock' && asset.stock_details) {
                const gain = asset.stock_details.gain_loss_pct;
                const gainClass = gain >= 0 ? 'value-positive' : 'value-negative';
                return `
                    <div class="text-end">
                        <small class="text-muted">P&L</small>
                        <div class="${gainClass}">${gain >= 0 ? '+' : ''}${gain.toFixed(1)}%</div>
                    </div>
                `;
            }
            return '';
        }

        async function showAssetDetail(assetId) {
            try {
                const res = await fetch(`/api/manual-assets/${assetId}`);
                currentAsset = await res.json();

                document.getElementById('detailModalTitle').textContent = currentAsset.name;

                let html = `
                    <div class="row mb-3">
                        <div class="col-6">
                            <strong>Type:</strong> ${currentAsset.asset_type.toUpperCase()}
                        </div>
                        <div class="col-6">
                            <strong>Class:</strong> ${currentAsset.asset_class.toUpperCase()}
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-6">
                            <strong>Purchase Date:</strong> ${currentAsset.purchase_date || '-'}
                        </div>
                        <div class="col-6">
                            <strong>Purchase Value:</strong> ${formatCurrency(currentAsset.purchase_value || 0)}
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-12">
                            <strong>Current Value:</strong>
                            <span class="h4 text-success ms-2">${formatCurrency(currentAsset.calculated_value || 0)}</span>
                        </div>
                    </div>
                `;

                // Type-specific details
                if (currentAsset.asset_type === 'fd' && currentAsset.fd_details) {
                    const fd = currentAsset.fd_details;
                    html += `
                        <hr>
                        <h6><i class="bi bi-bank"></i> FD Details</h6>
                        <div class="row">
                            <div class="col-md-4 mb-2">
                                <small class="text-muted">Principal</small><br>
                                <strong>${formatCurrency(fd.principal)}</strong>
                            </div>
                            <div class="col-md-4 mb-2">
                                <small class="text-muted">Interest Earned</small><br>
                                <strong class="text-success">${formatCurrency(fd.interest_earned)}</strong>
                            </div>
                            <div class="col-md-4 mb-2">
                                <small class="text-muted">Maturity Value</small><br>
                                <strong>${formatCurrency(fd.maturity_value)}</strong>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-6 mb-2">
                                <small class="text-muted">Maturity Date</small><br>
                                <strong>${fd.maturity_date}</strong>
                            </div>
                            <div class="col-md-6 mb-2">
                                <small class="text-muted">Progress</small><br>
                                <div class="progress" style="height: 10px;">
                                    <div class="progress-bar progress-bar-fd" style="width: ${fd.progress_pct}%"></div>
                                </div>
                                <small>${fd.days_completed} / ${fd.total_days} days (${fd.progress_pct}%)</small>
                            </div>
                        </div>
                    `;

                    if (currentAsset.premature_details) {
                        const pm = currentAsset.premature_details;
                        html += `
                            <div class="alert alert-warning mt-3">
                                <strong><i class="bi bi-exclamation-triangle"></i> If broken today:</strong><br>
                                Value: <strong>${formatCurrency(pm.premature_value)}</strong>
                                (Penalty: ${formatCurrency(pm.penalty_amount)} at ${pm.effective_rate}% effective rate)
                            </div>
                        `;
                    }
                }

                if (currentAsset.asset_type === 'sgb' && currentAsset.sgb_details) {
                    const sgb = currentAsset.sgb_details;
                    html += `
                        <hr>
                        <h6><i class="bi bi-gem"></i> SGB Details</h6>
                        <div class="row">
                            <div class="col-md-4 mb-2">
                                <small class="text-muted">Grams</small><br>
                                <strong>${sgb.grams}g</strong>
                            </div>
                            <div class="col-md-4 mb-2">
                                <small class="text-muted">Issue Price</small><br>
                                <strong>${formatCurrency(sgb.issue_price)}/g</strong>
                            </div>
                            <div class="col-md-4 mb-2">
                                <small class="text-muted">Current Price</small><br>
                                <strong>${formatCurrency(sgb.current_gold_price)}/g</strong>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-4 mb-2">
                                <small class="text-muted">Gold Value</small><br>
                                <strong>${formatCurrency(sgb.gold_value)}</strong>
                            </div>
                            <div class="col-md-4 mb-2">
                                <small class="text-muted">Interest Earned</small><br>
                                <strong class="text-success">${formatCurrency(sgb.interest_earned)}</strong>
                            </div>
                            <div class="col-md-4 mb-2">
                                <small class="text-muted">Gold Appreciation</small><br>
                                <strong class="${sgb.appreciation >= 0 ? 'text-success' : 'text-danger'}">
                                    ${formatCurrency(sgb.appreciation)} (${sgb.appreciation_pct}%)
                                </strong>
                            </div>
                        </div>
                    `;
                }

                if (currentAsset.asset_type === 'stock' && currentAsset.stock_details) {
                    const stk = currentAsset.stock_details;
                    html += `
                        <hr>
                        <h6><i class="bi bi-graph-up-arrow"></i> Stock Details</h6>
                        <div class="row">
                            <div class="col-md-4 mb-2">
                                <small class="text-muted">Quantity</small><br>
                                <strong>${stk.quantity}</strong>
                            </div>
                            <div class="col-md-4 mb-2">
                                <small class="text-muted">Avg Price</small><br>
                                <strong>${formatCurrency(stk.avg_price)}</strong>
                            </div>
                            <div class="col-md-4 mb-2">
                                <small class="text-muted">Current Price</small><br>
                                <strong>${formatCurrency(stk.current_price)}</strong>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-6 mb-2">
                                <small class="text-muted">Invested</small><br>
                                <strong>${formatCurrency(stk.invested_value)}</strong>
                            </div>
                            <div class="col-md-6 mb-2">
                                <small class="text-muted">P&L</small><br>
                                <strong class="${stk.gain_loss >= 0 ? 'text-success' : 'text-danger'}">
                                    ${formatCurrency(stk.gain_loss)} (${stk.gain_loss_pct.toFixed(2)}%)
                                </strong>
                            </div>
                        </div>
                    `;
                }

                document.getElementById('detailModalBody').innerHTML = html;

                document.getElementById('deleteAssetBtn').onclick = () => deleteAsset(assetId);
                document.getElementById('editAssetBtn').onclick = () => {
                    detailModal.hide();
                    openEditAssetModal(currentAsset);
                };

                detailModal.show();
            } catch (error) {
                console.error('Failed to load asset:', error);
            }
        }

        function openAddAssetModal() {
            document.getElementById('assetModalTitle').innerHTML = '<i class="bi bi-plus-circle"></i> Add New Asset';
            document.getElementById('assetForm').reset();
            document.getElementById('assetId').value = '';
            document.getElementById('assetType').value = 'fd';
            document.getElementById('assetClass').value = 'debt';
            showAssetTypeFields();
            assetModal.show();
        }

        function openEditAssetModal(asset) {
            document.getElementById('assetModalTitle').innerHTML = '<i class="bi bi-pencil"></i> Edit Asset';
            document.getElementById('assetId').value = asset.id;
            document.getElementById('assetType').value = asset.asset_type;
            document.getElementById('assetClass').value = asset.asset_class;
            document.getElementById('assetName').value = asset.name;
            document.getElementById('assetDescription').value = asset.description || '';
            document.getElementById('purchaseDate').value = asset.purchase_date || '';
            document.getElementById('purchaseValue').value = asset.purchase_value || '';

            // Set type-specific fields
            if (asset.asset_type === 'fd') {
                document.getElementById('fdPrincipal').value = asset.fd_principal || '';
                document.getElementById('fdInterestRate').value = asset.fd_interest_rate || '';
                document.getElementById('fdTenureMonths').value = asset.fd_tenure_months || '';
                document.getElementById('fdCompounding').value = asset.fd_compounding || 'quarterly';
                document.getElementById('fdPenalty').value = asset.fd_premature_penalty_pct || 1.0;
                document.getElementById('fdBankName').value = asset.fd_bank_name || '';
            } else if (asset.asset_type === 'sgb') {
                document.getElementById('sgbIssuePrice').value = asset.sgb_issue_price || '';
                document.getElementById('sgbGrams').value = asset.sgb_grams || '';
                document.getElementById('sgbInterestRate').value = asset.sgb_interest_rate || 2.5;
                document.getElementById('sgbCurrentPrice').value = asset.current_nav || '';
                document.getElementById('sgbMaturityDate').value = asset.sgb_maturity_date || '';
            } else if (asset.asset_type === 'stock') {
                document.getElementById('stockSymbol').value = asset.stock_symbol || '';
                document.getElementById('stockExchange').value = asset.stock_exchange || 'NSE';
                document.getElementById('stockQuantity').value = asset.stock_quantity || '';
                document.getElementById('stockAvgPrice').value = asset.stock_avg_price || '';
                document.getElementById('stockCurrentPrice').value = asset.current_nav || '';
            } else if (asset.asset_type === 'ppf' || asset.asset_type === 'nps') {
                document.getElementById('ppfAccountNumber').value = asset.ppf_account_number || '';
                document.getElementById('ppfMaturityDate').value = asset.ppf_maturity_date || '';
                document.getElementById('ppfCurrentValue').value = asset.current_value || '';
            } else {
                document.getElementById('otherUnits').value = asset.units || 1;
                document.getElementById('otherCurrentNav').value = asset.current_nav || '';
                document.getElementById('otherCurrentValue').value = asset.current_value || '';
            }

            showAssetTypeFields();
            assetModal.show();
        }

        function showAssetTypeFields() {
            const type = document.getElementById('assetType').value;

            // Hide all type-specific fields
            document.querySelectorAll('.asset-type-fields').forEach(el => el.style.display = 'none');

            // Show relevant fields and set default asset class
            switch (type) {
                case 'fd':
                    document.getElementById('fdFields').style.display = 'block';
                    document.getElementById('assetClass').value = 'debt';
                    break;
                case 'sgb':
                    document.getElementById('sgbFields').style.display = 'block';
                    document.getElementById('assetClass').value = 'commodity';
                    break;
                case 'stock':
                    document.getElementById('stockFields').style.display = 'block';
                    document.getElementById('assetClass').value = 'equity';
                    break;
                case 'ppf':
                case 'nps':
                    document.getElementById('ppfFields').style.display = 'block';
                    document.getElementById('assetClass').value = 'debt';
                    break;
                case 'other':
                    document.getElementById('otherFields').style.display = 'block';
                    break;
            }
        }

        async function calculateFD() {
            const principal = parseFloat(document.getElementById('fdPrincipal').value);
            const rate = parseFloat(document.getElementById('fdInterestRate').value);
            const tenure = parseInt(document.getElementById('fdTenureMonths').value);
            const startDate = document.getElementById('purchaseDate').value;
            const compounding = document.getElementById('fdCompounding').value;
            const penalty = parseFloat(document.getElementById('fdPenalty').value) || 1.0;

            if (!principal || !rate || !tenure || !startDate) {
                alert('Please fill in Principal, Interest Rate, Tenure, and Start Date');
                return;
            }

            try {
                const res = await fetch('/api/manual-assets/calculate/fd', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        principal, interest_rate: rate, tenure_months: tenure,
                        start_date: startDate, compounding, premature_penalty_pct: penalty
                    })
                });
                const data = await res.json();

                let html = `
                    <strong>Current Value:</strong> ${formatCurrency(data.current_value)}<br>
                    <strong>Interest Earned:</strong> ${formatCurrency(data.interest_earned)}<br>
                    <strong>Maturity Value:</strong> ${formatCurrency(data.maturity_value)}<br>
                    <strong>Maturity Date:</strong> ${data.maturity_date}<br>
                    <strong>Progress:</strong> ${data.progress_pct}% (${data.days_completed}/${data.total_days} days)
                `;

                if (data.premature) {
                    html += `<br><br><strong>If Broken Today:</strong><br>
                        Value: ${formatCurrency(data.premature.premature_value)}
                        (Penalty: ${formatCurrency(data.premature.penalty_amount)})`;
                }

                document.getElementById('fdCalculation').innerHTML = html;
                document.getElementById('fdCalculation').style.display = 'block';
            } catch (error) {
                alert('Calculation failed: ' + error.message);
            }
        }

        async function calculateSGB() {
            const issuePrice = parseFloat(document.getElementById('sgbIssuePrice').value);
            const grams = parseFloat(document.getElementById('sgbGrams').value);
            const purchaseDate = document.getElementById('purchaseDate').value;
            const rate = parseFloat(document.getElementById('sgbInterestRate').value) || 2.5;
            const currentPrice = parseFloat(document.getElementById('sgbCurrentPrice').value) || null;

            if (!issuePrice || !grams || !purchaseDate) {
                alert('Please fill in Issue Price, Grams, and Purchase Date');
                return;
            }

            try {
                const res = await fetch('/api/manual-assets/calculate/sgb', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        issue_price: issuePrice, grams, interest_rate: rate,
                        purchase_date: purchaseDate, current_gold_price: currentPrice
                    })
                });
                const data = await res.json();

                const html = `
                    <strong>Current Value:</strong> ${formatCurrency(data.current_value)}<br>
                    <strong>Gold Value:</strong> ${formatCurrency(data.gold_value)}<br>
                    <strong>Appreciation:</strong> ${formatCurrency(data.appreciation)} (${data.appreciation_pct}%)<br>
                    <strong>Interest Earned:</strong> ${formatCurrency(data.interest_earned)}<br>
                    <strong>Years Held:</strong> ${data.years_held}
                `;

                document.getElementById('sgbCalculation').innerHTML = html;
                document.getElementById('sgbCalculation').style.display = 'block';
            } catch (error) {
                alert('Calculation failed: ' + error.message);
            }
        }

        async function saveAsset() {
            const assetId = document.getElementById('assetId').value;
            const assetType = document.getElementById('assetType').value;

            const data = {
                investor_id: investorId,
                asset_type: assetType,
                asset_class: document.getElementById('assetClass').value,
                name: document.getElementById('assetName').value,
                description: document.getElementById('assetDescription').value || null,
                purchase_date: document.getElementById('purchaseDate').value || null,
                purchase_value: parseFloat(document.getElementById('purchaseValue').value) || null
            };

            // Add type-specific fields
            if (assetType === 'fd') {
                data.fd_principal = parseFloat(document.getElementById('fdPrincipal').value) || null;
                data.fd_interest_rate = parseFloat(document.getElementById('fdInterestRate').value) || null;
                data.fd_tenure_months = parseInt(document.getElementById('fdTenureMonths').value) || null;
                data.fd_compounding = document.getElementById('fdCompounding').value;
                data.fd_premature_penalty_pct = parseFloat(document.getElementById('fdPenalty').value) || 1.0;
                data.fd_bank_name = document.getElementById('fdBankName').value || null;
            } else if (assetType === 'sgb') {
                data.sgb_issue_price = parseFloat(document.getElementById('sgbIssuePrice').value) || null;
                data.sgb_grams = parseFloat(document.getElementById('sgbGrams').value) || null;
                data.sgb_interest_rate = parseFloat(document.getElementById('sgbInterestRate').value) || 2.5;
                data.sgb_maturity_date = document.getElementById('sgbMaturityDate').value || null;
                data.current_nav = parseFloat(document.getElementById('sgbCurrentPrice').value) || null;
            } else if (assetType === 'stock') {
                data.stock_symbol = document.getElementById('stockSymbol').value || null;
                data.stock_exchange = document.getElementById('stockExchange').value;
                data.stock_quantity = parseFloat(document.getElementById('stockQuantity').value) || null;
                data.stock_avg_price = parseFloat(document.getElementById('stockAvgPrice').value) || null;
                data.current_nav = parseFloat(document.getElementById('stockCurrentPrice').value) || null;
            } else if (assetType === 'ppf' || assetType === 'nps') {
                data.ppf_account_number = document.getElementById('ppfAccountNumber').value || null;
                data.ppf_maturity_date = document.getElementById('ppfMaturityDate').value || null;
                data.current_value = parseFloat(document.getElementById('ppfCurrentValue').value) || null;
            } else {
                data.units = parseFloat(document.getElementById('otherUnits').value) || 1;
                data.current_nav = parseFloat(document.getElementById('otherCurrentNav').value) || null;
                data.current_value = parseFloat(document.getElementById('otherCurrentValue').value) || null;
            }

            try {
                let res;
                if (assetId) {
                    res = await fetch(`/api/manual-assets/${assetId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                } else {
                    res = await fetch('/api/manual-assets', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                }

                const result = await res.json();
                if (result.success || result.id) {
                    assetModal.hide();
                    loadAssets();
                } else {
                    alert('Error: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Failed to save asset: ' + error.message);
            }
        }

        async function deleteAsset(assetId) {
            if (!confirm('Are you sure you want to delete this asset?')) return;

            try {
                const res = await fetch(`/api/manual-assets/${assetId}`, { method: 'DELETE' });
                const result = await res.json();
                if (result.success) {
                    detailModal.hide();
                    loadAssets();
                } else {
                    alert('Error: ' + (result.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Failed to delete asset: ' + error.message);
            }
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR',
                maximumFractionDigits: 0
            }).format(value || 0);
        }
    </script>
    {% include '_feature_request_widget.html' %}
<script>
// Auth: redirect to login on 401
const _origFetch = window.fetch;
window.fetch = function() {
    return _origFetch.apply(this, arguments).then(resp => {
        if (resp.status === 401) window.location.href = '/login';
        return resp;
    });
};
</script>
</body>
</html>
